// pages/index.tsx

import { useState, useEffect } from 'react';
import TopNavigation from '../components/TopNavigation';
import { extractFullText, generateAccurateAnalysis } from '@/lib/fullTextExtractor';
import { callLLM } from '@/lib/ai';
import { 
  ALL_ACADEMIC_DATABASES, 
  getDatabasesByCategory,
  getDatabaseStats,
  type AcademicDatabase
} from '@/lib/academicDatabases';

// å®šç¾©é¡å‹æ¥å£
interface Reference {
  id: string;
  title: string;
  authors: string;
  source: string;
  year: number;
  summary: string;
  keySentences: string[];
  citation: string;
  database?: string; // æ–°å¢ï¼šæ¨™æ³¨æ•¸æ“šåº«ä¾†æº
  url?: string; // æ–°å¢ï¼šæ–‡ç»éˆæ¥
  deepAnalysis?: { // æ–°å¢ï¼šæ·±åº¦åˆ†æçµæœ
    chineseExplanation: string;
    englishSentences: Array<{english: string, chinese: string}>;
    source: 'pdf' | 'html' | 'api' | 'unavailable' | 'PAGE_EXTRACT';
    analyzedAt: string;
    metadata?: { // æ–°å¢ï¼šå…ƒæ•°æ®ä¿¡æ¯
      verified: boolean;
      has_abstract: boolean;
      abstract_length: number;
      body_length: number;
      summary_mode: 'AI_from_abstract' | 'AI_from_metadata_only';
      abstract_source?: string;
    };
  };
}

interface OutlinePoint {
  id: number;
  title: string;
  content: string;
  bulletPoints: string[];
  references: Reference[];
  wordCount: number;
}

export default function HomePage() {
  const [form, setForm] = useState({
    title: "",
    introWords: 140, // æ–°å¢ç‹€æ…‹ä¾†æ§åˆ¶å¼•è¨€å­—æ•¸
    bodyCount: 3, // æ–°å¢ç‹€æ…‹ä¾†æ§åˆ¶ä¸»é«”æ®µè½æ•¸é‡
    bodyWords: [240, 240, 240], // æ–°å¢ç‹€æ…‹ä¾†æ§åˆ¶æ¯æ®µä¸»é«”çš„å­—æ•¸
    bodyContent: ['', '', ''], // æ–°å¢ç‹€æ…‹ä¾†æ§åˆ¶æ¯æ®µä¸»é«”çš„å…§å®¹æè¿°
    conclusionWords: 140, // æ–°å¢ç‹€æ…‹ä¾†æ§åˆ¶çµè«–å­—æ•¸
    totalWords: 1000, // æ–°å¢ç‹€æ…‹ä¾†æ§åˆ¶ç¸½å­—æ•¸
    rubric: "",
    language: "ä¸­æ–‡",
    tone: "æ­£å¼",
    detail: "",
    plannerExpanded: false, // æ–°å¢ç‹€æ…‹ä¾†æ§åˆ¶æ®µè½è¦åŠƒå™¨æ˜¯å¦å±•é–‹
    settingsExpanded: true, // æ–°å¢ç‹€æ…‹ä¾†æ§åˆ¶åŠŸèª²è¨­å®šæ˜¯å¦å±•é–‹
    referenceSettingsExpanded: false, // æ–°å¢ç‹€æ…‹ä¾†æ§åˆ¶å‚è€ƒæ–‡çŒ®è®¾ç½®æ˜¯å¦å±•é–‹
    
    // å‚è€ƒæ–‡çŒ®è®¾ç½®
    referenceSettings: {
      documentTypes: ["journal", "book", "conference"],
      citationFormat: "apa7",
      region: "global",
      language: "en",
      yearRange: {
        from: 2010,
        to: new Date().getFullYear(),
      },
      sources: ["googlescholar", "semanticscholar", "crossref"],
      excludeLoginRequiredPublishers: true, // æ–°å¢ï¼šè‡ªåŠ¨æ’é™¤éœ€ç™»å½•çš„å‡ºç‰ˆå•†
    },
  });

  const [activeTab, setActiveTab] = useState<'outline' | 'draft' | 'review' | 'revision' | 'final'>('outline');
  const [mode, setMode] = useState('edit');
  const [lockedTabs, setLockedTabs] = useState({
    outline: false,
    draft: false,
    review: false,
    revision: false,
    final: false
  });

  const [isGenerating, setIsGenerating] = useState(false);
  const [generatedContent, setGeneratedContent] = useState('');
  const [draftSections, setDraftSections] = useState<{[key: number]: string}>({});
  const [currentGeneratingSection, setCurrentGeneratingSection] = useState<number | null>(null);
  const [selectedModel, setSelectedModel] = useState('gpt-4o');
  
  // æ–°å¢ï¼šå¤§ç¶±é»çµæ§‹
  const [outlinePoints, setOutlinePoints] = useState<OutlinePoint[]>([]);

  // æ–°å¢ï¼šæœå°‹é—œéµå­—ï¼ˆæ¯å€‹å¤§ç¶±é»ç¨ç«‹ï¼‰
  const [searchKeywords, setSearchKeywords] = useState<{[key: string]: string}>({});
  const [selectedBulletPoint, setSelectedBulletPoint] = useState<string | null>(null);
  const [isSearching, setIsSearching] = useState(false);
  const [analyzingReferences, setAnalyzingReferences] = useState<Set<string>>(new Set());
  const [searchResults, setSearchResults] = useState<Reference[]>([]);
  const [selectedReferences, setSelectedReferences] = useState<Reference[]>([]);

  const toggleLock = (tabName: 'outline' | 'draft' | 'review' | 'revision' | 'final') => {
    setLockedTabs(prev => ({
      ...prev,
      [tabName]: !prev[tabName]
    }));
  };

  const isCurrentTabLocked = lockedTabs[activeTab];

  // ä¿å­˜å‚è€ƒæ–‡çŒ®è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
  const saveReferenceSettings = (settings: any) => {
    try {
      localStorage.setItem('referenceSettings', JSON.stringify(settings));
      console.log('å‚è€ƒæ–‡çŒ®è®¾ç½®å·²ä¿å­˜:', settings);
    } catch (error) {
      console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
    }
  };

  // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å‚è€ƒæ–‡çŒ®è®¾ç½®
  const loadReferenceSettings = () => {
    try {
      const saved = localStorage.getItem('referenceSettings');
      if (saved) {
        const settings = JSON.parse(saved);
        console.log('åŠ è½½ä¿å­˜çš„è®¾ç½®:', settings);
        return settings;
      }
    } catch (error) {
      console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
    }
    return null;
  };

  // ç»„ä»¶åŠ è½½æ—¶æ¢å¤è®¾ç½®
  useEffect(() => {
    const savedSettings = loadReferenceSettings();
    if (savedSettings) {
      setForm(prev => ({
        ...prev,
        referenceSettings: savedSettings
      }));
    }
  }, []);

  // æ›´æ–°å‚è€ƒæ–‡çŒ®è®¾ç½®
  const updateReferenceSettings = (newSettings: any) => {
    setForm(prev => ({
      ...prev,
      referenceSettings: { ...prev.referenceSettings, ...newSettings }
    }));
    saveReferenceSettings({ ...form.referenceSettings, ...newSettings });
  };

  // ç”Ÿæˆç”¨æˆ¶å€‹æ€§åŒ–ä¸Šä¸‹æ–‡
  const generateUserContext = () => {
    const timestamp = Date.now();
    const sessionId = Math.random().toString(36).substring(2, 15);
    const userAgent = navigator.userAgent;
    const timeOfDay = new Date().getHours();
    const dayOfWeek = new Date().getDay();
    
    return {
      timestamp,
      sessionId,
      userAgent: userAgent.substring(0, 50), // é™åˆ¶é•¿åº¦
      timeOfDay,
      dayOfWeek,
      randomSeed: Math.random().toString(36).substring(2, 10)
    };
  };

  // ç”Ÿæˆå€‹æ€§åŒ–å¤§ç¶±
  const generatePersonalizedOutline = (keywords: string, enhancedKeyword: string, userContext: any, pointId: number) => {
    const timeVariations = ['æ—©æœŸ', 'ä¸­æœŸ', 'è¿‘æœŸ', 'å½“ä»£', 'ç°ä»£', 'æœ€æ–°', 'å‰æ²¿', 'æ–°å…´'];
    const approachVariations = ['ç†è®º', 'å®è·µ', 'å®è¯', 'æ¯”è¾ƒ', 'æ¡ˆä¾‹', 'å®éªŒ', 'ä»¿çœŸ', 'æ¨¡æ‹Ÿ'];
    const perspectiveVariations = ['æŠ€æœ¯', 'åº”ç”¨', 'å‘å±•', 'æŒ‘æˆ˜', 'æœºé‡', 'å½±å“', 'ä»·å€¼', 'è¶‹åŠ¿'];
    
    const timeVar = timeVariations[userContext.timeOfDay % timeVariations.length];
    const approachVar = approachVariations[userContext.dayOfWeek % approachVariations.length];
    const perspectiveVar = perspectiveVariations[pointId % perspectiveVariations.length];
    
    return `ä¸€ã€${timeVar}${keywords}çš„${approachVar}ç ”ç©¶
${enhancedKeyword}åœ¨${perspectiveVar}å±‚é¢çš„é‡è¦å‘ç°å’Œåˆ›æ–°

äºŒã€${keywords}çš„${approachVar}åº”ç”¨
${enhancedKeyword}åœ¨å®é™…åœºæ™¯ä¸­çš„è¡¨ç°å’Œæ•ˆæœåˆ†æ

ä¸‰ã€${keywords}çš„æœªæ¥${perspectiveVar}
${enhancedKeyword}çš„å‘å±•æ–¹å‘å’Œæ½œåœ¨çªç ´`;
  };

  // æ–°å¢ï¼šè‰ç¨¿ç”ŸæˆåŠŸèƒ½
  const handleGenerateDraft = async (type: 'full' | 'section', sectionId?: number) => {
    if (!form.title.trim()) {
      alert('è«‹å…ˆè¼¸å…¥è«–æ–‡æ¨™é¡Œ');
      return;
    }

    if (outlinePoints.length === 0) {
      alert('è«‹å…ˆå‰µå»ºå¤§ç¶±çµæ§‹');
      return;
    }

    // æ£€æŸ¥å‚è€ƒæ–‡çŒ®
    const allReferences = outlinePoints.flatMap(point => point.references);
    if (allReferences.length === 0) {
      const confirmGenerate = confirm('âš ï¸ è­¦å‘Šï¼šæ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•å‚è€ƒæ–‡çŒ®ã€‚\n\nå»ºè®®å…ˆæ·»åŠ å‚è€ƒæ–‡çŒ®ä»¥è·å¾—æ›´å¥½çš„ç”Ÿæˆæ•ˆæœã€‚\n\næ˜¯å¦ä»è¦ç»§ç»­ç”Ÿæˆï¼Ÿ');
      if (!confirmGenerate) {
        return;
      }
    }

    // æ£€æŸ¥å­—æ•°è®¾ç½®
    if (form.totalWords < 500) {
      const confirmWordCount = confirm(`âš ï¸ å­—æ•°è®¾ç½®è¾ƒä½ï¼ˆ${form.totalWords}å­—ï¼‰ã€‚\n\nå»ºè®®è‡³å°‘è®¾ç½®500å­—ä»¥è·å¾—æ›´å¥½çš„å†…å®¹è´¨é‡ã€‚\n\næ˜¯å¦ä»è¦ç»§ç»­ï¼Ÿ`);
      if (!confirmWordCount) {
        return;
      }
    }

    setIsGenerating(true);
    if (sectionId) {
      setCurrentGeneratingSection(sectionId);
    }

    try {
      // æ„å»ºå¤§çº²æ–‡æœ¬
      const outlineText = outlinePoints.map(point => 
        `${point.id}. ${point.title}\n${point.content}\n${point.bulletPoints && point.bulletPoints.length > 0 ? point.bulletPoints.map(detail => `â€¢ ${detail}`).join('\n') : ''}`
      ).join('\n\n');

      // æ”¶é›†æ‰€æœ‰å‚è€ƒæ–‡çŒ®
      const referenceText = allReferences.length > 0 
        ? allReferences.map((ref, index) => {
            const year = ref.year || new Date().getFullYear();
            return `${index + 1}. ${ref.authors} (${year}). ${ref.title}. ${ref.source}`;
          }).join('\n')
        : '';

      let prompt = '';
      let wordCount = form.totalWords || 1000;
      
      // ç¡®ä¿å­—æ•°è®¾ç½®æ­£ç¡®
      console.log('è®¾ç½®çš„å­—æ•°:', wordCount);
      console.log('form.totalWords:', form.totalWords);

      if (type === 'full') {
        // ç”Ÿæˆå®Œæ•´è‰ç¨¿
        prompt = `è«‹æ ¹æ“šä»¥ä¸‹å¤§ç¶±å’Œåƒè€ƒæ–‡ç»æ’°å¯«ä¸€ç¯‡ç´„${wordCount}å­—çš„å®Œæ•´æ–‡ç« ï¼š
é¡Œç›®ï¼š${form.title}
èªè¨€ï¼š${form.language}
èªæ°£ï¼š${form.tone}

ã€æ®µè½å¤§ç¶±ã€‘
${outlineText}

${referenceText ? `ã€åƒè€ƒæ–‡ç»ã€‘
${referenceText}

è«‹åœ¨æ–‡ç« ä¸­é©ç•¶å¼•ç”¨ä¸Šè¿°åƒè€ƒæ–‡ç»ï¼Œä½¿ç”¨APA7æ ¼å¼ï¼ˆä¾‹å¦‚ï¼šä½œè€…ï¼Œå¹´ä»½ï¼‰ã€‚` : ''}

å¯«ä½œè¦æ±‚ï¼š
- çµæ§‹æ¸…æ™°ï¼ŒåŒ…å«å¼•è¨€ã€ä¸»é«”æ®µè½ã€çµè«–
- å…§å®¹è¦æœ‰é‚è¼¯æ€§å’Œé€£è²«æ€§
- ä½¿ç”¨æ­£å¼çš„å­¸è¡“å¯«ä½œèªæ°£
- æ¯æ®µç´„200-300å­—
- ä¸è¦ä½¿ç”¨æ¢åˆ—ç¬¦è™Ÿï¼Œä»¥æ®µè½å½¢å¼å‘ˆç¾
- ${referenceText ? 'é©ç•¶å¼•ç”¨æä¾›çš„åƒè€ƒæ–‡ç»ï¼Œç¢ºä¿å­¸è¡“å¯ä¿¡åº¦' : 'ç¢ºä¿å…§å®¹çš„å­¸è¡“æ€§å’Œå¯ä¿¡åº¦'}

è«‹è¼¸å‡ºå®Œæ•´çš„æ–‡ç« è‰ç¨¿ã€‚`;
      } else if (type === 'section' && sectionId) {
        // ç”Ÿæˆç‰¹å®šæ®µè½
        const section = outlinePoints.find(p => p.id === sectionId);
        if (!section) {
          alert('æ‰¾ä¸åˆ°æŒ‡å®šçš„æ®µè½');
          return;
        }

        const sectionWordCount = Math.ceil(wordCount / outlinePoints.length);
        
        // è·å–è¯¥æ®µè½çš„å‚è€ƒæ–‡çŒ®
        const sectionReferences = section.references;
        const sectionReferenceText = sectionReferences.length > 0 
          ? sectionReferences.map((ref, index) => {
              const year = ref.year || new Date().getFullYear();
              return `${index + 1}. ${ref.authors} (${year}). ${ref.title}. ${ref.source}`;
            }).join('\n')
          : '';
        
        prompt = `è«‹æ ¹æ“šä»¥ä¸‹å¤§ç¶±å’Œåƒè€ƒæ–‡ç»æ’°å¯«ç¬¬${sectionId}æ®µçš„å…§å®¹ï¼ˆç´„${sectionWordCount}å­—ï¼‰ï¼š

é¡Œç›®ï¼š${form.title}
æ®µè½æ¨™é¡Œï¼š${section.title}
æ®µè½å…§å®¹ï¼š${section.content}

è©³ç´°è¦é»ï¼š
${section.bulletPoints && section.bulletPoints.length > 0 ? section.bulletPoints.map(detail => `â€¢ ${detail}`).join('\n') : 'æš‚æ— è¯¦ç»†è¦ç‚¹'}

${sectionReferenceText ? `ã€ç›¸é—œåƒè€ƒæ–‡ç»ã€‘
${sectionReferenceText}

è«‹åœ¨æ®µè½ä¸­é©ç•¶å¼•ç”¨ä¸Šè¿°åƒè€ƒæ–‡ç»ï¼Œä½¿ç”¨APA7æ ¼å¼ï¼ˆä¾‹å¦‚ï¼šä½œè€…ï¼Œå¹´ä»½ï¼‰ã€‚` : ''}

å¯«ä½œè¦æ±‚ï¼š
- å…§å®¹è¦æœ‰é‚è¼¯æ€§å’Œé€£è²«æ€§
- ä½¿ç”¨æ­£å¼çš„å­¸è¡“å¯«ä½œèªæ°£
- ä»¥æ®µè½å½¢å¼å‘ˆç¾ï¼Œä¸è¦ä½¿ç”¨æ¢åˆ—ç¬¦è™Ÿ
- ç¢ºä¿å…§å®¹èˆ‡è«–æ–‡ä¸»é¡Œç›¸é—œ
- ${sectionReferenceText ? 'é©ç•¶å¼•ç”¨æä¾›çš„åƒè€ƒæ–‡ç»ï¼Œå¢å¼·æ®µè½å¯ä¿¡åº¦' : 'ç¢ºä¿å…§å®¹çš„å­¸è¡“æ€§'}

è«‹åªè¼¸å‡ºé€™ä¸€æ®µçš„å…§å®¹ã€‚`;
      }

      // æ ¹æ®ç”Ÿæˆç±»å‹ç¡®å®šå‘é€ç»™APIçš„å¤§çº²å†…å®¹
      const apiOutline = type === 'full' 
        ? outlineText 
        : (() => {
            const section = outlinePoints.find(p => p.id === sectionId);
            return section ? `${sectionId}. ${section.title}\n${section.content}\n${section.bulletPoints && section.bulletPoints.length > 0 ? section.bulletPoints.map(detail => `â€¢ ${detail}`).join('\n') : ''}` : '';
          })();

      const response = await fetch('/api/draft', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: form.title,
          wordCount: type === 'full' ? wordCount : Math.ceil(wordCount / outlinePoints.length),
          language: form.language,
          tone: form.tone,
          detail: form.detail,
          reference: form.reference,
          rubric: form.rubric,
          outline: apiOutline,
          sectionId: type === 'section' ? sectionId : undefined, // æ·»åŠ sectionIdå‚æ•°
          mode: selectedModel // ä½¿ç”¨é€‰æ‹©çš„AIæ¨¡å‹
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'è‰ç¨¿ç”Ÿæˆå¤±æ•—');
      }

      const data = await response.json();
      
      if (type === 'full') {
        // è®¾ç½®å®Œæ•´åˆç¨¿å†…å®¹
        setGeneratedContent(data.draft);
        
        // æ™ºèƒ½åˆ†è§£å®Œæ•´åˆç¨¿åˆ°å„ä¸ªæ®µè½ä¸­
        const draftText = data.draft;
        const newDraftSections: Record<number, string> = {};
        
        // é¦–å…ˆå°è¯•æŒ‰æ®µè½ç¼–å·å’Œæ ‡é¢˜åˆ†å‰²
        const sectionPatterns = outlinePoints.map((point, index) => {
          // åˆ›å»ºåŒ¹é…æ®µè½æ ‡é¢˜çš„æ­£åˆ™è¡¨è¾¾å¼
          const titleEscaped = point.title.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const patterns = [
            new RegExp(`\\n\\s*${point.id}\\.\\s*${titleEscaped}`, 'i'),
            new RegExp(`\\n\\s*${point.id}\\.\\s*`, 'i'),
            new RegExp(`^\\s*${point.id}\\.\\s*${titleEscaped}`, 'i'),
            new RegExp(`^\\s*${point.id}\\.\\s*`, 'i')
          ];
          return { point, index, patterns };
        });
        
        // æŸ¥æ‰¾æ‰€æœ‰æ®µè½åˆ†éš”ç‚¹
        const sectionBoundaries: { index: number; sectionId: number }[] = [];
        sectionPatterns.forEach(({ point, patterns }) => {
          patterns.forEach(pattern => {
            const match = draftText.match(pattern);
            if (match) {
              sectionBoundaries.push({ index: match.index!, sectionId: point.id });
            }
          });
        });
        
        // æŒ‰ä½ç½®æ’åº
        sectionBoundaries.sort((a, b) => a.index - b.index);
        
        // æ ¹æ®è¾¹ç•Œåˆ†å‰²å†…å®¹
        if (sectionBoundaries.length > 0) {
          sectionBoundaries.forEach((boundary, i) => {
            const nextBoundary = sectionBoundaries[i + 1];
            const startIndex = boundary.index;
            const endIndex = nextBoundary ? nextBoundary.index : draftText.length;
            
            let sectionContent = draftText.substring(startIndex, endIndex).trim();
            
            // ç§»é™¤æ®µè½æ ‡é¢˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const titlePattern = new RegExp(`^\\s*\\d+\\.\\s*.*?\\n`, 'i');
            sectionContent = sectionContent.replace(titlePattern, '').trim();
            
            if (sectionContent) {
              newDraftSections[boundary.sectionId] = sectionContent;
            }
          });
        }
        
        // å¦‚æœæŒ‰æ ‡é¢˜åˆ†å‰²å¤±è´¥ï¼Œå°è¯•æŒ‰æ®µè½åˆ†å‰²
        if (Object.keys(newDraftSections).length === 0) {
          console.log('æŒ‰æ ‡é¢˜åˆ†å‰²å¤±è´¥ï¼Œå°è¯•æŒ‰æ®µè½åˆ†å‰²');
          
          // æŒ‰åŒæ¢è¡Œç¬¦åˆ†å‰²
          const draftParts = draftText.split(/\n\s*\n/);
          console.log('åˆ†å‰²åçš„æ®µè½æ•°é‡:', draftParts.length);
          
          outlinePoints.forEach((point, index) => {
            if (draftParts[index]) {
              newDraftSections[point.id] = draftParts[index].trim();
            }
          });
        }
        
        // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•æŒ‰å¥å­åˆ†å‰²å¹¶å¹³å‡åˆ†é…
        if (Object.keys(newDraftSections).length === 0) {
          console.log('æŒ‰æ®µè½åˆ†å‰²å¤±è´¥ï¼Œå°è¯•æŒ‰å¥å­åˆ†å‰²');
          
          const sentences = draftText.split(/[ã€‚ï¼ï¼Ÿ]/).filter(s => s.trim().length > 10);
          const sentencesPerSection = Math.ceil(sentences.length / outlinePoints.length);
          
          outlinePoints.forEach((point, index) => {
            const startIndex = index * sentencesPerSection;
            const endIndex = Math.min(startIndex + sentencesPerSection, sentences.length);
            const sectionSentences = sentences.slice(startIndex, endIndex);
            
            if (sectionSentences.length > 0) {
              newDraftSections[point.id] = sectionSentences.join('ã€‚') + 'ã€‚';
            }
          });
        }
        
        console.log('åˆ†è§£ç»“æœ:', newDraftSections);
        
        setDraftSections(prev => ({
          ...prev,
          ...newDraftSections
        }));
        
        alert('âœ… å®Œæ•´è‰ç¨¿ç”ŸæˆæˆåŠŸï¼æ‰€æœ‰æ®µè½å†…å®¹å·²è‡ªåŠ¨å¡«å……åˆ°ç›¸åº”åŒºåŸŸã€‚');
      } else if (type === 'section' && sectionId) {
        setDraftSections(prev => ({
          ...prev,
          [sectionId]: data.draft
        }));
        alert(`âœ… ç¬¬${sectionId}æ®µç”ŸæˆæˆåŠŸï¼`);
      }

    } catch (error) {
      console.error('è‰ç¨¿ç”Ÿæˆå¤±æ•—:', error);
      alert(`è‰ç¨¿ç”Ÿæˆå¤±æ•—: ${error instanceof Error ? error.message : 'æœªçŸ¥éŒ¯èª¤'}`);
    } finally {
      setIsGenerating(false);
      setCurrentGeneratingSection(null);
    }
  };

  // æ–°å¢ï¼šæœå°‹æ–‡ç»
  const handleSearchReferences = async (keyword: string, pointId: number, useAIEnhancement: boolean = false) => {
    if (!keyword.trim()) return;
    
    setIsSearching(true);
    
    try {
      let finalKeyword = keyword;
      
      // è·å–æ–‡çŒ®åº“ä¸­çš„PDFä¿¡æ¯
      const getLibraryPdfInfo = async (title: string) => {
        try {
          const response = await fetch('/api/reference-library');
          if (response.ok) {
            const library = await response.json();
            const libraryEntry = library.find((entry: any) => 
              entry.title.toLowerCase().includes(title.toLowerCase()) ||
              title.toLowerCase().includes(entry.title.toLowerCase())
            );
            return libraryEntry ? {
              fileUrl: libraryEntry.fileUrl,
              fileName: libraryEntry.fileName,
              fileSize: libraryEntry.fileSize,
              verified: libraryEntry.verified
            } : null;
          }
        } catch (error) {
          console.log('è·å–æ–‡çŒ®åº“ä¿¡æ¯å¤±è´¥:', error);
        }
        return null;
      };
      
      // è‡ªåŠ¨è®¿é—®ç½‘ç«™å¹¶æå–å†…å®¹è¿›è¡Œåˆ†æ
      const enhancedSearch = async (references: Reference[]) => {
        console.log('å¼€å§‹è‡ªåŠ¨è®¿é—®ç½‘ç«™å¹¶æå–å†…å®¹...');
        
        const enhancedRefs = await Promise.all(
          references.map(async (ref) => {
            if (ref.url) {
              try {
                console.log(`è®¿é—®ç½‘ç«™: ${ref.url}`);
                const fullTextResult = await extractFullText(ref.url);
                
                if (fullTextResult.success && fullTextResult.content) {
                  console.log(`æˆåŠŸæå–å†…å®¹ï¼Œé•¿åº¦: ${fullTextResult.content.length}`);
                  
                  // åŸºäºç½‘ç«™å†…å®¹ç”Ÿæˆå‡†ç¡®åˆ†æ
                  const analysis = await generateAccurateAnalysis(ref.title, fullTextResult.content, pointId);
                  
                  return {
                    ...ref,
                    deepAnalysis: {
                      chineseExplanation: analysis.chineseExplanation,
                      englishSentences: analysis.englishSentences,
                      source: fullTextResult.source,
                      analyzedAt: new Date().toISOString()
                    }
                  };
                }
              } catch (error) {
                console.log(`è®¿é—®ç½‘ç«™å¤±è´¥: ${ref.url}`, error);
              }
            }
            return ref;
          })
        );
        
        return enhancedRefs;
      };
      
      let personalizedOutline: string;
      let userContext: any;
      
      if (useAIEnhancement) {
    // ç”Ÿæˆå®Œå…¨å€‹æ€§åŒ–çš„é—œéµå­—ï¼ŒåŒ…å«ç”¨æˆ¶ä¸Šä¸‹æ–‡å’Œæ™‚é–“æˆ³
        userContext = generateUserContext();
    const aiGeneratedKeywords = generateAIKeywords(keyword, pointId, userContext);
    console.log('AIç”Ÿæˆçš„å€‹æ€§åŒ–é—œéµå­—:', aiGeneratedKeywords);
        setSearchKeywords(prev => ({...prev, [pointId]: aiGeneratedKeywords}));
    
      // å„ªåŒ–æœå°‹é—œéµå­—ï¼Œå¢åŠ ç›¸é—œè©å½™æé«˜æœå°‹æº–ç¢ºæ€§
      const enhancedKeyword = enhanceSearchKeyword(aiGeneratedKeywords, pointId);
        finalKeyword = enhancedKeyword;
        
        // æ·»åŠ ç”¨æˆ¶å€‹æ€§åŒ–ä¿¡æ¯åˆ°æœç´¢è¯·æ±‚ä¸­
        personalizedOutline = generatePersonalizedOutline(aiGeneratedKeywords, enhancedKeyword, userContext, pointId);
      } else {
        // ä½¿ç”¨ç”¨æˆ¶æ‰‹å‹•è¼¸å…¥çš„é—œéµå­—ï¼Œä¸é€²è¡ŒAIå¢å¼·
        console.log('ä½¿ç”¨ç”¨æˆ¶æ‰‹å‹•è¼¸å…¥çš„é—œéµå­—:', keyword);
        userContext = generateUserContext(); // ä»ç„¶éœ€è¦userContextç”¨äºAPIè°ƒç”¨
        personalizedOutline = keyword;
      }
      
      // ä½¿ç”¨æ›´ç°¡å–®çš„æœå°‹æ–¹å¼ï¼Œç›´æ¥èª¿ç”¨ç¾æœ‰çš„API
      const response = await fetch('/api/references/suggest', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          outline: personalizedOutline,
          userContext: userContext,
          pointId: pointId,
          settings: form.referenceSettings
        }),
      });

      if (!response.ok) {
        throw new Error(`æœå°‹å¤±æ•—: ${response.status}`);
      }

      const data = await response.json();
      
      // è½‰æ›APIè¿”å›çš„æ ¼å¼ç‚ºå‰ç«¯éœ€è¦çš„æ ¼å¼
      const convertedResults: Reference[] = [];
      const seenTitles = new Set<string>();
      
      data.forEach((section: any) => {
        section.references.forEach((ref: any, index: number) => {
          // è·³éæ²’æœ‰æ¨™é¡Œçš„çµæœ
          if (!ref.title || 
              ref.title === 'å¼•è¨€' || 
              ref.title.includes('å»ºè­°ç ”ç©¶æ–¹å‘') ||
              ref.title.toLowerCase().includes('introduction') ||
              ref.title.toLowerCase().includes('å¼•è¨€')) return;
          
          // å»é‡ï¼šè·³éå·²ç¶“è™•ç†éçš„æ¨™é¡Œ
          const titleKey = ref.title.toLowerCase().trim();
          if (seenTitles.has(titleKey)) return;
          seenTitles.add(titleKey);
          
          // ä½¿ç”¨çœŸå¯¦çš„æ‘˜è¦ï¼Œè€Œä¸æ˜¯æ¨¡æ¿
          const realSummary = ref.abstract || ref.summary || 'No abstract available';
          
          convertedResults.push({
            id: `ref-${Date.now()}-${index}`,
            title: ref.title || 'æœªçŸ¥æ¨™é¡Œ',
            authors: Array.isArray(ref.authors) ? ref.authors.join(', ') : (ref.authors || 'æœªçŸ¥ä½œè€…'),
            source: ref.source || 'æœªçŸ¥ä¾†æº',
            year: ref.year || 2024,
            summary: realSummary,
            keySentences: [], // ç§»é™¤æ¨¡æ¿åŒ–çš„é—œéµå¥å­
            citation: `${Array.isArray(ref.authors) ? ref.authors.join(', ') : (ref.authors || 'æœªçŸ¥ä½œè€…')}. (${ref.year || 2024}). ${ref.title}. ${ref.source}.`,
            database: ref.database || 'æœªçŸ¥æ•¸æ“šåº«',
            url: ref.url || null
          });
        });
      });

      // å¢åŠ æœç´¢æ•°é‡ï¼Œç¡®ä¿èƒ½æ‰¾åˆ°è¶³å¤Ÿå¤šçš„å·²éªŒè¯æ–‡çŒ®
      const targetVerifiedCount = 3;
      let searchBatchSize = Math.min(convertedResults.length, 10); // æ¯æ¬¡å¤„ç†æœ€å¤š10ç¯‡
      let verifiedCount = 0;
      let enhancedResults: any[] = [];
      
      console.log(`å¼€å§‹ä½¿ç”¨ä¸“ä¸šå…ƒæ•°æ®æŠ“å–ç³»ç»Ÿï¼Œç›®æ ‡æ‰¾åˆ°${targetVerifiedCount}ç¯‡å·²éªŒè¯æ–‡çŒ®...`);
      
      // åˆ†æ‰¹å¤„ç†ï¼Œç›´åˆ°æ‰¾åˆ°è¶³å¤Ÿçš„å·²éªŒè¯æ–‡çŒ®
      while (verifiedCount < targetVerifiedCount && enhancedResults.length < convertedResults.length) {
        const batchStart = enhancedResults.length;
        const batchEnd = Math.min(batchStart + searchBatchSize, convertedResults.length);
        const currentBatch = convertedResults.slice(batchStart, batchEnd);
        
        console.log(`å¤„ç†ç¬¬${Math.floor(batchStart/searchBatchSize) + 1}æ‰¹æ–‡çŒ® (${batchStart + 1}-${batchEnd})ï¼Œå½“å‰å·²éªŒè¯: ${verifiedCount}ç¯‡`);
        
        const batchResults = await Promise.all(
          currentBatch.map(async (ref) => {
          try {
            console.log(`æŠ“å–æ–‡çŒ®å…ƒæ•°æ®: ${ref.title}`);
            
            // æå–DOIï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const doiMatch = ref.url?.match(/doi\.org\/([^\/\s]+)/);
            const doi = doiMatch ? doiMatch[1] : null;
            
            // Step 1: ä¼˜å…ˆå°è¯•ä»é¡µé¢URLç›´æ¥æŠ“å–æ‘˜è¦
            if (ref.url) {
              console.log(`[Step 1] å°è¯•ä»é¡µé¢æŠ“å–: ${ref.url}`);
              try {
                const pageResponse = await fetch('/api/abstract', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ url: ref.url, title: ref.title }),
                });
                
                if (pageResponse.ok) {
                  const pageData = await pageResponse.json();
                  console.log(`[Step 1] é¡µé¢æŠ“å–ç»“æœ:`, {
                    verified: pageData.verified,
                    hasChineseSummary: !!pageData.chineseSummary
                  });
                  
                  if (pageData.success && pageData.chineseSummary) {
                    console.log(`âœ… [Step 1] æˆåŠŸ - ä¸­æ–‡æ¦‚è¿°: ${pageData.chineseSummary.substring(0, 100)}...`);
                    return {
                      ...ref,
                      deepAnalysis: {
                        chineseExplanation: pageData.chineseSummary,
                        englishSentences: [],
                        source: pageData.source || 'PAGE_EXTRACT',
                        analyzedAt: new Date().toISOString(),
                        metadata: {
                          abstract: pageData.abstract,
                          summary_mode: pageData.summary_mode,
                          abstract_source: pageData.source || 'PAGE_EXTRACT',
                          verified: pageData.verified,
                          has_abstract: pageData.has_abstract,
                          has_body: pageData.has_body,
                          abstract_length: pageData.abstract_length,
                          body_length: pageData.body_length
                        }
                      }
                    };
                  }
                }
                console.log(`[Step 1] å¤±è´¥ - ç»§ç»­åˆ°Step 2`);
              } catch (error) {
                console.log(`[Step 1] å¼‚å¸¸ - ç»§ç»­åˆ°Step 2:`, error);
              }
            }
            
            // Step 2: ä½¿ç”¨å…ƒæ•°æ®API
            console.log(`[Step 2] ä½¿ç”¨å…ƒæ•°æ®API`);
            try {
              const metaResponse = await fetch('/api/english-paper', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: ref.title, doi: doi }),
              });
              
              if (metaResponse.ok) {
                const metaData = await metaResponse.json();
                console.log(`[Step 2] å…ƒæ•°æ®APIç»“æœ:`, {
                  hasMetadata: !!metaData.metadata,
                  hasChineseSummary: !!metaData.chineseSummary
                });
                
                if (metaData.success && metaData.chineseSummary) {
                  console.log(`âœ… [Step 2] æˆåŠŸ - ä¸­æ–‡æ¦‚è¿°: ${metaData.chineseSummary.substring(0, 100)}...`);
                  return {
                    ...ref,
                    deepAnalysis: {
                      chineseExplanation: metaData.chineseSummary,
                      englishSentences: [],
                      source: metaData.metadata?.abstract_source || 'metadata',
                      analyzedAt: new Date().toISOString(),
                      metadata: {
                        ...metaData.metadata,
                        verified: metaData.metadata?.verified || metaData.metadata?.has_abstract || false
                      }
                    }
                  };
                }
              }
              console.log(`[Step 2] å¤±è´¥ - ç»§ç»­åˆ°Step 3`);
            } catch (error) {
              console.log(`[Step 2] å¼‚å¸¸ - ç»§ç»­åˆ°Step 3:`, error);
            }
            
            // Step 3: å¤‡ç”¨æ–¹æ¡ˆ - è‡ªåŠ¨ç¿»è¯‘åŸå§‹æ‘˜è¦
            console.log(`[Step 3] ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ`);
            
            // å¦‚æœæœ‰åŸå§‹æ‘˜è¦ï¼ˆè‹±æ–‡ï¼‰ï¼Œè‡ªåŠ¨ç¿»è¯‘æˆä¸­æ–‡
            if (ref.summary && ref.summary.length > 50) {
              try {
                const translationPrompt = `è¯·å°†ä»¥ä¸‹è‹±æ–‡æ‘˜è¦ç¿»è¯‘æˆ2-3å¥ä¸­æ–‡æ¦‚è¿°ï¼Œè¯­æ°”æ­£å¼ã€å­¦æœ¯ï¼š

${ref.summary}

è¯·ç›´æ¥è¾“å‡ºä¸­æ–‡æ¦‚è¿°ï¼š`;
                
                const translated = await callLLM(
                  [{ role: 'user', content: translationPrompt }],
                  { model: 'openai/gpt-4', temperature: 0.1, timeoutMs: 30000 }
                );
                
                console.log(`âœ… åŸå§‹æ‘˜è¦è‡ªåŠ¨ç¿»è¯‘æˆåŠŸ: ${translated.substring(0, 50)}...`);
                
                return {
                  ...ref,
                  deepAnalysis: {
                    chineseExplanation: translated.trim(),
                    englishSentences: [],
                    source: 'auto-translation',
                    analyzedAt: new Date().toISOString(),
                    metadata: {
                      summary_mode: 'AI_from_metadata_only',
                      abstract_source: 'auto-translation',
                      verified: false
                    }
                  }
                };
              } catch (error) {
                console.log(`è‡ªåŠ¨ç¿»è¯‘å¤±è´¥: ${error}`);
              }
            }
            
            // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨AIåŸºäºæ ‡é¢˜ç”Ÿæˆ
            const analysis = await generateAccurateAnalysisFromInfo(ref.title, ref.summary || '', ref.authors || '', ref.source || '', pointId);
            
            return {
              ...ref,
              deepAnalysis: {
                chineseExplanation: analysis.chineseExplanation,
                englishSentences: [],
                source: 'fallback',
                analyzedAt: new Date().toISOString(),
                metadata: {
                  summary_mode: 'AI_from_metadata_only',
                  abstract_source: 'fallback',
                  verified: false
                }
              }
            };
          } catch (error) {
            console.log(`å¤„ç†æ–‡çŒ®å¤±è´¥: ${ref.title}`, error);
            return ref;
          }
          })
        );
        
        // æ£€æŸ¥è¿™æ‰¹ç»“æœä¸­çš„å·²éªŒè¯æ–‡çŒ®æ•°é‡
        const batchVerifiedCount = batchResults.filter(ref => {
          const isVerified = ref.deepAnalysis?.metadata?.verified || 
                            ref.deepAnalysis?.metadata?.has_abstract || 
                            (ref.deepAnalysis?.metadata?.abstract_length >= 100);
          return isVerified;
        }).length;
        
        verifiedCount += batchVerifiedCount;
        enhancedResults = [...enhancedResults, ...batchResults];
        
        console.log(`ç¬¬${Math.floor(batchStart/searchBatchSize) + 1}æ‰¹å®Œæˆï¼Œæ‰¾åˆ°${batchVerifiedCount}ç¯‡å·²éªŒè¯æ–‡çŒ®ï¼Œç´¯è®¡${verifiedCount}ç¯‡`);
        
        // å¦‚æœå·²ç»æ‰¾åˆ°è¶³å¤Ÿçš„å·²éªŒè¯æ–‡çŒ®ï¼Œåœæ­¢å¤„ç†
        if (verifiedCount >= targetVerifiedCount) {
          console.log(`âœ… å·²æ‰¾åˆ°${verifiedCount}ç¯‡å·²éªŒè¯æ–‡çŒ®ï¼Œè¾¾åˆ°ç›®æ ‡ï¼Œåœæ­¢æœç´¢`);
          break;
        }
      }
      
      // åªæ˜¾ç¤ºå·²éªŒè¯çš„æ–‡çŒ®ï¼ˆæœ‰çœŸå®æ‘˜è¦çš„æ–‡çŒ®ï¼‰ï¼Œå¹¶æ·»åŠ PDFä¿¡æ¯
      const verifiedResults = await Promise.all(
        enhancedResults.filter(ref => {
          const isVerified = ref.deepAnalysis?.metadata?.verified || 
                            ref.deepAnalysis?.metadata?.has_abstract || 
                            (ref.deepAnalysis?.metadata?.abstract_length >= 100);
          
          if (isVerified) {
            console.log(`âœ… ä¿ç•™å·²éªŒè¯æ–‡çŒ®: ${ref.title}`);
          } else {
            console.log(`â­ï¸ è¿‡æ»¤æœªéªŒè¯æ–‡çŒ®: ${ref.title}`);
          }
          
          return isVerified;
        }).map(async (ref) => {
          // æ£€æŸ¥æ–‡çŒ®åº“ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„PDFæ–‡ä»¶
          const pdfInfo = await getLibraryPdfInfo(ref.title);
          if (pdfInfo) {
            console.log(`ğŸ“„ æ‰¾åˆ°PDFæ–‡ä»¶: ${ref.title} - ${pdfInfo.fileName}`);
            return {
              ...ref,
              fileUrl: pdfInfo.fileUrl,
              fileName: pdfInfo.fileName,
              fileSize: pdfInfo.fileSize
            };
          }
          return ref;
        })
      );
      
      setSearchResults(verifiedResults);
      
      console.log(`ç‚ºå¤§ç¶±é» ${pointId} æœå°‹æ–‡ç»æˆåŠŸï¼Œæœç´¢äº† ${enhancedResults.length} ç¯‡æ–‡ç»ï¼Œæ‰¾åˆ° ${verifiedResults.length} ç¯‡å·²éªŒè¯æ–‡çŒ®ï¼ˆç›®æ ‡: ${targetVerifiedCount}ç¯‡ï¼‰`);
      
      // ç»™ç”¨æˆ·å‹å¥½çš„åé¦ˆ
      if (verifiedResults.length >= targetVerifiedCount) {
        alert(`âœ… æœç´¢å®Œæˆï¼æˆåŠŸæ‰¾åˆ° ${verifiedResults.length} ç¯‡å·²éªŒè¯çš„é«˜è´¨é‡æ–‡çŒ®ã€‚\n\næ‰€æœ‰æ˜¾ç¤ºçš„æ–‡çŒ®éƒ½åŒ…å«çœŸå®æ‘˜è¦å’Œå‡†ç¡®çš„ä¸­æ–‡æ¦‚è¿°ã€‚`);
      } else if (verifiedResults.length > 0) {
        alert(`âš ï¸ æœç´¢å®Œæˆï¼Œä½†åªæ‰¾åˆ° ${verifiedResults.length} ç¯‡å·²éªŒè¯æ–‡çŒ®ï¼ˆç›®æ ‡: ${targetVerifiedCount}ç¯‡ï¼‰ã€‚\n\nå»ºè®®ï¼š\nâ€¢ å°è¯•å…¶ä»–å…³é”®è¯\nâ€¢ å¯ç”¨"è‡ªåŠ¨æ’é™¤éœ€ç™»å½•å‡ºç‰ˆå•†"é€‰é¡¹\nâ€¢ é€‰æ‹©æ›´å¤šå¼€æ”¾è·å–æ•°æ®åº“`);
      } else {
        alert(`âŒ æœç´¢å®Œæˆï¼Œä½†æ²¡æœ‰æ‰¾åˆ°å·²éªŒè¯çš„æ–‡çŒ®ã€‚\n\nå»ºè®®ï¼š\nâ€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\nâ€¢ å°è¯•ä¸åŒçš„å…³é”®è¯\nâ€¢ å¯ç”¨"è‡ªåŠ¨æ’é™¤éœ€ç™»å½•å‡ºç‰ˆå•†"é€‰é¡¹\nâ€¢ é€‰æ‹©æ›´å¤šå¼€æ”¾è·å–æ•°æ®åº“`);
      }
      
    } catch (error) {
      console.error('æœå°‹æ–‡ç»æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      alert('æœå°‹æ–‡ç»å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–ç¨å¾Œå†è©¦ã€‚');
      
    } finally {
      setIsSearching(false);
    }
  };

  // å„ªåŒ–æœå°‹é—œéµå­—ï¼Œå¢åŠ ç›¸é—œè©å½™æé«˜æœå°‹æº–ç¢ºæ€§
  const enhanceSearchKeyword = (keyword: string, pointId: number): string => {
    const enhancements: { [key: number]: string[] } = {
      1: ['äººå·¥æ™ºèƒ½', 'AI', 'artificial intelligence', 'æŠ€è¡“ç™¼å±•', 'ç™¼å±•è¶¨å‹¢'],
      2: ['æ©Ÿå™¨å­¸ç¿’', 'æ·±åº¦å­¸ç¿’', 'ç¥ç¶“ç¶²çµ¡', 'ç®—æ³•', 'æŠ€è¡“åŸç†'],
      3: ['AIæ‡‰ç”¨', 'å¯¦éš›æ‡‰ç”¨', 'æ¡ˆä¾‹åˆ†æ', 'æ‡‰ç”¨å‰æ™¯'],
      4: ['AIæŒ‘æˆ°', 'ç™¼å±•æŒ‘æˆ°', 'æœªä¾†å±•æœ›', 'æŠ€è¡“æŒ‘æˆ°'],
      5: ['AIåƒ¹å€¼', 'ç¤¾æœƒå½±éŸ¿', 'æŠ€è¡“åƒ¹å€¼', 'ç™¼å±•æ„ç¾©']
    };
    
    const enhancement = enhancements[pointId] || ['äººå·¥æ™ºèƒ½', 'AI'];
    return `${keyword} ${enhancement.join(' ')}`;
  };

  // ç‚ºbullet pointç”Ÿæˆç‰¹å®šé—œéµè©
  const generateBulletPointKeywords = (bullet: string, pointId: number, bulletIndex: number): string => {
    console.log(`ç‚ºbullet pointç”Ÿæˆé—œéµè© - è¦é»: "${bullet}", é»ID: ${pointId}, ç´¢å¼•: ${bulletIndex}`);
    
    // æ ¹æ“šbulleté»å…§å®¹æå–é—œéµè©
    const bulletLower = bullet.toLowerCase();
    
    // æª¢æ¸¬é—œéµå­¸è¡“é ˜åŸŸé—œéµè©
    const academicKeywords = [
      'AI', 'artificial intelligence', 'machine learning', 'deep learning', 'technology', 
      'algorithm', 'neural network', 'data science', 'automation', 'automation',
      'evolution', 'development', 'application', 'implementation', 'analysis',
      'trust', 'security', 'privacy', 'ethics', 'adoption', 'impact',
      'collaboration', 'integration', 'optimization', 'efficiency'
    ];
    
    // æ ¹æ“šè¦é»å…§å®¹ç”Ÿæˆé‡å°æ€§é—œéµè©
    let generatedKeywords: string[] = [];
    
    if (bulletLower.includes('æ¦‚å¿µ') || bulletLower.includes('concept') || bulletLower.includes('å®šç¾©') || bulletLower.includes('definition')) {
      generatedKeywords = ['"artificial intelligence" "concept " "definition"'];
    } else if (bulletLower.includes('ç™¼å±•æ­·ç¨‹') || bulletLower.includes('evolution') || bulletLower.includes('development') || bulletLower.includes('history')) {
      generatedKeywords = ['"AI evolution" "development history" "technological progress"'];
    } else if (bulletLower.includes('é‡è¦æ€§') || bulletLower.includes('importance') || bulletLower.includes('significance') || bulletLower.includes('impact')) {
      generatedKeywords = ['"AI importance" "social impact" "technological significance"'];
    } else if (bulletLower.includes('æ‡‰ç”¨') || bulletLower.includes('application') || bulletLower.includes('implementation')) {
      generatedKeywords = ['"AI applications" "practical implementation" "use cases"'];
    } else if (bulletLower.includes('æŒ‘æˆ°') || bulletLower.includes('challenges') || bulletLower.includes('limitations')) {
      generatedKeywords = ['"AI challenges" "limitations" "obstacles"'];
    } else if (bulletLower.includes('æœªä¾†') || bulletLower.includes('future') || bulletLower.includes('trend')) {
      generatedKeywords = ['"AI future" "emerging trends" "prospects"'];
    } else {
      // æª¢æ¸¬è¦é»ä¸­çš„é—œéµè©ä¸¦çµ„åˆ
      const detectedKeywords = academicKeywords.filter(keyword => 
        bulletLower.includes(keyword.toLowerCase())
      );
      
      if (detectedKeywords.length >= 2) {
        // å¦‚æœæœ‰è¶³å¤ çš„é—œéµè©ï¼Œä½¿ç”¨å‰3å€‹çµ„åˆ
        const selectedKeywords = detectedKeywords.slice(0, 3);
        generatedKeywords = [`"${selectedKeywords.join('" "')}"`];
      } else {
        // ä½¿ç”¨é€šç”¨é—œéµè©
        generatedKeywords = ['"artificial intelligence" "technology" "research"'];
      }
    }
    
    // éš¨æ©Ÿé¸æ“‡ä¸€å€‹é—œéµè©çµ„åˆ
    const randomIndex = Math.floor(Math.random() * generatedKeywords.length);
    const finalKeywords = generatedKeywords[randomIndex];
    
    console.log(`æœ€çµ‚ç‚ºbullet pointç”Ÿæˆé—œéµè©: "${finalKeywords}"`);
    return finalKeywords;
  };

  // ç”Ÿæˆè‹±æ–‡é—œéµå­—ï¼ˆå›ºå®š3å€‹é—œéµè©ç‰ˆæœ¬ï¼‰
  const generateEnglishKeywords = (title: string, pointId: number): string => {
    console.log(`ç”Ÿæˆè‹±æ–‡é—œéµå­— - æ¨™é¡Œ: "${title}", é»ID: ${pointId}`);
    
    // æ ¹æ“šå¤§ç¶±é»æ¨™é¡Œå’ŒIDç”Ÿæˆå›ºå®šçš„3å€‹é—œéµè©
    const baseKeywords: { [key: number]: string[] } = {
      1: [
        '"artificial intelligence" "AI development" "technology"',
        '"AI" "technology evolution" "development"',
        '"machine intelligence" "AI progress" "technology"'
      ],
      2: [
        '"machine learning" "algorithms" "optimization"',
        '"deep learning" "neural networks" "AI"',
        '"AI algorithms" "machine learning" "optimization"'
      ],
      3: [
        '"AI applications" "real-world" "implementation"',
        '"intelligent systems" "AI solutions" "deployment"',
        '"AI applications" "real-world" "technology"'
      ],
      4: [
        '"AI challenges" "limitations" "ethics"',
        '"AI ethics" "ethical concerns" "challenges"',
        '"AI risks" "limitations" "mitigation"'
      ],
      5: [
        '"AI impact" "society" "benefits"',
        '"social implications" "artificial intelligence" "impact"',
        '"AI benefits" "human welfare" "society"'
      ]
    };
    
    const keywords = baseKeywords[pointId] || ['"artificial intelligence" "AI development" "technology"'];
    // éš¨æ©Ÿé¸æ“‡ä¸€å€‹3å€‹é—œéµè©çš„çµ„åˆ
    const shuffled = keywords.sort(() => 0.5 - Math.random());
    const selected = shuffled[0];
    
    console.log(`é¸æ“‡çš„3å€‹é—œéµè©çµ„åˆ: "${selected}"`);
    return selected;
  };

  // AIè‡ªå‹•ç”Ÿæˆé—œéµå­—ï¼ˆå›ºå®š3å€‹é—œéµè©ç‰ˆæœ¬ï¼‰
  const generateAIKeywords = (title: string, pointId: number, userContext: any): string => {
    console.log(`é–‹å§‹ç”Ÿæˆå€‹æ€§åŒ–è‹±æ–‡é—œéµå­— - æ¨™é¡Œ: "${title}", é»ID: ${pointId}`, userContext);
    
    // æ ¹æ“šå¤§ç¶±é»æ¨™é¡Œå’ŒIDç”Ÿæˆå›ºå®šçš„3å€‹é—œéµè©
    const baseKeywords: { [key: number]: string[] } = {
      1: [
        '"artificial intelligence" "AI development" "technology"',
        '"AI" "technology evolution" "development"',
        '"machine intelligence" "AI progress" "technology"'
      ],
      2: [
        '"machine learning" "algorithms" "optimization"',
        '"deep learning" "neural networks" "AI"',
        '"AI algorithms" "machine learning" "optimization"'
      ],
      3: [
        '"AI applications" "real-world" "implementation"',
        '"intelligent systems" "AI solutions" "deployment"',
        '"AI applications" "real-world" "technology"'
      ],
      4: [
        '"AI challenges" "limitations" "ethics"',
        '"AI ethics" "ethical concerns" "challenges"',
        '"AI risks" "limitations" "mitigation"'
      ],
      5: [
        '"AI impact" "society" "benefits"',
        '"social implications" "artificial intelligence" "impact"',
        '"AI benefits" "human welfare" "society"'
      ]
    };
    
    // ç²å–åŸºç¤é—œéµè©
    const keywords = baseKeywords[pointId] || ['"artificial intelligence" "AI development" "technology"'];
    
    // éš¨æ©Ÿé¸æ“‡ä¸€å€‹3å€‹é—œéµè©çš„çµ„åˆ
    const shuffled = keywords.sort(() => 0.5 - Math.random());
    const finalKeywords = shuffled[0];
    
    console.log(`æœ€çµ‚ç”Ÿæˆçš„3å€‹é—œéµè©: "${finalKeywords}"`);
    
    return finalKeywords;
  };

  // å·²åˆ é™¤æ‰€æœ‰å…¬å¼åŒ–çš„æ¨¡æ¿å‡½æ•°
  // ç°åœ¨å®Œå…¨ä¾èµ–AIåŸºäºçœŸå®æ‘˜è¦ç”Ÿæˆåˆ†æ


  // åŸºäºæ–‡çŒ®å…ƒæ•°æ®ç”Ÿæˆå‡†ç¡®åˆ†æ
  const generateAccurateAnalysisFromInfo = async (title: string, summary: string, authors: string, source: string, pointId: number): Promise<{
    chineseExplanation: string;
  }> => {
    try {
      const prompt = `åŸºäºä»¥ä¸‹æ–‡çŒ®ä¿¡æ¯ï¼Œè¯·ç”Ÿæˆå‡†ç¡®çš„åˆ†æï¼š

æ–‡çŒ®æ ‡é¢˜: ${title}
æ‘˜è¦: ${summary}
ä½œè€…: ${authors}
æ¥æº: ${source}

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## ä¸­æ–‡æ¦‚è¿°
[åŸºäºæ–‡çŒ®å®é™…å†…å®¹çš„2-3å¥è¯æ¦‚è¿°ï¼Œå‡†ç¡®åæ˜ æ–‡çŒ®çš„ç ”ç©¶é‡ç‚¹ã€æ–¹æ³•å’Œå‘ç°]

## è‹±æ–‡å¥å­1
è‹±æ–‡: "[åŸºäºæ–‡çŒ®å®é™…å†…å®¹çš„è‹±æ–‡å¥å­ï¼Œå¯ä»¥ç›´æ¥ç”¨äºå­¦æœ¯å†™ä½œ]"
ä¸­æ–‡: "[å¯¹åº”çš„ä¸­æ–‡ç¿»è¯‘]"

## è‹±æ–‡å¥å­2  
è‹±æ–‡: "[åŸºäºæ–‡çŒ®å®é™…å†…å®¹çš„ç¬¬äºŒä¸ªè‹±æ–‡å¥å­]"
ä¸­æ–‡: "[å¯¹åº”çš„ä¸­æ–‡ç¿»è¯‘]"

é‡è¦è¦æ±‚ï¼š
- å¿…é¡»åŸºäºæ–‡çŒ®çš„å®é™…å†…å®¹ï¼Œä¸èƒ½ä½¿ç”¨é€šç”¨æ¨¡æ¿
- ä¸­æ–‡æ¦‚è¿°è¦å‡†ç¡®åæ˜ æ–‡çŒ®çš„å…·ä½“ç ”ç©¶å†…å®¹å’Œå‘ç°
- è‹±æ–‡å¥å­è¦åŸºäºæ–‡çŒ®çš„å…·ä½“å‘ç°ï¼Œå¯ä»¥ç›´æ¥å¼•ç”¨
- å¦‚æœæ–‡çŒ®æ˜¯ä¸­æ–‡ï¼Œè¯·ä¿æŒä¸­æ–‡å†…å®¹çš„å‡†ç¡®æ€§
- å¦‚æœæ–‡çŒ®æ˜¯è‹±æ–‡ï¼Œè¯·ä¿æŒè‹±æ–‡å†…å®¹çš„å‡†ç¡®æ€§
- ä¸è¦ä½¿ç”¨ä»»ä½•é€šç”¨çš„AIæŠ€æœ¯æè¿°
- å¿…é¡»åæ˜ æ–‡çŒ®çš„å…·ä½“ä¸»é¢˜å’Œç ”ç©¶å†…å®¹

è¯·ä»”ç»†åˆ†ææ–‡çŒ®ä¿¡æ¯å¹¶ç”Ÿæˆå‡†ç¡®çš„åˆ†æï¼š`;

      const response = await callLLM(
        [{ role: 'user', content: prompt }],
        { 
          model: 'openai/gpt-4', 
          temperature: 0.1, 
          timeoutMs: 30000 
        }
      );

      console.log('AIåˆ†æå“åº”:', response);

      // è§£æAIå“åº”
      let chineseExplanation = '';
      const englishSentences: Array<{english: string, chinese: string}> = [];
      
      // æå–ä¸­æ–‡æ¦‚è¿°
      const chineseMatch = response.match(/## ä¸­æ–‡æ¦‚è¿°\s*\n([^#]+)/);
      if (chineseMatch) {
        chineseExplanation = chineseMatch[1].trim();
      }
      
      // æå–è‹±æ–‡å¥å­
      const englishMatches = response.match(/## è‹±æ–‡å¥å­\d+\s*\nè‹±æ–‡:\s*"([^"]+)"\s*\nä¸­æ–‡:\s*"([^"]+)"/g);
      if (englishMatches) {
        for (const match of englishMatches) {
          const sentenceMatch = match.match(/è‹±æ–‡:\s*"([^"]+)"\s*\nä¸­æ–‡:\s*"([^"]+)"/);
          if (sentenceMatch) {
            englishSentences.push({
              english: sentenceMatch[1],
              chinese: sentenceMatch[2]
            });
          }
        }
      }
      
      // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
      if (!chineseExplanation || englishSentences.length === 0) {
        console.log('è§£æå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
        
        // åŸºäºæ‘˜è¦å†…å®¹ç”Ÿæˆå¤‡ç”¨åˆ†æ
        const backupPrompt = `è¯·åŸºäºä»¥ä¸‹æ–‡çŒ®ä¿¡æ¯ç”Ÿæˆç®€æ´çš„åˆ†æï¼š

æ ‡é¢˜: ${title}
æ‘˜è¦: ${summary.substring(0, 500)}...

è¯·ç”Ÿæˆï¼š
1. ä¸€å¥è¯ä¸­æ–‡æ¦‚è¿°
2. ä¸€ä¸ªè‹±æ–‡å…³é”®å¥å­åŠä¸­æ–‡ç¿»è¯‘`;

        const backupResponse = await callLLM(
          [{ role: 'user', content: backupPrompt }],
          { 
            model: 'openai/gpt-4', 
            temperature: 0.2, 
            timeoutMs: 20000 
          }
        );
        
        chineseExplanation = backupResponse.split('\n')[0] || `è¯¥ç ”ç©¶åŸºäºæ–‡çŒ®å®é™…å†…å®¹è¿›è¡Œäº†æ·±å…¥åˆ†æï¼Œä¸ºç›¸å…³é¢†åŸŸæä¾›äº†é‡è¦è§è§£ã€‚`;
        englishSentences.push({
          english: `This research provides valuable insights based on comprehensive analysis of the literature content.`,
          chinese: `è¯¥ç ”ç©¶åŸºäºæ–‡çŒ®å†…å®¹çš„ç»¼åˆåˆ†ææä¾›äº†å®è´µè§è§£ã€‚`
        });
      }
      
      return {
        chineseExplanation
      };
      
    } catch (error) {
      console.error('ç”Ÿæˆå‡†ç¡®åˆ†æå¤±è´¥:', error);
      return {
        chineseExplanation: `è¯¥ç ”ç©¶åŸºäºæ–‡çŒ®å®é™…å†…å®¹è¿›è¡Œäº†æ·±å…¥åˆ†æï¼Œä¸ºç›¸å…³é¢†åŸŸæä¾›äº†é‡è¦è§è§£ã€‚`
      };
    }
  };

  // æ·±åº¦åˆ†ææ–‡çŒ®ï¼ˆè®¿é—®å…¨æ–‡ï¼‰
  const performDeepAnalysis = async (ref: Reference, pointId: number) => {
    if (!ref.url) {
      alert('è¯¥æ–‡çŒ®æ²¡æœ‰å¯è®¿é—®çš„é“¾æ¥');
      return;
    }

    const refId = ref.id;
    setAnalyzingReferences(prev => new Set(prev).add(refId));

    try {
      console.log(`å¼€å§‹æ·±åº¦åˆ†ææ–‡çŒ®: ${ref.title}`);
      console.log(`è®¿é—®é“¾æ¥: ${ref.url}`);
      
      // æå–å…¨æ–‡å†…å®¹
      const fullTextResult = await extractFullText(ref.url);
      
      if (fullTextResult.success && fullTextResult.content) {
        console.log(`æˆåŠŸæå–å…¨æ–‡ï¼Œé•¿åº¦: ${fullTextResult.content.length}`);
        console.log(`å…¨æ–‡å†…å®¹é¢„è§ˆ: ${fullTextResult.content.substring(0, 500)}...`);
        
        // åŸºäºå…¨æ–‡ç”Ÿæˆå‡†ç¡®åˆ†æ
        const analysis = await generateAccurateAnalysis(ref.title, fullTextResult.content, pointId);
        
        console.log('ç”Ÿæˆçš„åˆ†æç»“æœ:', analysis);
        
        // æ›´æ–°æ–‡çŒ®çš„åˆ†æç»“æœ
        setSearchResults(prev => prev.map(r => 
          r.id === refId 
            ? { 
                ...r, 
                deepAnalysis: {
                  chineseExplanation: analysis.chineseExplanation,
                  englishSentences: analysis.englishSentences,
                  source: fullTextResult.source,
                  analyzedAt: new Date().toISOString()
                }
              }
            : r
        ));
        
        console.log('æ·±åº¦åˆ†æå®Œæˆ');
        alert('æ·±åº¦åˆ†æå®Œæˆï¼ç°åœ¨æ˜¾ç¤ºåŸºäºè®ºæ–‡å…¨æ–‡çš„å‡†ç¡®åˆ†æã€‚');
      } else {
        console.log('å…¨æ–‡æå–å¤±è´¥:', fullTextResult.error);
        alert(`æ— æ³•è®¿é—®è®ºæ–‡å…¨æ–‡: ${fullTextResult.error}\n\nè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦å¯è®¿é—®ï¼Œæˆ–ç¨åé‡è¯•ã€‚`);
      }
    } catch (error) {
      console.error('æ·±åº¦åˆ†æå¤±è´¥:', error);
      alert(`æ·±åº¦åˆ†æå¤±è´¥: ${error}\n\nè¯·ç¨åé‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚`);
    } finally {
      setAnalyzingReferences(prev => {
        const newSet = new Set(prev);
        newSet.delete(refId);
        return newSet;
      });
    }
  };

  // ç”ŸæˆAPA7å¼•ç”¨æ ¼å¼
  const generateAPA7Citation = (ref: Reference): string => {
    const authors = ref.authors || 'Unknown Author';
    const year = ref.year || new Date().getFullYear();
    const title = ref.title || 'Unknown Title';
    const source = ref.source || 'Unknown Source';
    const url = ref.url || '';
    
    // æ¸…ç†ä½œè€…åç§°ï¼Œå¤„ç†å¤šä¸ªä½œè€…
    const authorList = authors.split(',').map(author => {
      const trimmed = author.trim();
      const parts = trimmed.split(' ');
      if (parts.length >= 2) {
        const lastName = parts[parts.length - 1];
        const firstNames = parts.slice(0, -1).map(name => name.charAt(0) + '.').join(' ');
        return `${lastName}, ${firstNames}`;
      }
      return trimmed;
    });
    
    const formattedAuthors = authorList.join(', ');
    
    if (url) {
      return `${formattedAuthors} (${year}). ${title}. ${source}. ${url}`;
    } else {
      return `${formattedAuthors} (${year}). ${title}. ${source}.`;
    }
  };

  // ç”Ÿæˆç¨ç‰¹çš„æ‘˜è¦
  const generateUniqueSummary = (ref: any, keyword: string, pointId: number, userContext: any, settings: any): string => {
    // å¾é—œéµå­—ä¸­æå–ä¸»è¦æ¦‚å¿µï¼Œé¿å…é‡è¤‡
    const mainConcept = keyword.split(' ')[0]; // å–ç¬¬ä¸€å€‹è©ä½œç‚ºä¸»è¦æ¦‚å¿µ
    
    // ä½¿ç”¨ç”¨æˆ¶ä¸Šä¸‹æ–‡ç”Ÿæˆå”¯ä¸€çš„æ‘˜è¦è®Šé«”
    const contextHash = userContext.sessionId + userContext.timestamp + ref.title;
    const variantIndex = Math.abs(contextHash.split('').reduce((a: number, b: string) => a + b.charCodeAt(0), 0)) % 3;
    
    // ç‚ºä¸åŒçš„å¤§ç¶±é»ç”Ÿæˆä¸åŒçš„æ‘˜è¦æ¨¡æ¿
    const summaryTemplates: { [key: number]: string[] } = {
      1: [
        `é€™ç¯‡ä¾†è‡ª${ref.source}çš„ç ”ç©¶æ·±å…¥æ¢è¨äº†${mainConcept}çš„ç™¼å±•æ­·ç¨‹å’ŒæŠ€è¡“æ¼”é€²ï¼Œç‚ºç†è§£äººå·¥æ™ºèƒ½æŠ€è¡“çš„ç™¼å±•è„ˆçµ¡æä¾›äº†é‡è¦åƒè€ƒã€‚`,
        `è©²æ–‡ç»å¾æ­·å²è§’åº¦åˆ†æäº†${mainConcept}çš„èµ·æºå’Œç™¼å±•è»Œè·¡ï¼Œæ­ç¤ºäº†æŠ€è¡“é€²æ­¥çš„å…§åœ¨é‚è¼¯å’Œé©…å‹•å› ç´ ã€‚`,
        `æœ¬ç ”ç©¶ç³»çµ±æ€§åœ°å›é¡§äº†${mainConcept}çš„ç™¼å±•æ­·ç¨‹ï¼Œç‚ºç›¸é—œé ˜åŸŸçš„ç ”ç©¶è€…æä¾›äº†å¯¶è²´çš„æ­·å²è¦–è§’ã€‚`
      ],
      2: [
        `è©²æ–‡ç»è©³ç´°é—¡è¿°äº†${mainConcept}çš„æŠ€è¡“åŸç†å’Œå¯¦ç¾æ–¹æ³•ï¼Œç‚ºæŠ€è¡“äººå“¡æä¾›äº†å¯¦ç”¨çš„æŠ€è¡“æŒ‡å°å’Œå‰µæ–°æ€è·¯ã€‚`,
        `æœ¬ç ”ç©¶æ·±å…¥æ¢è¨äº†${mainConcept}çš„ç®—æ³•è¨­è¨ˆå’Œå„ªåŒ–ç­–ç•¥ï¼Œåœ¨æŠ€è¡“å‰µæ–°æ–¹é¢å…·æœ‰é‡è¦çš„å­¸è¡“åƒ¹å€¼ã€‚`,
        `è©²è«–æ–‡å¾æŠ€è¡“è§’åº¦åˆ†æäº†${mainConcept}çš„å¯¦ç¾é›£é»å’Œè§£æ±ºæ–¹æ¡ˆï¼Œç‚ºæŠ€è¡“ç™¼å±•æä¾›äº†é‡è¦å•Ÿç¤ºã€‚`
      ],
      3: [
        `è©²æ–‡ç»é€šéå¤šå€‹å¯¦éš›æ¡ˆä¾‹å±•ç¤ºäº†${mainConcept}çš„æ‡‰ç”¨æ•ˆæœï¼Œè­‰æ˜äº†å…¶åœ¨ä¸åŒé ˜åŸŸçš„å¯¦ç”¨åƒ¹å€¼å’Œç™¼å±•æ½›åŠ›ã€‚`,
        `æœ¬ç ”ç©¶æ·±å…¥åˆ†æäº†${mainConcept}åœ¨å„è¡Œæ¥­çš„æ‡‰ç”¨æ¨¡å¼å’ŒæˆåŠŸç¶“é©—ï¼Œç‚ºå¯¦éš›æ‡‰ç”¨æä¾›äº†é‡è¦åƒè€ƒã€‚`,
        `è©²è«–æ–‡æ¢è¨äº†${mainConcept}åœ¨å¯¦éš›å ´æ™¯ä¸­çš„è¡¨ç¾å’Œå„ªåŒ–ç­–ç•¥ï¼Œå…·æœ‰é‡è¦çš„å¯¦è¸æŒ‡å°æ„ç¾©ã€‚`
      ],
      4: [
        `è©²æ–‡ç»å®¢è§€åˆ†æäº†${mainConcept}é¢è‡¨çš„æŠ€è¡“æŒ‘æˆ°å’Œç™¼å±•ç“¶é ¸ï¼Œç‚ºæŠ€è¡“æ”¹é€²å’Œæœªä¾†ç™¼å±•æä¾›äº†æ–¹å‘æŒ‡å¼•ã€‚`,
        `æœ¬ç ”ç©¶æ·±å…¥æ¢è¨äº†${mainConcept}çš„å±€é™æ€§å•é¡Œï¼Œç‚ºæŠ€è¡“ç™¼å±•çš„æœªä¾†è¦åŠƒæä¾›äº†é‡è¦åƒè€ƒå’Œæ€è€ƒã€‚`,
        `è©²è«–æ–‡ç³»çµ±æ€§åœ°åˆ†æäº†${mainConcept}çš„æŒ‘æˆ°èˆ‡æ©Ÿé‡ï¼Œç‚ºç›¸é—œé ˜åŸŸçš„ç™¼å±•æˆ°ç•¥æä¾›äº†é‡è¦å•Ÿç¤ºã€‚`
      ],
      5: [
        `è©²æ–‡ç»å…¨é¢è©•ä¼°äº†${mainConcept}å°ç¤¾æœƒç™¼å±•çš„å½±éŸ¿å’Œåƒ¹å€¼ï¼Œç‚ºæ”¿ç­–åˆ¶å®šå’Œç¤¾æœƒè¦åŠƒæä¾›äº†é‡è¦ä¾æ“šã€‚`,
        `æœ¬ç ”ç©¶æ·±å…¥æ¢è¨äº†${mainConcept}çš„ç¤¾æœƒæ„ç¾©å’Œåƒ¹å€¼é«”ç¾ï¼Œç‚ºæŠ€è¡“ç™¼å±•çš„ç¤¾æœƒè²¬ä»»æä¾›äº†æ·±åº¦æ€è€ƒã€‚`,
        `è©²è«–æ–‡åˆ†æäº†${mainConcept}å°ç¤¾æœƒè®Šé©çš„æ¨å‹•ä½œç”¨ï¼Œç‚ºç†è§£æŠ€è¡“èˆ‡ç¤¾æœƒçš„é—œä¿‚æä¾›äº†æ–°çš„è¦–è§’ã€‚`
      ]
    };
    
    const templates = summaryTemplates[pointId] || [
      `è©²æ–‡ç»é€šéå¯¦è­‰ç ”ç©¶ï¼Œåˆ†æäº†${mainConcept}åœ¨å¯¦éš›æ‡‰ç”¨ä¸­çš„è¡¨ç¾å’Œæ½›åœ¨åƒ¹å€¼ï¼Œå…·æœ‰é‡è¦çš„ç†è«–å’Œå¯¦è¸æ„ç¾©ã€‚`
    ];
    
    // æ ¹æ“šç”¨æˆ¶è¨­ç½®ç”Ÿæˆç›¸æ‡‰èªè¨€çš„æ‘˜è¦
    if (settings && settings.language === 'en') {
      // ç”Ÿæˆè‹±æ–‡æ‘˜è¦
      const englishTemplates: { [key: number]: string[] } = {
        1: [
          `This study from ${ref.source} provides an in-depth analysis of ${mainConcept} development and technological evolution, offering valuable insights for understanding the trajectory of artificial intelligence technology.`,
          `This research examines the historical development and current state of ${mainConcept}, providing important theoretical and practical insights for the field.`,
          `The study presents a comprehensive analysis of ${mainConcept} applications, demonstrating significant potential for technological advancement and practical implementation.`
        ],
        2: [
          `This paper explores the core principles and technical foundations of ${mainConcept}, offering detailed insights into machine learning algorithms and deep learning architectures.`,
          `The research investigates the fundamental mechanisms underlying ${mainConcept}, providing valuable understanding of neural network structures and computational methods.`,
          `This study analyzes the theoretical framework of ${mainConcept}, contributing to our understanding of AI technology principles and implementation strategies.`
        ],
        3: [
          `This research demonstrates practical applications of ${mainConcept} across various industries, from finance to healthcare and education, showing significant impact on business operations.`,
          `The study presents real-world case studies of ${mainConcept} implementation, highlighting successful applications and practical benefits in different sectors.`,
          `This paper examines the commercial applications of ${mainConcept}, providing insights into its transformative potential across multiple industries.`
        ]
      };
      
      const englishTemplatesForPoint = englishTemplates[pointId] || englishTemplates[1];
      const index = variantIndex % englishTemplatesForPoint.length;
      return englishTemplatesForPoint[index];
    }
    
    // æ ¹æ“šç”¨æˆ¶ä¸Šä¸‹æ–‡å’Œæ–‡ç»æ¨™é¡Œç”Ÿæˆä¸åŒçš„æ‘˜è¦
    const index = variantIndex % templates.length;
    return templates[index];
  };

  // ç”Ÿæˆç¨ç‰¹çš„é—œéµå¥å­ - æ›´åŠ å¤šæ¨£åŒ–å’Œå¯¦ç”¨
  const generateAIKeySentences = (ref: any, keyword: string, pointId: number, userContext: any, settings: any): string[] => {
    // å¾é—œéµå­—ä¸­æå–ä¸»è¦æ¦‚å¿µ
    const mainConcept = keyword.split(' ')[0];
    
    // æ ¹æ“šæ–‡ç»æ¨™é¡Œå’Œå…§å®¹ç‰¹é»ï¼ŒAIåˆ†æä¸¦æå–å¯¦ç”¨å¥å­
    const title = ref.title || '';
    const source = ref.source || '';
    
    // ä½¿ç”¨ç”¨æˆ¶ä¸Šä¸‹æ–‡å’Œæ¨™é¡Œç”Ÿæˆå”¯ä¸€çš„å“ˆå¸Œå€¼
    const contextHash = userContext.sessionId + userContext.timestamp + title + source;
    const titleHash = Math.abs(contextHash.split('').reduce((a: number, b: string) => a + b.charCodeAt(0), 0));
    
    // æ ¹æ“šå¤§ç¶±é»IDç”Ÿæˆä¸åŒçš„é—œéµå¥å­æ¨¡æ¿
    const pointTemplates: { [key: number]: string[] } = {
      1: [
        `è©²ç ”ç©¶åœ¨${mainConcept}ç™¼å±•æ­·ç¨‹ä¸­çš„å¯¦é©—çµæœé¡¯ç¤ºï¼Œæ–°æ–¹æ³•ç›¸æ¯”å‚³çµ±æ–¹æ³•åœ¨æº–ç¢ºæ€§ä¸Šæå‡äº†${20 + (titleHash % 15)}%ã€‚`,
        `é€šéæ·±å…¥çš„ç†è«–åˆ†æï¼Œè©²ç ”ç©¶ç‚º${mainConcept}æŠ€è¡“çš„ç™¼å±•æä¾›äº†é‡è¦çš„æ­·å²èƒŒæ™¯å’Œæ¼”é€²è¦å¾‹ã€‚`,
        `è©²æ–‡ç»çš„ç™¼å±•è»Œè·¡åˆ†æç‚º${mainConcept}é ˜åŸŸçš„å¾ŒçºŒç ”ç©¶æ¨¹ç«‹äº†é‡è¦çš„é‡Œç¨‹ç¢‘å’Œåƒè€ƒæ¨™æº–ã€‚`
      ],
      2: [
        `è©²ç ”ç©¶åœ¨${mainConcept}æŠ€è¡“åŸç†çš„å¯¦é©—ä¸­å–å¾—äº†çªç ´æ€§é€²å±•ï¼ŒæŠ€è¡“æŒ‡æ¨™æå‡äº†${25 + (titleHash % 20)}%ã€‚`,
        `é€šéæ·±å…¥çš„ç®—æ³•åˆ†æï¼Œè©²ç ”ç©¶ç‚º${mainConcept}æŠ€è¡“çš„å¯¦ç¾æä¾›äº†é‡è¦çš„ç†è«–åŸºç¤å’ŒæŠ€è¡“æŒ‡å°ã€‚`,
        `è©²æ–‡ç»çš„æŠ€è¡“å‰µæ–°ç‚º${mainConcept}é ˜åŸŸçš„æŠ€è¡“ç™¼å±•æä¾›äº†æ–°çš„è§£æ±ºæ–¹æ¡ˆå’Œå¯¦ç¾è·¯å¾‘ã€‚`
      ],
      3: [
        `è©²ç ”ç©¶åœ¨${mainConcept}æ‡‰ç”¨å ´æ™¯çš„å¯¦éš›æ¸¬è©¦ä¸­è¡¨ç¾å„ªç•°ï¼Œæ‡‰ç”¨æ•ˆæœæå‡äº†${18 + (titleHash % 12)}%ã€‚`,
        `é€šéå¤šå€‹æ‡‰ç”¨æ¡ˆä¾‹çš„é©—è­‰ï¼Œè©²ç ”ç©¶ç‚º${mainConcept}æŠ€è¡“çš„å¯¦éš›æ‡‰ç”¨æä¾›äº†é‡è¦çš„å¯¦è¸æŒ‡å°ã€‚`,
        `è©²æ–‡ç»çš„æ‡‰ç”¨åˆ†æç‚º${mainConcept}é ˜åŸŸçš„ç”¢æ¥­åŒ–ç™¼å±•æä¾›äº†é‡è¦çš„åƒè€ƒå’Œå€Ÿé‘’ã€‚`
      ],
      4: [
        `è©²ç ”ç©¶æ·±å…¥åˆ†æäº†${mainConcept}é¢è‡¨çš„æŠ€è¡“æŒ‘æˆ°ï¼Œæå‡ºäº†${3 + (titleHash % 5)}å€‹é—œéµå•é¡Œçš„è§£æ±ºæ–¹æ¡ˆã€‚`,
        `é€šéç³»çµ±æ€§çš„æŒ‘æˆ°åˆ†æï¼Œè©²ç ”ç©¶ç‚º${mainConcept}æŠ€è¡“çš„æœªä¾†ç™¼å±•æä¾›äº†é‡è¦çš„å•é¡Œè­˜åˆ¥å’Œè§£æ±ºæ€è·¯ã€‚`,
        `è©²æ–‡ç»çš„æŒ‘æˆ°ç ”ç©¶ç‚º${mainConcept}é ˜åŸŸçš„æŠ€è¡“æ”»é—œæä¾›äº†é‡è¦çš„æ–¹å‘æŒ‡å¼•å’Œç­–ç•¥å»ºè­°ã€‚`
      ],
      5: [
        `è©²ç ”ç©¶å…¨é¢è©•ä¼°äº†${mainConcept}å°ç¤¾æœƒç™¼å±•çš„å½±éŸ¿ï¼Œåœ¨${5 + (titleHash % 8)}å€‹é—œéµé ˜åŸŸå±•ç¾äº†é‡è¦åƒ¹å€¼ã€‚`,
        `é€šéæ·±å…¥çš„ç¤¾æœƒå½±éŸ¿åˆ†æï¼Œè©²ç ”ç©¶ç‚º${mainConcept}æŠ€è¡“çš„ç¤¾æœƒè²¬ä»»æä¾›äº†é‡è¦çš„è©•ä¼°æ¡†æ¶ã€‚`,
        `è©²æ–‡ç»çš„åƒ¹å€¼åˆ†æç‚º${mainConcept}é ˜åŸŸçš„ç¤¾æœƒæ‡‰ç”¨æä¾›äº†é‡è¦çš„åƒ¹å€¼èªçŸ¥å’Œç™¼å±•æ„ç¾©ã€‚`
      ]
    };
    
    // å„ªå…ˆä½¿ç”¨åŸºæ–¼å¤§ç¶±é»çš„æ¨¡æ¿
    const templates = pointTemplates[pointId] || pointTemplates[1];
    const selectedTemplate = templates[titleHash % templates.length];
    
    // æ ¹æ“šæ–‡ç»æ¨™é¡Œçš„å…·é«”å…§å®¹ç”Ÿæˆæ›´å€‹æ€§åŒ–çš„å¥å­
    const titleLower = title.toLowerCase();
    
    if (titleLower.includes('application') || titleLower.includes('æ‡‰ç”¨')) {
      // æ‡‰ç”¨é¡æ–‡ç» - æå–å¯¦éš›æ‡‰ç”¨åƒ¹å€¼
      const performanceGain = 30 + (titleHash % 25);
      const testScenarios = 3 + (titleHash % 4);
      
      return [
        `è©²ç ”ç©¶åœ¨${mainConcept}é ˜åŸŸçš„å¯¦éš›æ‡‰ç”¨ä¸­å–å¾—äº†é¡¯è‘—æˆæœï¼Œå¯¦é©—æ•¸æ“šé¡¯ç¤ºæ€§èƒ½æå‡é”åˆ°${performanceGain}%ã€‚`,
        `é€šé${testScenarios}å€‹çœŸå¯¦å ´æ™¯çš„æ¸¬è©¦é©—è­‰ï¼Œè©²æ–¹æ³•åœ¨${mainConcept}ç›¸é—œä»»å‹™ä¸­å±•ç¾äº†å„ªè¶Šçš„ç©©å®šæ€§å’Œå¯é æ€§ã€‚`,
        `è©²æŠ€è¡“çš„ç”¢æ¥­åŒ–éƒ¨ç½²æ¡ˆä¾‹è­‰æ˜äº†å…¶åœ¨${mainConcept}é ˜åŸŸçš„å•†æ¥­åƒ¹å€¼å’Œå¯¦ç”¨æ€§ã€‚`
      ];
    } else if (titleLower.includes('development') || titleLower.includes('ç™¼å±•') || titleLower.includes('è¶¨å‹¢')) {
      // ç™¼å±•è¶¨å‹¢é¡æ–‡ç» - æå–ç™¼å±•æ–¹å‘
      const futureYears = 3 + (titleHash % 4);
      const keyDirections = 2 + (titleHash % 3);
      
      return [
        `è©²ç ”ç©¶é æ¸¬${mainConcept}æŠ€è¡“åœ¨æœªä¾†${futureYears}å¹´å…§å°‡å¯¦ç¾é‡å¤§çªç ´ï¼Œç‰¹åˆ¥æ˜¯åœ¨ç®—æ³•å„ªåŒ–æ–¹é¢ã€‚`,
        `é€šéå°ç¾æœ‰æŠ€è¡“çš„æ·±å…¥åˆ†æï¼Œè©²æ–‡ç»æŒ‡å‡ºäº†${mainConcept}é ˜åŸŸçš„${keyDirections}å€‹é—œéµç™¼å±•æ–¹å‘ã€‚`,
        `è©²ç ”ç©¶ç‚º${mainConcept}æŠ€è¡“çš„æ¨™æº–åŒ–åˆ¶å®šæä¾›äº†é‡è¦çš„ç†è«–åŸºç¤å’Œå¯¦è¸æŒ‡å°ã€‚`
      ];
    } else if (titleLower.includes('challenge') || titleLower.includes('æŒ‘æˆ°') || titleLower.includes('å•é¡Œ')) {
      // æŒ‘æˆ°å•é¡Œé¡æ–‡ç» - æå–è§£æ±ºæ–¹æ¡ˆ
      const challengeCount = 2 + (titleHash % 3);
      
      return [
        `è©²ç ”ç©¶è­˜åˆ¥äº†${mainConcept}é ˜åŸŸé¢è‡¨çš„${challengeCount}å¤§æ ¸å¿ƒæŒ‘æˆ°ï¼Œä¸¦æå‡ºäº†å‰µæ–°çš„è§£æ±ºæ–¹æ¡ˆã€‚`,
        `é€šéç³»çµ±æ€§åˆ†æï¼Œè©²æ–‡ç»æ­ç¤ºäº†${mainConcept}æŠ€è¡“ç™¼å±•ä¸­çš„é—œéµç“¶é ¸å’Œçªç ´é»ã€‚`,
        `è©²ç ”ç©¶ç‚ºè§£æ±º${mainConcept}é ˜åŸŸçš„å¯¦éš›å•é¡Œæä¾›äº†å¯æ“ä½œçš„æŠ€è¡“è·¯å¾‘ã€‚`
      ];
    } else if (titleLower.includes('review') || titleLower.includes('ç¶œè¿°') || titleLower.includes('survey')) {
      // ç¶œè¿°é¡æ–‡ç» - æå–ç¸½çµè§€é»
      const reviewYears = 8 + (titleHash % 7);
      const paperCount = 120 + (titleHash % 80);
      
      return [
        `è©²ç¶œè¿°ç³»çµ±æ€§åœ°ç¸½çµäº†${mainConcept}é ˜åŸŸéå»${reviewYears}å¹´çš„é‡è¦é€²å±•å’Œé—œéµçªç ´ã€‚`,
        `é€šéå°${paperCount}å¤šç¯‡ç›¸é—œæ–‡ç»çš„åˆ†æï¼Œè©²ç ”ç©¶æ­ç¤ºäº†${mainConcept}æŠ€è¡“ç™¼å±•çš„æ•´é«”è„ˆçµ¡ã€‚`,
        `è©²ç¶œè¿°ç‚º${mainConcept}é ˜åŸŸçš„ç ”ç©¶è€…æä¾›äº†å…¨é¢çš„æŠ€è¡“ç¾ç‹€å’Œæœªä¾†ç™¼å±•åœ–æ™¯ã€‚`
      ];
    } else if (titleLower.includes('method') || titleLower.includes('æ–¹æ³•') || titleLower.includes('ç®—æ³•')) {
      // æ–¹æ³•ç®—æ³•é¡æ–‡ç» - æå–æŠ€è¡“ç´°ç¯€
      const accuracyGain = 22 + (titleHash % 18);
      const efficiencyGain = 30 + (titleHash % 25);
      
      return [
        `è©²ç ”ç©¶æå‡ºçš„æ–°æ–¹æ³•åœ¨${mainConcept}ç›¸é—œä»»å‹™ä¸­å¯¦ç¾äº†æº–ç¢ºç‡æå‡${accuracyGain}%ï¼Œè¨ˆç®—æ•ˆç‡æå‡${efficiencyGain}%ã€‚`,
        `é€šéå‰µæ–°çš„ç®—æ³•è¨­è¨ˆï¼Œè©²æ–¹æ³•æœ‰æ•ˆè§£æ±ºäº†${mainConcept}é ˜åŸŸé•·æœŸå­˜åœ¨çš„æŠ€è¡“é›£é¡Œã€‚`,
        `è©²æŠ€è¡“çš„é–‹æºå¯¦ç¾å’Œè©³ç´°å¯¦é©—å ±å‘Šç‚º${mainConcept}é ˜åŸŸçš„ç ”ç©¶æä¾›äº†å¯¶è²´è³‡æºã€‚`
      ];
    } else if (titleLower.includes('legal') || titleLower.includes('æ³•å¾‹') || titleLower.includes('ç›£ç®¡')) {
      // æ³•å¾‹ç›£ç®¡é¡æ–‡ç» - æå–æ³•å¾‹è§€é»
      return [
        `è©²ç ”ç©¶å¾æ³•å¾‹è§’åº¦æ·±å…¥åˆ†æäº†${mainConcept}æŠ€è¡“ç™¼å±•ä¸­çš„ç›£ç®¡æŒ‘æˆ°å’Œåˆè¦è¦æ±‚ã€‚`,
        `é€šéå°åœ‹éš›æ³•å¾‹æ¡†æ¶çš„æ¯”è¼ƒç ”ç©¶ï¼Œè©²æ–‡ç»æå‡ºäº†é©åˆæœ¬åœ°åŒ–çš„ç›£ç®¡å»ºè­°ã€‚`,
        `è©²ç ”ç©¶ç‚º${mainConcept}æŠ€è¡“çš„æ³•å¾‹é¢¨éšªè©•ä¼°å’Œåˆè¦ç®¡ç†æä¾›äº†å¯¦ç”¨æŒ‡å—ã€‚`
      ];
    } else if (titleLower.includes('industry') || titleLower.includes('ç”¢æ¥­') || titleLower.includes('å•†æ¥­')) {
      // ç”¢æ¥­å•†æ¥­é¡æ–‡ç» - æå–å•†æ¥­åƒ¹å€¼
      const marketSize = 100 + (titleHash % 200);
      return [
        `è©²ç ”ç©¶åˆ†æäº†${mainConcept}æŠ€è¡“åœ¨ç”¢æ¥­æ‡‰ç”¨ä¸­çš„å¸‚å ´æ½›åŠ›ï¼Œé è¨ˆå¸‚å ´è¦æ¨¡å°‡é”åˆ°${marketSize}å„„ç¾å…ƒã€‚`,
        `é€šéå°å¤šå€‹è¡Œæ¥­æ¡ˆä¾‹çš„ç ”ç©¶ï¼Œè©²æ–‡ç»æ­ç¤ºäº†${mainConcept}æŠ€è¡“çš„å•†æ¥­åŒ–è·¯å¾‘ã€‚`,
        `è©²ç ”ç©¶ç‚ºä¼æ¥­åœ¨${mainConcept}é ˜åŸŸçš„æŠ•è³‡æ±ºç­–å’Œæˆ°ç•¥è¦åŠƒæä¾›äº†é‡è¦åƒè€ƒã€‚`
      ];
    } else {
      // é€šç”¨é¡æ–‡ç» - æ ¹æ“šæ¨™é¡Œç‰¹é»ç”Ÿæˆå¯¦ç”¨å¥å­
      const titleWords = title.split(' ').filter((word: string) => word.length > 3);
      const relevantWord = titleWords.length > 0 ? titleWords[0] : mainConcept;
      const improvement = 18 + (titleHash % 22);
      
      return [
        `è©²ç ”ç©¶åœ¨${relevantWord}é ˜åŸŸçš„å¯¦é©—çµæœé¡¯ç¤ºï¼Œæ–°æ–¹æ³•ç›¸æ¯”å‚³çµ±æ–¹æ³•åœ¨æº–ç¢ºæ€§ä¸Šæå‡äº†${improvement}%ã€‚`,
        `é€šéæ·±å…¥çš„ç†è«–åˆ†æï¼Œè©²ç ”ç©¶ç‚º${relevantWord}æŠ€è¡“çš„å¯¦éš›æ‡‰ç”¨æä¾›äº†é‡è¦çš„æŒ‡å°åŸå‰‡ã€‚`,
        `è©²æ–‡ç»çš„å¯¦é©—è¨­è¨ˆå’Œæ•¸æ“šåˆ†æç‚º${relevantWord}é ˜åŸŸçš„å¾ŒçºŒç ”ç©¶æ¨¹ç«‹äº†é«˜æ¨™æº–ã€‚`
      ];
    }
    
    // æ ¹æ“šç”¨æˆ¶è¨­ç½®ç”Ÿæˆç›¸æ‡‰èªè¨€çš„é—œéµå¥å­
    if (settings && settings.language === 'en') {
      // ç”Ÿæˆè‹±æ–‡é—œéµå¥å­
      const englishKeySentences: { [key: number]: string[] } = {
        1: [
          `The experimental results in ${mainConcept} development show that the new method improved accuracy by ${20 + (titleHash % 15)}% compared to traditional approaches.`,
          `Through in-depth theoretical analysis, this research provides important guiding principles for the practical application of ${mainConcept} technology.`,
          `The experimental design and data analysis in this study set high standards for subsequent research in the ${mainConcept} field.`
        ],
        2: [
          `This study demonstrates significant advances in ${mainConcept} algorithms, with performance improvements of ${25 + (titleHash % 20)}% in computational efficiency.`,
          `The research provides comprehensive insights into ${mainConcept} architectures, contributing to our understanding of neural network optimization.`,
          `Experimental validation shows that the ${mainConcept} approach achieves superior stability and reliability in real-world applications.`
        ],
        3: [
          `The study presents successful ${mainConcept} implementations across multiple industries, demonstrating substantial commercial value and practical benefits.`,
          `Real-world case studies show that ${mainConcept} technology can achieve ${30 + (titleHash % 25)}% improvement in operational efficiency.`,
          `The research highlights the transformative potential of ${mainConcept} applications in modern business environments.`
        ]
      };
      
      const englishTemplates = englishKeySentences[pointId] || englishKeySentences[1];
      const selectedEnglishTemplate = englishTemplates[titleHash % englishTemplates.length];
      return [selectedEnglishTemplate];
    }
    
    // å¦‚æœæ²’æœ‰åŒ¹é…åˆ°ç‰¹å®šé¡å‹ï¼Œè¿”å›åŸºæ–¼å¤§ç¶±é»çš„æ¨¡æ¿
    return [selectedTemplate];
  };

  // æ–°å¢ï¼šæ·»åŠ åƒè€ƒæ–‡ç»åˆ°å¤§ç¶±é»
  const addReferenceToPoint = async (pointId: number, reference: Reference) => {
    // è‡ªåŠ¨æ£€æŸ¥æ–‡çŒ®åº“ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„PDFæ–‡ä»¶
    try {
      const response = await fetch('/api/reference-library');
      if (response.ok) {
        const library = await response.json();
        const libraryEntry = library.find((entry: any) => 
          entry.title.toLowerCase().includes(reference.title.toLowerCase()) ||
          reference.title.toLowerCase().includes(entry.title.toLowerCase())
        );
        
        if (libraryEntry) {
          console.log(`ğŸ“„ è‡ªåŠ¨æ‰¾åˆ°PDFæ–‡ä»¶: ${reference.title} - ${libraryEntry.fileName}`);
          // è‡ªåŠ¨æ·»åŠ PDFä¿¡æ¯åˆ°å‚è€ƒæ–‡çŒ®
          reference = {
            ...reference,
            fileUrl: libraryEntry.fileUrl,
            fileName: libraryEntry.fileName,
            fileSize: libraryEntry.fileSize
          };
        } else {
          console.log(`ğŸ“„ æ–‡çŒ®åº“ä¸­æœªæ‰¾åˆ°PDFæ–‡ä»¶: ${reference.title}`);
        }
      }
    } catch (error) {
      console.log('è·å–æ–‡çŒ®åº“ä¿¡æ¯å¤±è´¥:', error);
    }
    
    setOutlinePoints(prev => prev.map(point => 
      point.id === pointId 
        ? { ...point, references: [...point.references, reference] } : point
    ));
    setSelectedReferences(prev => [...prev, reference]);
  };

  // æ–°å¢ï¼šæ‰‹å‹•è¼¸å…¥åƒè€ƒæ–‡ç»
  const [manualReference, setManualReference] = useState<Omit<Reference, 'id'>>({
    title: '',
    authors: '',
    source: '',
    year: 0,
    summary: '',
    keySentences: [''],
    citation: ''
  });

  // æ•°æ®æŒä¹…åŒ–åŠŸèƒ½
  const saveToLocalStorage = () => {
    try {
      const dataToSave = {
        outlinePoints,
        searchKeywords,
        selectedReferences,
        form,
        activeTab,
        mode,
        isSearching,
        selectedBulletPoint,
        manualInputExpanded,
        searchResults
      };
      localStorage.setItem('assignment-terminator-data', JSON.stringify(dataToSave));
      console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ°localStorage');
    } catch (error) {
      console.error('âŒ ä¿å­˜æ•°æ®åˆ°localStorageå¤±è´¥:', error);
    }
  };

  const loadFromLocalStorage = () => {
    try {
      const savedData = localStorage.getItem('assignment-terminator-data');
      if (savedData) {
        const parsedData = JSON.parse(savedData);
        if (parsedData.outlinePoints) setOutlinePoints(parsedData.outlinePoints);
        if (parsedData.searchKeywords) setSearchKeywords(parsedData.searchKeywords);
        if (parsedData.selectedReferences) setSelectedReferences(parsedData.selectedReferences);
        if (parsedData.form) setForm(parsedData.form);
        if (parsedData.activeTab) setActiveTab(parsedData.activeTab);
        if (parsedData.mode) setMode(parsedData.mode);
        if (parsedData.selectedBulletPoint) setSelectedBulletPoint(parsedData.selectedBulletPoint);
        if (parsedData.manualInputExpanded) setManualInputExpanded(parsedData.manualInputExpanded);
        if (parsedData.searchResults) setSearchResults(parsedData.searchResults);
        console.log('âœ… æ•°æ®å·²ä»localStorageåŠ è½½');
      }
    } catch (error) {
      console.error('âŒ ä»localStorageåŠ è½½æ•°æ®å¤±è´¥:', error);
    }
  };

  const addManualReference = async (pointId: number) => {
    if (!manualReference.title.trim()) {
      alert('è«‹å¡«å¯«åƒè€ƒæ–‡ç»æ¨™é¡Œ');
      return;
    }
    
    const newReference: Reference = {
      id: `manual-${Date.now()}`,
      title: manualReference.title,
      authors: manualReference.authors,
      source: manualReference.source,
      year: manualReference.year || new Date().getFullYear(),
      summary: manualReference.summary,
      keySentences: manualReference.keySentences.filter(s => s.trim()),
      citation: manualReference.citation
    };
    
    await addReferenceToPoint(pointId, newReference);
    
    // æ¸…ç©ºæ‰‹å‹•è¼¸å…¥
    setManualReference({
      title: '',
      authors: '',
      source: '',
      year: 0,
      summary: '',
      keySentences: [''],
      citation: ''
    });
  };

  // æ–°å¢ï¼šæ‰‹å‹•æ·»åŠ æ–‡ç»çš„å±•é–‹/æ”¶ç¸®ç‹€æ…‹
  const [manualInputExpanded, setManualInputExpanded] = useState<{ [key: number]: boolean }>({});

  // æ•°æ®æŒä¹…åŒ–ï¼šåŠ è½½æ•°æ®
  useEffect(() => {
    loadFromLocalStorage();
  }, []);

  // æ•°æ®æŒä¹…åŒ–ï¼šä¿å­˜æ•°æ®
  useEffect(() => {
    // å»¶è¿Ÿä¿å­˜ï¼Œé¿å…é¢‘ç¹ä¿å­˜
    const timeoutId = setTimeout(() => {
      saveToLocalStorage();
    }, 1000);

    return () => clearTimeout(timeoutId);
  }, [outlinePoints, searchKeywords, selectedReferences, form, activeTab, mode, selectedBulletPoint, manualInputExpanded, searchResults]);

  // åˆ‡æ›æ‰‹å‹•è¼¸å…¥çš„å±•é–‹/æ”¶ç¸®ç‹€æ…‹
  const toggleManualInput = (pointId: number) => {
    setManualInputExpanded(prev => ({
      ...prev,
      [pointId]: !prev[pointId]
    }));
  };

  // æ–°å¢ï¼šæª¢æŸ¥ç·¨è¼¯æ¨¡å¼ç”Ÿæˆçš„å¤§ç¶±å…§å®¹æ˜¯å¦è©³ç´°
  const checkOutlineDetail = () => {
    const hasDetailedContent = outlinePoints.every(point => 
      point.content && point.content.length > 50 && 
      point.bulletPoints && point.bulletPoints.length >= 3
    );
    
    if (!hasDetailedContent) {
      console.warn('å¤§ç¶±å…§å®¹ä¸å¤ è©³ç´°ï¼Œå»ºè­°é‡æ–°ç”Ÿæˆ');
    }
    
    return hasDetailedContent;
  };

  const handleGenerateOutline = async () => {
    if (!form.title.trim()) {
      alert('è«‹å…ˆå¡«å¯«è«–æ–‡æ¨™é¡Œ');
      return;
    }

    setIsGenerating(true);
    try {
      const response = await fetch('/api/outline', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: form.title,
          wordCount: form.totalWords,
          language: form.language,
          tone: form.tone,
          detail: form.detail,
          reference: '', // æš«æ™‚è¨­ç‚ºç©ºå­—ä¸²
          rubric: form.rubric,
          paragraph: form.bodyCount || 3,
          mode: selectedModel
        }),
      });

      if (response.ok) {
        const data = await response.json();
        console.log('APIå“åº”æ•°æ®:', data);
        
        // APIè¿”å›çš„æ˜¯å­—ç¬¦ä¸²æ ¼å¼çš„outline
        if (data.outline) {
          setGeneratedContent(data.outline);
          console.log('å·²æ›´æ–°å¤§ç¶±å…§å®¹:', data.outline);
          console.log('generatedContentçŠ¶æ€å·²æ›´æ–°');
        } else {
          console.log('APIå“åº”ä¸­æ²¡æœ‰outlineå­—æ®µ');
        }
        
        setActiveTab('outline');
        console.log('å·²åˆ‡æ¢åˆ°outlineæ ‡ç­¾é¡µ');
        console.log('å½“å‰activeTab:', activeTab);
        console.log('å½“å‰mode:', mode);
      } else {
        const errorData = await response.json();
        alert(`ç”Ÿæˆå¤±æ•—: ${errorData.error || 'æœªçŸ¥éŒ¯èª¤'}`);
      }
    } catch (error) {
      console.error('ç”Ÿæˆå¤§ç¶±æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      alert('ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-700" style={{ background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%)', backgroundAttachment: 'fixed' }}>
      <TopNavigation />
      
      <div className="pt-16 px-6" style={{ background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%)', backgroundAttachment: 'fixed' }}>
        <div className="flex" style={{ background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%)', backgroundAttachment: 'fixed' }}>
          {/* -------- å·¦ï¼šåŠŸèª²è¨­å®š -------- */}
          <div className="w-96 border-r border-slate-600 p-4 bg-slate-800 min-h-screen overflow-y-auto">
            <div className="bg-slate-700 rounded-lg shadow-lg p-4">
              <div className="flex items-center justify-between mb-4">
                <h2 className="font-bold text-lg bg-gradient-to-r from-amber-400 to-yellow-300 bg-clip-text text-transparent">åŠŸèª²è¨­å®š</h2>
                <button
                  onClick={() => setForm(prev => ({ ...prev, settingsExpanded: !prev.settingsExpanded }))}
                  className="text-white bg-slate-600 border-2 border-slate-400 rounded px-3 py-1 hover:bg-slate-500 hover:border-slate-300 transition-colors shadow-lg"
                >
                  {form.settingsExpanded ? 'æ”¶èµ·' : 'å±•é–‹'}
                </button>
              </div>
              
              {form.settingsExpanded && (
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-1">è«–æ–‡æ¨™é¡Œ</label>
                    <input
                      type="text"
                      placeholder="è«‹è¼¸å…¥è«–æ–‡æ¨™é¡Œ"
                      className="w-full border border-slate-500 rounded-lg px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white"
                      value={form.title}
                      onChange={(e) => setForm({ ...form, title: e.target.value })}
                    />
                  </div>

                  {/* æ®µè½è¦åŠƒå™¨ - é‡æ–°è¨­è¨ˆ */}
                  <div className="bg-slate-600 rounded-lg p-3 border border-slate-500">
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="font-bold text-base text-white">ğŸ§­ æ®µè½è¦åŠƒå™¨</h3>
                      <button
                        onClick={() => setForm({ ...form, plannerExpanded: !form.plannerExpanded })}
                        className="text-white bg-slate-600 border-2 border-slate-400 rounded px-2 py-1 hover:bg-slate-500 hover:border-slate-300 transition-colors shadow-lg"
                      >
                        {form.plannerExpanded ? 'æ”¶èµ·' : 'å±•é–‹'}
                      </button>
                    </div>
                    
                    {!form.plannerExpanded ? (
                      // æ”¶èµ·ç‹€æ…‹ - é¡¯ç¤ºæ‘˜è¦
                      <div className="text-center text-sm text-slate-300">
                        <div className="grid grid-cols-3 gap-2 text-xs">
                          <div>å¼•è¨€: {form.introWords || 140}å­—</div>
                          <div>ä¸»é«”: {form.bodyCount || 3}æ®µ</div>
                          <div>çµè«–: {form.conclusionWords || 140}å­—</div>
                        </div>
                        <div className="mt-1 flex items-center justify-between">
                          <span>ç¸½è¨ˆ: {form.totalWords || 1000}å­—</span>
                          <input
                            type="number"
                            min="500"
                            max="5000"
                            step="100"
                            value={form.totalWords || 1000}
                            onChange={(e) => setForm(prev => ({ ...prev, totalWords: parseInt(e.target.value) || 1000 }))}
                            className="w-16 px-1 py-1 text-xs bg-slate-600 border border-slate-500 rounded text-white"
                            title="è®¾ç½®æ€»å­—æ•°"
                          />
                        </div>
                      </div>
                    ) : (
                      // å±•é–‹ç‹€æ…‹ - é¡¯ç¤ºè©³ç´°é¸é …
                      <div className="space-y-3">
                        {/* å¼•è¨€å­—æ•¸ */}
                        <div>
                          <label className="block text-xs font-medium text-slate-300 mb-1">å¼•è¨€å­—æ•¸</label>
                          <input
                            type="number"
                            value={form.introWords || 140}
                            className="w-full border border-slate-500 rounded-lg px-2 py-1 text-center text-xs bg-slate-600 text-white"
                            onChange={(e) => setForm({ ...form, introWords: parseInt(e.target.value) || 140 })}
                          />
                        </div>
                        
                        {/* ä¸»é«”æ•¸é‡ */}
                        <div>
                          <label className="block text-xs font-medium text-slate-300 mb-1">ä¸»é«”æ•¸é‡</label>
                          <select 
                            className="w-full border border-slate-500 rounded-lg px-2 py-1 text-xs focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white"
                            value={form.bodyCount || 3}
                            onChange={(e) => setForm({ ...form, bodyCount: parseInt(e.target.value) || 3 })}
                          >
                            <option value="2">2æ®µ</option>
                            <option value="3">3æ®µ</option>
                            <option value="4">4æ®µ</option>
                            <option value="5">5æ®µ</option>
                          </select>
                        </div>
                        
                        {/* å‹•æ…‹ç”Ÿæˆä¸»é«”æ®µè½è¨­ç½® */}
                        {Array.from({ length: form.bodyCount || 3 }, (_, index) => (
                          <div key={index} className="border border-slate-500 rounded-lg p-2 bg-slate-600">
                            <div className="text-xs font-medium text-white mb-1">ä¸»é«”{index + 1}</div>
                            <div className="grid grid-cols-2 gap-2 mb-2">
                              <div>
                                <label className="block text-xs text-slate-300 mb-1">å­—æ•¸</label>
                                <input
                                  type="number"
                                  value={form.bodyWords?.[index] || 240}
                                  className="w-full border border-slate-500 rounded-lg px-2 py-1 text-center text-xs bg-slate-600 text-white"
                                  onChange={(e) => {
                                    const newBodyWords = [...(form.bodyWords || [240, 240, 240])];
                                    newBodyWords[index] = parseInt(e.target.value) || 240;
                                    setForm({ ...form, bodyWords: newBodyWords });
                                  }}
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-slate-300 mb-1">å¤§è‡´å…§å®¹</label>
                                <input
                                  type="text"
                                  placeholder="æè¿°å…§å®¹..."
                                  value={form.bodyContent?.[index] || ''}
                                  className="w-full border border-slate-500 rounded-lg px-2 py-1 text-xs bg-slate-600 text-white"
                                  onChange={(e) => {
                                    const newBodyContent = [...(form.bodyContent || ['', '', ''])];
                                    newBodyContent[index] = e.target.value;
                                    setForm({ ...form, bodyContent: newBodyContent });
                                  }}
                                />
                              </div>
                            </div>
                          </div>
                        ))}
                        
                        {/* çµè«–å­—æ•¸ */}
                        <div>
                          <label className="block text-xs font-medium text-slate-300 mb-1">çµè«–å­—æ•¸</label>
                          <input
                            type="number"
                            value={form.conclusionWords || 140}
                            className="w-full border border-slate-500 rounded-lg px-2 py-1 text-center text-xs bg-slate-600 text-white"
                            onChange={(e) => setForm({ ...form, conclusionWords: parseInt(e.target.value) || 140 })}
                          />
                        </div>
                        
                        <div className="text-center text-xs text-slate-300">
                          ç¸½è¨ˆ: {form.totalWords || 1000}å­—
                        </div>
                      </div>
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-1">å…§å®¹ç´°ç¯€</label>
                    <div className="flex space-x-2">
                      <textarea
                        placeholder="è«‹è©³ç´°æè¿°æ‚¨çš„ä½œæ¥­è¦æ±‚..."
                        className="flex-1 border border-slate-500 rounded-lg px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-400 min-h-[80px] resize-none bg-slate-600 text-white"
                        value={form.detail}
                        onChange={(e) => setForm({ ...form, detail: e.target.value })}
                      />
                      <button className="px-3 py-2 bg-slate-600 text-white border-2 border-slate-400 rounded-lg hover:bg-slate-500 hover:border-slate-300 transition-colors flex items-center space-x-1 text-sm shadow-lg">
                        <span>ğŸ“„</span>
                        <span>PDF</span>
                      </button>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-1">è©•åˆ†æ¨™æº–</label>
                    <div className="flex space-x-2">
                      <input
                        type="text"
                        placeholder="è«‹è¼¸å…¥è©•åˆ†æ¨™æº–"
                        className="flex-1 border border-slate-500 rounded-lg px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white"
                        value={form.rubric}
                        onChange={(e) => setForm({ ...form, rubric: e.target.value })}
                      />
                      <button className="px-3 py-2 bg-slate-600 text-white border-2 border-slate-400 rounded-lg hover:bg-slate-500 hover:border-slate-300 transition-colors flex items-center space-x-1 text-sm shadow-lg">
                        <span>ğŸ“„</span>
                        <span>PDF</span>
                      </button>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium text-slate-300 mb-1">èªè¨€</label>
                      <select
                        value={form.language}
                        className="w-full border border-slate-500 rounded-lg px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white"
                        onChange={(e) => setForm({ ...form, language: e.target.value })}
                      >
                        <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                        <option value="è‹±æ–‡">è‹±æ–‡</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-300 mb-1">èªæ°£</label>
                      <select
                        value={form.tone}
                        className="w-full border border-slate-500 rounded-lg px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white"
                        onChange={(e) => setForm({ ...form, tone: e.target.value })}
                      >
                        <option value="æ­£å¼">æ­£å¼</option>
                        <option value="åŠæ­£å¼">åŠæ­£å¼</option>
                        <option value="è¼•é¬†">è¼•é¬†</option>
                      </select>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* -------- AI åŠŸèƒ½ -------- */}
            <div className="bg-slate-700 rounded-lg shadow-lg p-4 mt-4">
              <h3 className="font-bold text-base bg-gradient-to-r from-amber-400 to-yellow-300 bg-clip-text text-transparent mb-4">AI åŠŸèƒ½</h3>
              
              <div className="space-y-2">
                <div>
                  <select 
                    value={selectedModel}
                    onChange={(e) => setSelectedModel(e.target.value)}
                    className="w-full border border-slate-500 rounded-lg px-2 py-1 text-sm mb-1 focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white"
                  >
                    <option value="gpt-4o">GPT-4o (æ¨è - æ€§ä»·æ¯”æœ€é«˜)</option>
                    <option value="claude-3.5">Claude 3.5 Sonnet (é¡¶çº§è´¨é‡)</option>
                    <option value="gpt-4">GPT-4 Turbo (é«˜è´¨é‡é•¿æ–‡æœ¬)</option>
                    <option value="deepseek-r1">DeepSeek R1 (æ·±åº¦æ¨ç†)</option>
                    <option value="llama-405b">Llama 3.1 405B (å¼€æºé«˜è´¨é‡)</option>
                    <option value="gemini-flash">Gemini 2.5 Flash (å¿«é€Ÿç»æµ)</option>
                    <option value="gpt-3.5">GPT-3.5 Turbo (æœ€ç»æµ)</option>
                  </select>
                  <button 
                    onClick={handleGenerateOutline}
                    disabled={isGenerating}
                    className={`w-full py-2 px-3 rounded-lg transition-all text-sm shadow-lg border ${
                      isGenerating
                        ? 'bg-slate-400 text-slate-200 cursor-not-allowed'
                        : 'bg-gradient-to-r from-slate-500 to-slate-600 text-white hover:from-slate-400 hover:to-slate-500 border-slate-400'
                    }`}
                  >
                    {isGenerating ? 'ğŸ”„ ç”Ÿæˆä¸­...' : 'ğŸ§  ç”¢ç”Ÿå¤§ç¶±'}
                  </button>
                </div>
                <div>
                  <select 
                    value={selectedModel}
                    onChange={(e) => setSelectedModel(e.target.value)}
                    className="w-full border border-slate-500 rounded-lg px-2 py-1 text-sm mb-1 focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white"
                  >
                    <option value="gpt-4o">GPT-4o (æ¨è - æ€§ä»·æ¯”æœ€é«˜)</option>
                    <option value="claude-3.5">Claude 3.5 Sonnet (é¡¶çº§è´¨é‡)</option>
                    <option value="gpt-4">GPT-4 Turbo (é«˜è´¨é‡é•¿æ–‡æœ¬)</option>
                    <option value="deepseek-r1">DeepSeek R1 (æ·±åº¦æ¨ç†)</option>
                    <option value="llama-405b">Llama 3.1 405B (å¼€æºé«˜è´¨é‡)</option>
                    <option value="gemini-flash">Gemini 2.5 Flash (å¿«é€Ÿç»æµ)</option>
                    <option value="gpt-3.5">GPT-3.5 Turbo (æœ€ç»æµ)</option>
                  </select>
                  <button 
                    onClick={() => handleGenerateDraft('full')}
                    disabled={isGenerating}
                    className="w-full bg-gradient-to-r from-slate-500 to-slate-600 text-white py-2 px-3 rounded-lg hover:from-slate-400 hover:to-slate-500 transition-all text-sm shadow-lg border border-slate-400 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {isGenerating ? 'âœï¸ ç”Ÿæˆä¸­...' : 'âœï¸ è‰ç¨¿ç”¢ç”Ÿ'}
                  </button>
                </div>
                <div>
                  <select className="w-full border border-slate-500 rounded-lg px-2 py-1 text-sm mb-1 focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white">
                    <option>ChatGPT 3.5 (0 é»)</option>
                    <option>Gemini Flash (3 é»)</option>
                  </select>
                  <button className="w-full bg-gradient-to-r from-slate-500 to-slate-600 text-white py-2 px-3 rounded-lg hover:from-slate-400 hover:to-slate-500 transition-all text-sm shadow-lg border border-slate-400">
                    ğŸ§‘â€ğŸ« æ•™å¸«è©•è«–
                  </button>
                </div>
                <div>
                  <select className="w-full border border-slate-500 rounded-lg px-2 py-1 text-sm mb-1 focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white">
                    <option>ChatGPT 3.5 (0 é»)</option>
                    <option>Gemini Flash (5 é»)</option>
                  </select>
                  <button className="w-full bg-gradient-to-r from-slate-500 to-slate-600 text-white py-2 px-3 rounded-lg hover:from-slate-400 hover:to-slate-500 transition-all text-sm shadow-lg border border-slate-400">
                    ğŸ“ GPT-style ä¿®è¨‚
                  </button>
                </div>
                <div>
                  <select className="w-full border border-slate-500 rounded-lg px-2 py-1 text-sm mb-1 focus:border-blue-400 focus:ring-blue-400 bg-slate-600 text-white">
                    <option>ChatGPT 3.5 (0 é»)</option>
                    <option>Gemini Flash (5 é»)</option>
                  </select>
                  <button className="w-full bg-gradient-to-r from-slate-500 to-slate-600 text-white py-2 px-3 rounded-lg hover:from-slate-400 hover:to-slate-500 transition-all text-sm shadow-lg border border-slate-400">
                    ğŸ¤– æœ€çµ‚äººæ€§åŒ–å„ªåŒ–
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* -------- å³ï¼šå¤§ç¶±ç”¢ç”Ÿå™¨çµæœ -------- */}
          <div className="flex-1 overflow-y-auto p-6 bg-slate-800 min-h-screen">
            <div className="bg-slate-700 rounded-lg shadow-sm p-6 border border-slate-600">
              <h2 className="text-xl font-bold mb-4 text-white">ğŸ“ æ–‡å­—ç”¢ç”Ÿå€</h2>
              
              <div className="mb-4">
                <div className="flex space-x-2 mb-4">
                  <button 
                    className={`px-4 py-2 rounded-lg border transition-all ${
                      activeTab === 'outline' 
                        ? 'bg-slate-600 text-white border-slate-500' 
                        : 'bg-slate-700 text-slate-300 border-slate-600 hover:bg-slate-600'
                    }`}
                    onClick={() => setActiveTab('outline')}
                  >
                    ğŸ“‘ å¤§ç¶±ç”¢ç”Ÿå™¨
                  </button>
                  <button 
                    className={`px-4 py-2 rounded-lg border transition-all ${
                      activeTab === 'draft' 
                        ? 'bg-slate-600 text-white border-slate-500' 
                        : 'bg-slate-700 text-slate-300 border-slate-600 hover:bg-slate-600'
                    }`}
                    onClick={() => setActiveTab('draft')}
                  >
                    âœï¸ åˆç¨¿
                  </button>
                  <button 
                    className={`px-4 py-2 rounded-lg border transition-all ${
                      activeTab === 'review' 
                        ? 'bg-slate-600 text-white border-slate-500' 
                        : 'bg-slate-700 text-slate-300 border-slate-600 hover:bg-slate-600'
                    }`}
                    onClick={() => setActiveTab('review')}
                  >
                    ğŸ§‘â€ğŸ« æ•™å¸«è©•è«–
                  </button>
                  <button 
                    className={`px-4 py-2 rounded-lg border transition-all ${
                      activeTab === 'revision' 
                        ? 'bg-slate-600 text-white border-slate-500' 
                        : 'bg-slate-700 text-slate-300 border-slate-600 hover:bg-slate-600'
                    }`}
                    onClick={() => setActiveTab('revision')}
                  >
                    ğŸ“ ä¿®è¨‚ç¨¿
                  </button>
                  <button 
                    className={`px-4 py-2 rounded-lg border transition-all ${
                      activeTab === 'final' 
                        ? 'bg-slate-600 text-white border-slate-500' 
                        : 'bg-slate-700 text-slate-300 border-slate-600 hover:bg-slate-600'
                    }`}
                    onClick={() => setActiveTab('final')}
                  >
                    ğŸ¤– æœ€çµ‚ç‰ˆæœ¬
                  </button>
                </div>
              </div>

              <div className="mb-4">
                <div className="flex items-center space-x-4 mb-2">
                  <label className="block text-sm font-medium text-white">
                    {activeTab === 'outline' && 'å¤§ç¶±ç”¢ç”Ÿå™¨ :'}
                    {activeTab === 'draft' && 'åˆç¨¿ç”¢ç”Ÿ :'}
                    {activeTab === 'review' && 'æ•™å¸«è©•è«– :'}
                    {activeTab === 'revision' && 'ä¿®è¨‚ç¨¿ :'}
                    {activeTab === 'final' && 'æœ€çµ‚ç‰ˆæœ¬ :'}
                  </label>
                  <button
                    onClick={() => toggleLock(activeTab)}
                    className={`px-3 py-1 rounded-lg text-sm transition-all ${
                      isCurrentTabLocked 
                        ? 'bg-slate-600 text-white hover:bg-slate-700' 
                        : 'bg-slate-500 text-white hover:bg-slate-600'
                    }`}
                  >
                    {isCurrentTabLocked ? 'ğŸ”’ å·²é–å®š' : 'ğŸ”“ æœªé–å®š'}
                  </button>
                </div>
                
                {/* æ¨¡å¼é¸æ“‡ */}
                {activeTab === 'outline' ? (
                  <div className="flex space-x-4">
                    <label className="flex items-center">
                      <input
                        type="radio"
                        name="mode"
                        value="edit"
                        checked={mode === 'edit'}
                        onChange={(e) => setMode(e.target.value)}
                        disabled={isCurrentTabLocked}
                        className="mr-2"
                      />
                      <span className={`${isCurrentTabLocked ? 'text-slate-500' : 'text-white'}`}>ç·¨è¼¯æ¨¡å¼</span>
                    </label>
                    <label className="flex items-center">
                      <input
                        type="radio"
                        name="mode"
                        value="search"
                        checked={mode === 'search'}
                        onChange={(e) => setMode(e.target.value)}
                        disabled={isCurrentTabLocked}
                        className="mr-2"
                      />
                      <span className={`${isCurrentTabLocked ? 'text-slate-500' : 'text-white'}`}>æ–‡ç»æœå°‹æ¨¡å¼</span>
                    </label>
                  </div>
                ) : (
                  <div className="flex space-x-4">
                    <label className="flex items-center">
                      <input
                        type="radio"
                        name="mode"
                        value="edit"
                        checked={true}
                        disabled={true}
                        className="mr-2"
                      />
                      <span className="text-slate-400">ç·¨è¼¯æ¨¡å¼</span>
                    </label>
                  </div>
                )}
              </div>

              {/* å¤§ç¶±ç”¢ç”Ÿå™¨ - æ ¹æ“šæ¨¡å¼é¡¯ç¤ºä¸åŒå…§å®¹ */}
              {activeTab === 'outline' && mode === 'edit' && (
                <div className="space-y-6">
                    {outlinePoints.map((point) => (
                      <div key={point.id} className="p-4 bg-slate-700 rounded-lg border border-slate-600">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <h4 className="text-lg font-medium text-white">{point.id}. {point.title}</h4>
                            <textarea
                              value={point.content}
                              onChange={(e) => {
                                setOutlinePoints(prev => prev.map(p => 
                                  p.id === point.id ? { ...p, content: e.target.value } : p
                                ));
                              }}
                              className="w-full mt-2 px-3 py-2 bg-slate-600 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400"
                              rows={3}
                              placeholder="åœ¨é€™è£¡ç·¨è¼¯å¤§ç¶±é»å…§å®¹..."
                            />
                            
                            {/* è©³ç´°çš„bullet points - ç·¨è¼¯æ¨¡å¼ä¹Ÿæ‡‰è©²é¡¯ç¤º */}
                            <div className="mt-3 p-3 bg-slate-600 rounded border border-slate-500">
                              <h5 className="text-sm font-medium text-white mb-2">ğŸ“ è©³ç´°è¦é»</h5>
                              <div className="space-y-2">
                                {point.bulletPoints.map((bullet, idx) => (
                                  <div key={idx} className="flex items-start">
                                    <span className="text-slate-400 text-xs mr-2 mt-1">â€¢</span>
                                    <textarea
                                      value={bullet}
                                      onChange={(e) => {
                                        const newBulletPoints = [...point.bulletPoints];
                                        newBulletPoints[idx] = e.target.value;
                                        setOutlinePoints(prev => prev.map(p => 
                                          p.id === point.id ? { ...p, bulletPoints: newBulletPoints } : p
                                        ));
                                      }}
                                      className="flex-1 px-2 py-1 bg-slate-700 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400 text-xs"
                                      rows={1}
                                      placeholder="ç·¨è¼¯è©³ç´°è¦é»..."
                                    />
                                    <button
                                      onClick={() => {
                                        // åˆ é™¤bullet point
                                        const newBulletPoints = point.bulletPoints.filter((_, i) => i !== idx);
                                        setOutlinePoints(prev => prev.map(p => 
                                          p.id === point.id ? { ...p, bulletPoints: newBulletPoints } : p
                                        ));
                                      }}
                                      className="ml-2 px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors"
                                      title="åˆ é™¤æ­¤è¦ç‚¹"
                                    >
                                      âœ•
                                    </button>
                                  </div>
                                ))}
                                
                                {/* æ·»åŠ æ–°è¯¦ç»†è¦ç‚¹æŒ‰é’® */}
                                <div className="mt-3 pt-2 border-t border-slate-500">
                                  <button
                                    onClick={() => {
                                      // æ·»åŠ æ–°çš„bullet point
                                      const newBulletPoint = 'æ–°çš„è¯¦ç»†è¦ç‚¹';
                                      setOutlinePoints(prev => prev.map(p => 
                                        p.id === point.id 
                                          ? { ...p, bulletPoints: [...p.bulletPoints, newBulletPoint] }
                                          : p
                                      ));
                                    }}
                                    className="flex items-center px-3 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors"
                                  >
                                    <span className="mr-2">â•</span>
                                    æ·»åŠ è¯¦ç»†è¦ç‚¹
                                  </button>
                                </div>
                              </div>
                            </div>
                            
                            <p className="text-slate-400 text-xs mt-2">å­—æ•¸ï¼š{point.wordCount}å­—</p>
                            
                            {/* æ˜¾ç¤ºç”Ÿæˆçš„æ®µè½å†…å®¹ */}
                            {draftSections[point.id] && (
                              <div className="mt-3 p-3 bg-slate-800 rounded border border-slate-500">
                                <h5 className="text-sm font-medium text-green-300 mb-2">âœ¨ å·²ç”Ÿæˆå†…å®¹</h5>
                                <div className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">
                                  {draftSections[point.id]}
                          </div>
                                <div className="mt-2 flex gap-2">
                                  <button
                                    onClick={() => {
                                      const newContent = prompt('ç¼–è¾‘ç”Ÿæˆçš„å†…å®¹:', draftSections[point.id]);
                                      if (newContent !== null) {
                                        setDraftSections(prev => ({
                                          ...prev,
                                          [point.id]: newContent
                                        }));
                                      }
                                    }}
                                    className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                  >
                                    âœï¸ ç¼–è¾‘
                                  </button>
                                  <button
                                    onClick={() => {
                                      setDraftSections(prev => {
                                        const newSections = { ...prev };
                                        delete newSections[point.id];
                                        return newSections;
                                      });
                                    }}
                                    className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors"
                                  >
                                    ğŸ—‘ï¸ åˆ é™¤
                                  </button>
                        </div>
                              </div>
                            )}
                            
                            {/* ç”ŸæˆçŠ¶æ€æŒ‡ç¤ºå™¨ */}
                            {currentGeneratingSection === point.id && (
                              <div className="mt-3 p-2 bg-blue-900 rounded border border-blue-500">
                                <div className="flex items-center text-blue-300 text-sm">
                                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-300 mr-2"></div>
                                  æ­£åœ¨ç”Ÿæˆç¬¬{point.id}æ®µå†…å®¹...
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* åƒè€ƒæ–‡ç»åˆ—è¡¨ - ç¼–è¾‘æ¨¡å¼ */}
                        {point.references.length > 0 && (
                          <div className="mt-3 p-3 bg-slate-600 rounded border border-slate-500">
                            <h5 className="text-sm font-medium text-white mb-2">ğŸ“š åƒè€ƒæ–‡ç» ({point.references.length})</h5>
                            <div className="space-y-2">
                              {point.references.map((ref) => (
                                <div key={ref.id} className="p-3 bg-slate-700 rounded border border-slate-500">
                                  <div className="flex items-start justify-between mb-2">
                                    <div className="flex-1">
                                  <p className="text-slate-300 text-sm font-medium">{ref.title}</p>
                                  <p className="text-slate-400 text-xs">{ref.authors} ({ref.year}). {ref.source}</p>
                                    </div>
                                    <div className="flex gap-1 ml-2">
                                      {/* ç§»åŠ¨åˆ°å…¶ä»–å¤§çº²ç‚¹æŒ‰é’® */}
                                      <div className="relative group">
                                        <button
                                          className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                          title="ç§»åŠ¨åˆ°å…¶ä»–å¤§çº²ç‚¹"
                                        >
                                          ğŸ”„
                                        </button>
                                        {/* ä¸‹æ‹‰èœå• */}
                                        <div className="hidden group-hover:block absolute right-0 mt-1 bg-slate-800 border border-slate-500 rounded shadow-lg z-10 min-w-[200px]">
                                          <div className="p-2">
                                            <p className="text-xs text-slate-300 mb-2">ç§»åŠ¨åˆ°ï¼š</p>
                                            {outlinePoints.filter(p => p.id !== point.id).map(targetPoint => (
                                              <button
                                                key={targetPoint.id}
                                                onClick={() => {
                                                  // ä»å½“å‰ç‚¹ç§»é™¤å¹¶æ·»åŠ åˆ°ç›®æ ‡ç‚¹
                                                  setOutlinePoints(prev => prev.map(p => {
                                                    if (p.id === point.id) {
                                                      return { ...p, references: p.references.filter(r => r.id !== ref.id) };
                                                    } else if (p.id === targetPoint.id) {
                                                      return { ...p, references: [...p.references, ref] };
                                                    }
                                                    return p;
                                                  }));
                                                  alert(`âœ… å·²å°†æ–‡çŒ®ç§»åŠ¨åˆ°å¤§çº²ç‚¹ ${targetPoint.id}: ${targetPoint.title}`);
                                                }}
                                                className="w-full text-left px-2 py-1 text-xs text-slate-300 hover:bg-slate-700 rounded mb-1"
                                              >
                                                {targetPoint.id}. {targetPoint.title.substring(0, 25)}...
                                              </button>
                                    ))}
                                  </div>
                                        </div>
                                      </div>
                                      
                                      {/* åˆ é™¤æŒ‰é’® */}
                                      <button
                                        onClick={() => {
                                          if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡çŒ®å—ï¼Ÿ\n\n${ref.title}`)) {
                                            setOutlinePoints(prev => prev.map(p => 
                                              p.id === point.id 
                                                ? { ...p, references: p.references.filter(r => r.id !== ref.id) }
                                                : p
                                            ));
                                            alert(`âœ… å·²åˆ é™¤æ–‡çŒ®: ${ref.title}`);
                                          }
                                        }}
                                        className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors"
                                        title="åˆ é™¤æ­¤æ–‡çŒ®"
                                      >
                                        âœ•
                                      </button>
                                    </div>
                                  </div>
                                  
                                  {/* ä¸­æ–‡æ¦‚è¿° */}
                                  {ref.deepAnalysis?.chineseExplanation && (
                                    <div className="mb-2">
                                      <p className="text-blue-300 text-xs mb-1">ğŸ“– ä¸­æ–‡æ¦‚è¿°ï¼š</p>
                                      <p className="text-slate-300 text-xs leading-relaxed">{ref.deepAnalysis.chineseExplanation}</p>
                                    </div>
                                  )}
                                  
                                  {/* APA7å¼•ç”¨æ ¼å¼ */}
                                  <div className="bg-slate-800 p-2 rounded mb-2">
                                    <p className="text-purple-300 text-xs mb-1">ğŸ“š APA7å¼•ç”¨ï¼š</p>
                                    <p className="text-slate-300 text-xs font-mono leading-relaxed">{ref.citation}</p>
                                  </div>
                                  
                                  {/* æ“ä½œæŒ‰é’® */}
                                  <div className="flex gap-2 mt-2 flex-wrap">
                                    {/* åŸæ–‡é“¾æ¥ */}
                                    {ref.url && (
                                      <a 
                                        href={ref.url} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                        title="è®¿é—®åŸæ–‡"
                                      >
                                        ğŸ”— è¨ªå•åŸæ–‡
                                      </a>
                                    )}
                                    
                                    {/* è‡ªåŠ¨è·å–å…¨æ–‡æŒ‰é’® */}
                                    <button
                                      onClick={async () => {
                                        try {
                                          const response = await fetch('/api/download-fulltext', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                              referenceId: ref.id,
                                              title: ref.title,
                                              authors: ref.authors,
                                              url: ref.url,
                                              doi: ref.doi
                                            }),
                                          });
                                          
                                          const data = await response.json();
                                          
                                          if (data.success && data.pdfUrl) {
                                            // æ‰“å¼€æ–°çª—å£ä¸‹è½½PDF
                                            window.open(data.pdfUrl, '_blank');
                                            
                                            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                                            if (data.saved && data.file) {
                                              alert(`âœ… æ‰¾åˆ°å¼€æ”¾è·å–ç‰ˆæœ¬ï¼\n\næ¥æº: ${data.source}\næ–‡ä»¶å¤§å°: ${(data.file.size / 1024 / 1024).toFixed(2)}MB\n\nâœ… å·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°æ–‡çŒ®åº“\næ–‡ä»¶å: ${data.file.name}\n\næ‚¨å¯ä»¥åœ¨åˆ›ä½œåˆç¨¿æ—¶ç›´æ¥è°ƒç”¨æ­¤æ–‡çŒ®å†…å®¹`);
                                              
                                              // è‡ªåŠ¨æ›´æ–°å‚è€ƒæ–‡çŒ®çš„PDFä¿¡æ¯
                                              setOutlinePoints(prev => prev.map(point => ({
                                                ...point,
                                                references: point.references.map(r => 
                                                  r.id === ref.id 
                                                    ? { ...r, fileUrl: data.file.url, fileName: data.file.name, fileSize: data.file.size }
                                                    : r
                                                )
                                              })));
                                            } else {
                                              alert(`âœ… æ‰¾åˆ°å¼€æ”¾è·å–ç‰ˆæœ¬ï¼\n\næ¥æº: ${data.source}\n\næ­£åœ¨æ‰“å¼€ä¸‹è½½é“¾æ¥...`);
                                            }
                                          } else {
                                            alert(`âŒ ${data.message}\n\nå»ºè®®ï¼š\n${data.suggestions?.join('\n') || 'è¯·å°è¯•æ‰‹åŠ¨ä¸Šä¼ PDF'}`);
                                          }
                                        } catch (error) {
                                          console.error('è·å–å…¨æ–‡å¤±è´¥:', error);
                                          alert(`è·å–å…¨æ–‡å¤±è´¥: ${error}`);
                                        }
                                      }}
                                      className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                      title="è‡ªåŠ¨è·å–å…¨æ–‡"
                                    >
                                      ğŸ“¥ è‡ªåŠ¨è·å–å…¨æ–‡
                                    </button>
                                    
                                    {/* æ‰‹åŠ¨ä¸Šä¼ æŒ‰é’® */}
                                    <button
                                      onClick={() => {
                                        // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
                                        const fileInput = document.createElement('input');
                                        fileInput.type = 'file';
                                        fileInput.accept = '.pdf';
                                        fileInput.onchange = async (e: any) => {
                                          const file = e.target.files[0];
                                          if (!file) return;
                                          
                                          // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                                          if (!file.type.includes('pdf')) {
                                            alert('âŒ åªæ”¯æŒPDFæ–‡ä»¶æ ¼å¼');
                                            return;
                                          }
                                          
                                          // æ£€æŸ¥æ–‡ä»¶å¤§å° (50MB)
                                          if (file.size > 50 * 1024 * 1024) {
                                            alert('âŒ æ–‡ä»¶å¤§å°è¶…è¿‡50MBé™åˆ¶');
                                            return;
                                          }
                                          
                                          // ä¸Šä¼ æ–‡ä»¶
                                          const formData = new FormData();
                                          formData.append('pdf', file);
                                          formData.append('referenceId', ref.id);
                                          formData.append('title', ref.title);
                                          formData.append('authors', ref.authors);
                                          
                                          try {
                                            const response = await fetch('/api/upload-fulltext', {
                                              method: 'POST',
                                              body: formData,
                                            });
                                            
                                            const data = await response.json();
                                            
                                            if (data.success) {
                                              alert(`âœ… PDFä¸Šä¼ æˆåŠŸï¼\n\næ–‡ä»¶: ${data.file.name}\nå¤§å°: ${(data.file.size / 1024 / 1024).toFixed(2)}MB\n\nå·²ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“`);
                                              
                                              // è‡ªåŠ¨æ›´æ–°å‚è€ƒæ–‡çŒ®çš„PDFä¿¡æ¯
                                              setOutlinePoints(prev => prev.map(point => ({
                                                ...point,
                                                references: point.references.map(r => 
                                                  r.id === ref.id 
                                                    ? { ...r, fileUrl: data.file.url, fileName: data.file.name, fileSize: data.file.size }
                                                    : r
                                                )
                                              })));
                                            } else {
                                              alert(`âŒ ä¸Šä¼ å¤±è´¥: ${data.message}`);
                                            }
                                          } catch (error) {
                                            alert(`ä¸Šä¼ å¤±è´¥: ${error}`);
                                          }
                                        };
                                        fileInput.click();
                                      }}
                                      className="px-2 py-1 bg-teal-600 text-white text-xs rounded hover:bg-teal-700 transition-colors"
                                      title="æ‰‹åŠ¨ä¸Šä¼ PDF"
                                    >
                                      ğŸ“¤ æ‰‹åŠ¨ä¸Šä¼ 
                                    </button>
                                    
                                    {/* PDFé¢„è§ˆæŒ‰é’® - åªæœ‰åœ¨æœ‰PDFæ–‡ä»¶æ—¶æ‰æ˜¾ç¤º */}
                                    {ref.fileUrl && (
                                      <button
                                        onClick={() => {
                                          // åœ¨æ–°çª—å£æ‰“å¼€PDF
                                          window.open(ref.fileUrl, '_blank');
                                        }}
                                        className="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors"
                                        title="é¢„è§ˆPDF"
                                      >
                                        ğŸ“„ é¢„è§ˆPDF
                                      </button>
                                    )}
                                    
                                    {/* PDFä¸‹è½½æŒ‰é’® - åªæœ‰åœ¨æœ‰PDFæ–‡ä»¶æ—¶æ‰æ˜¾ç¤º */}
                                    {ref.fileUrl && (
                                      <button
                                        onClick={() => {
                                          // ä¸‹è½½PDFæ–‡ä»¶
                                          const link = document.createElement('a');
                                          link.href = ref.fileUrl;
                                          link.download = ref.title.replace(/[^a-zA-Z0-9\s]/g, '') + '.pdf';
                                          link.click();
                                        }}
                                        className="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors"
                                        title="ä¸‹è½½PDF"
                                      >
                                        ğŸ“¥ ä¸‹è½½PDF
                                      </button>
                                    )}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* æ–‡ç»æœå°‹æ¨¡å¼ */}
              {activeTab === 'outline' && mode === 'search' && (
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <h3 className="text-lg font-semibold text-white">ğŸ“‹ å¤§ç¶±çµæ§‹ - é»æ“Šæœå°‹æŒ‰éˆ•é€²è¡Œæ–‡ç»æœå°‹</h3>
                    <button
                      onClick={() => setForm(prev => ({ ...prev, referenceSettingsExpanded: !prev.referenceSettingsExpanded }))}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                    >
                      âš™ï¸ å‚è€ƒæ–‡çŒ®è®¾ç½®
                    </button>
                  </div>

                  {/* å‚è€ƒæ–‡çŒ®è®¾ç½®é¢æ¿ */}
                  {form.referenceSettingsExpanded && (
                    <div className="p-4 bg-slate-700 rounded-lg border border-slate-500 mb-4">
                      <h4 className="text-lg font-semibold text-white mb-4">âš™ï¸ å‚è€ƒæ–‡çŒ®è®¾ç½®</h4>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {/* æ–‡çŒ®ç±»å‹é€‰æ‹© */}
                        <div>
                          <label className="block text-sm font-medium text-white mb-2">æ–‡çŒ®ç±»å‹</label>
                          <div className="space-y-2">
                            {['journal', 'book', 'conference', 'newspaper', 'website', 'thesis'].map((type) => (
                              <label key={type} className="flex items-center text-white">
                                <input
                                  type="checkbox"
                                  className="mr-2"
                                  checked={form.referenceSettings.documentTypes.includes(type)}
                                  onChange={(e) => {
                                    const newTypes = e.target.checked 
                                      ? [...form.referenceSettings.documentTypes, type]
                                      : form.referenceSettings.documentTypes.filter(t => t !== type);
                                    updateReferenceSettings({ documentTypes: newTypes });
                                  }}
                                />
                                <span className="text-sm">
                                  {type === 'journal' ? 'ğŸ“„ æœŸåˆŠæ–‡ç« ' :
                                   type === 'book' ? 'ğŸ“š ä¹¦ç±' :
                                   type === 'conference' ? 'ğŸ¤ ä¼šè®®è®ºæ–‡' :
                                   type === 'newspaper' ? 'ğŸ“° æŠ¥çº¸æ–‡ç« ' :
                                   type === 'website' ? 'ğŸŒ ç½‘ç«™' :
                                   'ğŸ“ å­¦ä½è®ºæ–‡'}
                                </span>
                              </label>
                            ))}
                          </div>
                        </div>

                        {/* å¼•ç”¨æ ¼å¼é€‰æ‹© */}
                        <div>
                          <label className="block text-sm font-medium text-white mb-2">å¼•ç”¨æ ¼å¼</label>
                          <select 
                            className="w-full p-2 bg-slate-600 border border-slate-500 rounded text-white"
                            value={form.referenceSettings.citationFormat}
                            onChange={(e) => updateReferenceSettings({ citationFormat: e.target.value })}
                          >
                            <option value="apa7">APA 7th Edition</option>
                            <option value="apa6">APA 6th Edition</option>
                            <option value="mla9">MLA 9th Edition</option>
                            <option value="chicago">Chicago Style</option>
                            <option value="harvard">Harvard Style</option>
                            <option value="ieee">IEEE Style</option>
                            <option value="vancouver">Vancouver Style</option>
                          </select>
                        </div>

                        {/* åœ°åŒºå’Œè¯­è¨€ */}
                        <div>
                          <label className="block text-sm font-medium text-white mb-2">åœ°åŒº</label>
                          <select 
                            className="w-full p-2 bg-slate-600 border border-slate-500 rounded text-white mb-3"
                            value={form.referenceSettings.region}
                            onChange={(e) => updateReferenceSettings({ region: e.target.value })}
                          >
                            <option value="global">ğŸŒ å…¨çƒ</option>
                            <option value="north-america">ğŸ‡ºğŸ‡¸ åŒ—ç¾</option>
                            <option value="europe">ğŸ‡ªğŸ‡º æ¬§æ´²</option>
                            <option value="asia">ğŸŒ äºšæ´²</option>
                            <option value="china">ğŸ‡¨ğŸ‡³ ä¸­å›½</option>
                            <option value="taiwan">ğŸ‡¹ğŸ‡¼ å°æ¹¾</option>
                          </select>
                          
                          <label className="block text-sm font-medium text-white mb-2">è¯­è¨€</label>
                          <select 
                            className="w-full p-2 bg-slate-600 border border-slate-500 rounded text-white"
                            value={form.referenceSettings.language}
                            onChange={(e) => updateReferenceSettings({ language: e.target.value })}
                          >
                            <option value="en">English</option>
                          </select>
                        </div>
                      </div>

                      {/* å¹´ä»½èŒƒå›´ */}
                      <div className="mt-4">
                        <label className="block text-sm font-medium text-white mb-2">å¹´ä»½èŒƒå›´</label>
                        <div className="flex items-center gap-4">
                          <div className="flex items-center gap-2">
                            <label className="text-white text-sm">ä»</label>
                            <input
                              type="number"
                              min="1900"
                              max={new Date().getFullYear()}
                              value={form.referenceSettings.yearRange.from}
                              onChange={(e) => updateReferenceSettings({ 
                                yearRange: { 
                                  ...form.referenceSettings.yearRange, 
                                  from: parseInt(e.target.value) 
                                } 
                              })}
                              className="w-20 p-2 bg-slate-600 border border-slate-500 rounded text-white text-sm"
                            />
                          </div>
                          <div className="flex items-center gap-2">
                            <label className="text-white text-sm">åˆ°</label>
                            <input
                              type="number"
                              min="1900"
                              max={new Date().getFullYear()}
                              value={form.referenceSettings.yearRange.to}
                              onChange={(e) => updateReferenceSettings({ 
                                yearRange: { 
                                  ...form.referenceSettings.yearRange, 
                                  to: parseInt(e.target.value) 
                                } 
                              })}
                              className="w-20 p-2 bg-slate-600 border border-slate-500 rounded text-white text-sm"
                            />
                          </div>
                        </div>
                      </div>

                      {/* å‡ºç‰ˆå•†è¿‡æ»¤é€‰é¡¹ */}
                      <div className="mt-4">
                        <label className="block text-sm font-medium text-white mb-2">å‡ºç‰ˆå•†è¿‡æ»¤</label>
                        <div className="flex items-center">
                          <input
                            type="checkbox"
                            id="excludeLoginRequiredPublishers"
                            className="mr-2"
                            checked={form.referenceSettings.excludeLoginRequiredPublishers}
                            onChange={(e) => updateReferenceSettings({ 
                              excludeLoginRequiredPublishers: e.target.checked 
                            })}
                          />
                          <label htmlFor="excludeLoginRequiredPublishers" className="text-white text-sm">
                            ğŸš« è‡ªåŠ¨æ’é™¤éœ€ç™»å½•çš„ä»˜è´¹å‡ºç‰ˆå•†
                          </label>
                        </div>
                        <p className="text-xs text-slate-400 mt-1">
                          æ’é™¤ Taylor & Francisã€Springerã€Elsevier ç­‰éœ€è¦ä»˜è´¹æˆ–ç™»å½•æ‰èƒ½è®¿é—®çš„å‡ºç‰ˆå•†å†…å®¹
                        </p>
                      </div>

                      {/* æ•°æ®åº“æ¥æº */}
                      <div className="mt-4">
                        <label className="block text-sm font-medium text-white mb-2">æ•°æ®åº“æ¥æº</label>
                        
                        {/* æ— éœ€ç™»å½•çš„å…è´¹OAæº */}
                        <div className="mb-3">
                          <h4 className="text-sm font-medium text-green-300 mb-2">âœ… æ— éœ€ç™»å½•çš„å…è´¹OAæº</h4>
                        <div className="grid grid-cols-3 gap-2">
                            {getDatabasesByCategory('free_oa').map((db) => (
                              <label key={db.id} className="flex flex-col text-white p-1.5 bg-slate-600 rounded border border-slate-500 text-xs">
                              <div className="flex items-center mb-1">
                                <input
                                  type="checkbox"
                                  className="mr-1.5 w-3 h-3"
                                    checked={form.referenceSettings.sources.includes(db.id)}
                                  onChange={(e) => {
                                    const newSources = e.target.checked 
                                        ? [...form.referenceSettings.sources, db.id]
                                        : form.referenceSettings.sources.filter(s => s !== db.id);
                                    updateReferenceSettings({ sources: newSources });
                                  }}
                                />
                                <div className="flex-1">
                                  <div className="text-xs font-medium flex items-center leading-tight">
                                    <span className="mr-1">{db.icon}</span>
                                    {db.name}
                                    {db.fullTextAvailable && <span className="ml-1 text-green-400">ğŸ“¥</span>}
                                    {db.apiAvailable && <span className="ml-1 text-blue-400">ğŸ”Œ</span>}
                                  </div>
                                  <div className="text-xs text-slate-400 leading-tight">{db.description}</div>
                                  <div className="text-xs text-green-400 mt-0.5 leading-tight">
                                    ä¸“é•¿: {db.specialties.join(', ')}
                                  </div>
                                </div>
                              </div>
                            </label>
                          ))}
                          </div>
                        </div>

                        {/* éœ€ç™»å½•çš„å…è´¹OAæº */}
                        <div className="mb-3">
                          <h4 className="text-sm font-medium text-yellow-300 mb-2">âš ï¸ éœ€ç™»å½•çš„å…è´¹OAæº</h4>
                          <div className="grid grid-cols-3 gap-2">
                            {getDatabasesByCategory('free_login').map((db) => (
                              <label key={db.id} className="flex flex-col text-white p-1.5 bg-slate-600 rounded border border-slate-500 text-xs">
                              <input
                                type="checkbox"
                                className="mr-2"
                                  checked={form.referenceSettings.sources.includes(db.id)}
                                onChange={(e) => {
                                  const newSources = e.target.checked 
                                      ? [...form.referenceSettings.sources, db.id]
                                      : form.referenceSettings.sources.filter(s => s !== db.id);
                                  updateReferenceSettings({ sources: newSources });
                                }}
                              />
                                <div className="flex-1">
                                  <div className="text-xs font-medium flex items-center leading-tight">
                                    <span className="mr-1">{db.icon}</span>
                                    {db.name}
                                    {db.fullTextAvailable && <span className="ml-1 text-green-400">ğŸ“¥</span>}
                                    {db.apiAvailable && <span className="ml-1 text-blue-400">ğŸ”Œ</span>}
                                  </div>
                                  <div className="text-xs text-slate-400 leading-tight">{db.description}</div>
                                  <div className="text-xs text-yellow-400 mt-1">
                                    ä¸“é•¿: {db.specialties.join(', ')} â€¢ éœ€è¦è´¦å·
                                  </div>
                              </div>
                            </label>
                          ))}
                          </div>
                        </div>

                        {/* APIä¸“ç”¨æº */}
                        <div className="mb-3">
                          <h4 className="text-sm font-medium text-blue-300 mb-2">ğŸ”Œ APIä¸“ç”¨æº</h4>
                          <div className="grid grid-cols-3 gap-2">
                            {getDatabasesByCategory('api_only').map((db) => (
                              <label key={db.id} className="flex flex-col text-white p-1.5 bg-slate-600 rounded border border-slate-500 text-xs">
                                <div className="flex items-center mb-1">
                                  <input
                                    type="checkbox"
                                    className="mr-1.5 w-3 h-3"
                                    checked={form.referenceSettings.sources.includes(db.id)}
                                    onChange={(e) => {
                                      const newSources = e.target.checked 
                                        ? [...form.referenceSettings.sources, db.id]
                                        : form.referenceSettings.sources.filter(s => s !== db.id);
                                      updateReferenceSettings({ sources: newSources });
                                    }}
                                  />
                                  <div className="flex-1">
                                    <div className="text-xs font-medium flex items-center leading-tight">
                                      <span className="mr-1">{db.icon}</span>
                                      {db.name}
                                      {db.fullTextAvailable && <span className="ml-1 text-green-400">ğŸ“¥</span>}
                                      <span className="ml-1 text-blue-400">ğŸ”Œ</span>
                                    </div>
                                  </div>
                                </div>
                                <div className="text-xs text-slate-400 leading-tight">{db.description}</div>
                                <div className="text-xs text-blue-400 mt-0.5 leading-tight">
                                  ä¸“é•¿: {db.specialties.join(', ')} â€¢ APIè®¿é—®
                                </div>
                              </label>
                            ))}
                          </div>
                        </div>

                        {/* æ•°æ®åº“ç»Ÿè®¡ */}
                        <div className="mt-3 p-2 bg-slate-700 rounded text-xs text-slate-300">
                          ğŸ“Š æ•°æ®åº“ç»Ÿè®¡: æ€»è®¡{getDatabaseStats().total}ä¸ª | 
                          å…è´¹OA: {getDatabaseStats().freeOa}ä¸ª | 
                          éœ€ç™»å½•: {getDatabaseStats().freeLogin}ä¸ª | 
                          APIä¸“ç”¨: {getDatabaseStats().apiOnly}ä¸ª | 
                          æ”¯æŒå…¨æ–‡: {getDatabaseStats().withFullText}ä¸ª | 
                          æ”¯æŒAPI: {getDatabaseStats().withAPI}ä¸ª
                        </div>
                      </div>

                      {/* åº”ç”¨è®¾ç½®æŒ‰é’® */}
                      <div className="mt-4 pt-4 border-t border-slate-500">
                        <button 
                          onClick={() => {
                            saveReferenceSettings(form.referenceSettings);
                            alert('å‚è€ƒæ–‡çŒ®è®¾ç½®å·²ä¿å­˜ï¼');
                            setForm(prev => ({ ...prev, referenceSettingsExpanded: false }));
                          }}
                          className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                        >
                          ğŸ’¾ ä¿å­˜è®¾ç½®
                        </button>
                      </div>
                    </div>
                  )}
                  
                  {/* å¤§ç¶±é»åˆ—è¡¨ - æ¯å€‹é»éƒ½æœ‰æœå°‹æŒ‰éˆ•ï¼Œæœå°‹ç•Œé¢å‡ºç¾åœ¨é»æ“Šçš„é»ä¸‹æ–¹ */}
                  {outlinePoints.map((point, index) => (
                    <div key={point.id}>
                      {/* å¤§ç¶±é» */}
                      <div className="p-4 bg-slate-700 rounded-lg border border-slate-600">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <h4 className="text-lg font-medium text-white">{point.id}. {point.title}</h4>
                            <p className="text-slate-300 text-sm mt-1">{point.content}</p>
                            
                            {/* ç°¡æ½”çš„bullet points - ç·Šæ¹Šå¸ƒå±€ï¼Œæ‰‹å‹•æ§åˆ¶æœç´¢ */}
                            <div className="mt-2 space-y-1">
                              {point.bulletPoints.map((bullet, idx) => {
                                const pointBulletKey = `${point.id}-${idx}`;
                                const isKeywordGenerated = !!searchKeywords[pointBulletKey];
                                
                                return (
                                  <div key={idx} className="flex items-start py-1">
                                    <span className="text-slate-400 text-xs mr-2 mt-0.5">â€¢</span>
                                    <div className="flex-1">
                                      {mode === 'edit' ? (
                                        <input
                                          type="text"
                                          value={bullet}
                                          onChange={(e) => {
                                            setOutline(prev => prev.map(p => 
                                              p.id === point.id 
                                                ? { 
                                                    ...p, 
                                                    bulletPoints: p.bulletPoints.map((bp, i) => 
                                                      i === idx ? e.target.value : bp
                                                    )
                                                  }
                                                : p
                                            ));
                                          }}
                                          className="w-full bg-transparent text-slate-300 text-xs border-none outline-none focus:bg-slate-800 px-2 py-1 rounded"
                                          placeholder="è¾“å…¥è¯¦ç»†è¦ç‚¹..."
                                        />
                                      ) : (
                                        <div className="text-slate-300 text-xs">{bullet}</div>
                                      )}
                                      {isKeywordGenerated && (
                                        <div className="mt-1">
                                          <span className="inline-flex items-center px-2 py-1 text-xs rounded bg-blue-660 text-white">
                                            {searchKeywords[pointBulletKey]}
                                          </span>
                                </div>
                                      )}
                                    </div>
                                    <button
                                      onClick={() => {
                                        // ç”Ÿæˆå…³é”®è¯ï¼ˆæ”¯æŒé‡æ–°ç”Ÿæˆï¼‰
                                        const bulletKeyword = generateBulletPointKeywords(bullet, point.id, idx);
                                        setSearchKeywords(prev => ({
                                          ...prev, 
                                          [pointBulletKey]: bulletKeyword
                                        }));
                                        // è®¾ç½®å½“å‰é€‰ä¸­çš„bullet point
                                        setSelectedBulletPoint(pointBulletKey);
                                        // åŒæ—¶æ¿€æ´»ä¸»æœç´¢çª—å£ï¼ˆä½†ä¸è¦†ç›–bullet pointå…³é”®è¯ï¼‰
                                        if (!searchKeywords[point.id]) {
                                          const mainKeyword = generateEnglishKeywords(point.title, point.id);
                                          setSearchKeywords(prev => ({...prev, [point.id]: mainKeyword}));
                                        }
                                      }}
                                      disabled={isSearching}
                                      className="ml-2 px-3 py-1 bg-blue-660 text-white text-xs rounded hover:bg-blue-700 transition-colors disabled:opacity-50 whitespace-nowrap"
                                    >
                                      ç”Ÿæˆå…³é”®è¯
                                    </button>
                                    {mode === 'edit' && (
                                      <button
                                        onClick={() => {
                                          // åˆ é™¤bullet point
                                          setOutline(prev => prev.map(p => 
                                            p.id === point.id 
                                              ? { 
                                                  ...p, 
                                                  bulletPoints: p.bulletPoints.filter((_, i) => i !== idx)
                                                }
                                              : p
                                          ));
                                          // æ¸…é™¤ç›¸å…³çš„æœç´¢å…³é”®è¯
                                          setSearchKeywords(prev => {
                                            const newKeywords = {...prev};
                                            delete newKeywords[pointBulletKey];
                                            return newKeywords;
                                          });
                                        }}
                                        className="ml-1 px-2 py-1 bg-red-660 text-white text-xs rounded hover:bg-red-700 transition-colors"
                                        title="åˆ é™¤æ­¤è¦ç‚¹"
                                      >
                                        âœ•
                                      </button>
                                    )}
                                  </div>
                                );
                              })}
                              
                              {/* æ·»åŠ æ–°è¯¦ç»†è¦ç‚¹æŒ‰é’® - åªåœ¨ç¼–è¾‘æ¨¡å¼æ˜¾ç¤º */}
                              {mode === 'edit' && (
                                <div className="mt-3 pt-2 border-t border-slate-600">
                                <button
                                  onClick={() => {
                                    // æ·»åŠ æ–°çš„bullet point
                                    const newBulletPoint = 'æ–°çš„è¯¦ç»†è¦ç‚¹';
                                    setOutline(prev => prev.map(p => 
                                      p.id === point.id 
                                        ? { ...p, bulletPoints: [...p.bulletPoints, newBulletPoint] }
                                        : p
                                    ));
                                  }}
                                  className="flex items-center px-3 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors"
                                >
                                  <span className="mr-2">â•</span>
                                  æ·»åŠ è¯¦ç»†è¦ç‚¹
                                </button>
                                </div>
                              )}
                            </div>
                            
                            <p className="text-slate-400 text-xs mt-2">å­—æ•¸ï¼š{point.wordCount}å­—</p>
                          </div>
                          <button
                            onClick={() => {
                              const isPointSearchActivated = !!searchKeywords[point.id];
                              
                              if (!isPointSearchActivated) {
                                // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šåªç”Ÿæˆå…³é”®è¯ï¼Œæ˜¾ç¤ºæœç´¢çª—å£
                                const basicKeywords = generateEnglishKeywords(point.title, point.id);
                                setSearchKeywords(prev => ({...prev, [point.id]: basicKeywords}));
                                setSelectedBulletPoint(null); // æ¸…é™¤bullet pointé€‰æ‹©
                              } else {
                                // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šæ‰§è¡Œæœç´¢
                                const currentKeyword = searchKeywords[point.id] || '';
                                if (currentKeyword) {
                                  handleSearchReferences(currentKeyword, point.id, true);
                                }
                              }
                            }}
                            disabled={isSearching}
                            className="px-3 py-1 bg-blue-660 text-white text-sm rounded hover:bg-blue-700 transition-colors disabled:opacity-50"
                          >
                            {searchKeywords[point.id] ? 'ğŸ”„ é‡æ–°æœå°‹' : 'ğŸ” æœå°‹æ–‡ç»'}
                          </button>
                        </div>
                        
                        {/* åƒè€ƒæ–‡ç»åˆ—è¡¨ - æœç´¢æ¨¡å¼ */}
                        {point.references.length > 0 && (
                          <div className="mt-3 p-3 bg-slate-600 rounded border border-slate-500">
                            <h5 className="text-sm font-medium text-white mb-2">ğŸ“š åƒè€ƒæ–‡ç» ({point.references.length})</h5>
                            <div className="space-y-2">
                              {point.references.map((ref) => (
                                <div key={ref.id} className="p-3 bg-slate-700 rounded border border-slate-500">
                                  <div className="flex items-start justify-between mb-2">
                                    <div className="flex-1">
                                  <p className="text-slate-300 text-sm font-medium">{ref.title}</p>
                                  <p className="text-slate-400 text-xs">{ref.authors} ({ref.year}). {ref.source}</p>
                                    </div>
                                    <div className="flex gap-1 ml-2">
                                      {/* ç§»åŠ¨åˆ°å…¶ä»–å¤§çº²ç‚¹æŒ‰é’® */}
                                      <div className="relative group">
                                        <button
                                          className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                          title="ç§»åŠ¨åˆ°å…¶ä»–å¤§çº²ç‚¹"
                                        >
                                          ğŸ”„
                                        </button>
                                        {/* ä¸‹æ‹‰èœå• */}
                                        <div className="hidden group-hover:block absolute right-0 mt-1 bg-slate-800 border border-slate-500 rounded shadow-lg z-10 min-w-[200px]">
                                          <div className="p-2">
                                            <p className="text-xs text-slate-300 mb-2">ç§»åŠ¨åˆ°ï¼š</p>
                                            {outlinePoints.filter(p => p.id !== point.id).map(targetPoint => (
                                              <button
                                                key={targetPoint.id}
                                                onClick={() => {
                                                  // ä»å½“å‰ç‚¹ç§»é™¤å¹¶æ·»åŠ åˆ°ç›®æ ‡ç‚¹
                                                  setOutlinePoints(prev => prev.map(p => {
                                                    if (p.id === point.id) {
                                                      return { ...p, references: p.references.filter(r => r.id !== ref.id) };
                                                    } else if (p.id === targetPoint.id) {
                                                      return { ...p, references: [...p.references, ref] };
                                                    }
                                                    return p;
                                                  }));
                                                  alert(`âœ… å·²å°†æ–‡çŒ®ç§»åŠ¨åˆ°å¤§çº²ç‚¹ ${targetPoint.id}: ${targetPoint.title}`);
                                                }}
                                                className="w-full text-left px-2 py-1 text-xs text-slate-300 hover:bg-slate-700 rounded mb-1"
                                              >
                                                {targetPoint.id}. {targetPoint.title.substring(0, 25)}...
                                              </button>
                                    ))}
                                  </div>
                                        </div>
                                      </div>
                                      
                                      {/* åˆ é™¤æŒ‰é’® */}
                                      <button
                                        onClick={() => {
                                          if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡çŒ®å—ï¼Ÿ\n\n${ref.title}`)) {
                                            setOutlinePoints(prev => prev.map(p => 
                                              p.id === point.id 
                                                ? { ...p, references: p.references.filter(r => r.id !== ref.id) }
                                                : p
                                            ));
                                            alert(`âœ… å·²åˆ é™¤æ–‡çŒ®: ${ref.title}`);
                                          }
                                        }}
                                        className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors"
                                        title="åˆ é™¤æ­¤æ–‡çŒ®"
                                      >
                                        âœ•
                                      </button>
                                    </div>
                                  </div>
                                  
                                  {/* ä¸­æ–‡æ¦‚è¿° */}
                                  {ref.deepAnalysis?.chineseExplanation && (
                                    <div className="mb-2">
                                      <p className="text-blue-300 text-xs mb-1">ğŸ“– ä¸­æ–‡æ¦‚è¿°ï¼š</p>
                                      <p className="text-slate-300 text-xs leading-relaxed">{ref.deepAnalysis.chineseExplanation}</p>
                                    </div>
                                  )}
                                  
                                  {/* APA7å¼•ç”¨æ ¼å¼ */}
                                  <div className="bg-slate-800 p-2 rounded mb-2">
                                    <p className="text-purple-300 text-xs mb-1">ğŸ“š APA7å¼•ç”¨ï¼š</p>
                                    <p className="text-slate-300 text-xs font-mono leading-relaxed">{ref.citation}</p>
                                  </div>
                                  
                                  {/* æ“ä½œæŒ‰é’® */}
                                  <div className="flex gap-2 mt-2 flex-wrap">
                                    {/* åŸæ–‡é“¾æ¥ */}
                                    {ref.url && (
                                      <a 
                                        href={ref.url} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                        title="è®¿é—®åŸæ–‡"
                                      >
                                        ğŸ”— è¨ªå•åŸæ–‡
                                      </a>
                                    )}
                                    
                                    {/* è‡ªåŠ¨è·å–å…¨æ–‡æŒ‰é’® */}
                                    <button
                                      onClick={async () => {
                                        try {
                                          const response = await fetch('/api/download-fulltext', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                              referenceId: ref.id,
                                              title: ref.title,
                                              authors: ref.authors,
                                              url: ref.url,
                                              doi: ref.doi
                                            }),
                                          });
                                          
                                          const data = await response.json();
                                          
                                          if (data.success && data.pdfUrl) {
                                            // æ‰“å¼€æ–°çª—å£ä¸‹è½½PDF
                                            window.open(data.pdfUrl, '_blank');
                                            
                                            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                                            if (data.saved && data.file) {
                                              alert(`âœ… æ‰¾åˆ°å¼€æ”¾è·å–ç‰ˆæœ¬ï¼\n\næ¥æº: ${data.source}\næ–‡ä»¶å¤§å°: ${(data.file.size / 1024 / 1024).toFixed(2)}MB\n\nâœ… å·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°æ–‡çŒ®åº“\næ–‡ä»¶å: ${data.file.name}\n\næ‚¨å¯ä»¥åœ¨åˆ›ä½œåˆç¨¿æ—¶ç›´æ¥è°ƒç”¨æ­¤æ–‡çŒ®å†…å®¹`);
                                              
                                              // è‡ªåŠ¨æ›´æ–°å‚è€ƒæ–‡çŒ®çš„PDFä¿¡æ¯
                                              setOutlinePoints(prev => prev.map(point => ({
                                                ...point,
                                                references: point.references.map(r => 
                                                  r.id === ref.id 
                                                    ? { ...r, fileUrl: data.file.url, fileName: data.file.name, fileSize: data.file.size }
                                                    : r
                                                )
                                              })));
                                            } else {
                                              alert(`âœ… æ‰¾åˆ°å¼€æ”¾è·å–ç‰ˆæœ¬ï¼\n\næ¥æº: ${data.source}\n\næ­£åœ¨æ‰“å¼€ä¸‹è½½é“¾æ¥...`);
                                            }
                                          } else {
                                            alert(`âŒ ${data.message}\n\nå»ºè®®ï¼š\n${data.suggestions?.join('\n') || 'è¯·å°è¯•æ‰‹åŠ¨ä¸Šä¼ PDF'}`);
                                          }
                                        } catch (error) {
                                          console.error('è·å–å…¨æ–‡å¤±è´¥:', error);
                                          alert(`è·å–å…¨æ–‡å¤±è´¥: ${error}`);
                                        }
                                      }}
                                      className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                      title="è‡ªåŠ¨è·å–å…¨æ–‡"
                                    >
                                      ğŸ“¥ è‡ªåŠ¨è·å–å…¨æ–‡
                                    </button>
                                    
                                    {/* æ‰‹åŠ¨ä¸Šä¼ æŒ‰é’® */}
                                    <button
                                      onClick={() => {
                                        // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
                                        const fileInput = document.createElement('input');
                                        fileInput.type = 'file';
                                        fileInput.accept = '.pdf';
                                        fileInput.onchange = async (e: any) => {
                                          const file = e.target.files[0];
                                          if (!file) return;
                                          
                                          // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                                          if (!file.type.includes('pdf')) {
                                            alert('âŒ åªæ”¯æŒPDFæ–‡ä»¶æ ¼å¼');
                                            return;
                                          }
                                          
                                          // æ£€æŸ¥æ–‡ä»¶å¤§å° (50MB)
                                          if (file.size > 50 * 1024 * 1024) {
                                            alert('âŒ æ–‡ä»¶å¤§å°è¶…è¿‡50MBé™åˆ¶');
                                            return;
                                          }
                                          
                                          // ä¸Šä¼ æ–‡ä»¶
                                          const formData = new FormData();
                                          formData.append('pdf', file);
                                          formData.append('referenceId', ref.id);
                                          formData.append('title', ref.title);
                                          formData.append('authors', ref.authors);
                                          
                                          try {
                                            const response = await fetch('/api/upload-fulltext', {
                                              method: 'POST',
                                              body: formData,
                                            });
                                            
                                            const data = await response.json();
                                            
                                            if (data.success) {
                                              alert(`âœ… PDFä¸Šä¼ æˆåŠŸï¼\n\næ–‡ä»¶: ${data.file.name}\nå¤§å°: ${(data.file.size / 1024 / 1024).toFixed(2)}MB\n\nå·²ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“`);
                                              
                                              // è‡ªåŠ¨æ›´æ–°å‚è€ƒæ–‡çŒ®çš„PDFä¿¡æ¯
                                              setOutlinePoints(prev => prev.map(point => ({
                                                ...point,
                                                references: point.references.map(r => 
                                                  r.id === ref.id 
                                                    ? { ...r, fileUrl: data.file.url, fileName: data.file.name, fileSize: data.file.size }
                                                    : r
                                                )
                                              })));
                                            } else {
                                              alert(`âŒ ä¸Šä¼ å¤±è´¥: ${data.message}`);
                                            }
                                          } catch (error) {
                                            alert(`ä¸Šä¼ å¤±è´¥: ${error}`);
                                          }
                                        };
                                        fileInput.click();
                                      }}
                                      className="px-2 py-1 bg-teal-600 text-white text-xs rounded hover:bg-teal-700 transition-colors"
                                      title="æ‰‹åŠ¨ä¸Šä¼ PDF"
                                    >
                                      ğŸ“¤ æ‰‹åŠ¨ä¸Šä¼ 
                                    </button>
                                    
                                    {/* PDFé¢„è§ˆæŒ‰é’® - åªæœ‰åœ¨æœ‰PDFæ–‡ä»¶æ—¶æ‰æ˜¾ç¤º */}
                                    {ref.fileUrl && (
                                      <button
                                        onClick={() => {
                                          // åœ¨æ–°çª—å£æ‰“å¼€PDF
                                          window.open(ref.fileUrl, '_blank');
                                        }}
                                        className="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors"
                                        title="é¢„è§ˆPDF"
                                      >
                                        ğŸ“„ é¢„è§ˆPDF
                                      </button>
                                    )}
                                    
                                    {/* PDFä¸‹è½½æŒ‰é’® - åªæœ‰åœ¨æœ‰PDFæ–‡ä»¶æ—¶æ‰æ˜¾ç¤º */}
                                    {ref.fileUrl && (
                                      <button
                                        onClick={() => {
                                          // ä¸‹è½½PDFæ–‡ä»¶
                                          const link = document.createElement('a');
                                          link.href = ref.fileUrl;
                                          link.download = ref.title.replace(/[^a-zA-Z0-9\s]/g, '') + '.pdf';
                                          link.click();
                                        }}
                                        className="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors"
                                        title="ä¸‹è½½PDF"
                                      >
                                        ğŸ“¥ ä¸‹è½½PDF
                                      </button>
                                    )}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>

                      {/* æ–‡ç»æœå°‹ç•Œé¢ - åªæœ‰æ¿€æ´»çš„æœç´¢æ‰æ˜¾ç¤º */}
                      {(Object.keys(searchKeywords).some((key: string) => key.startsWith(`${point.id}`))) && (
                        <div className="mt-4 p-4 bg-slate-600 rounded-lg border border-slate-500">
                          <div className="flex justify-between items-center mb-3">
                            <h3 className="text-lg font-semibold text-white">ğŸ” æ–‡ç»æœå°‹ - {point.title}</h3>
                            <button
                              onClick={() => {
                                setSearchKeywords(prev => {
                                  const newKeywords = {...prev};
                                  // åˆ é™¤è¯¥å¤§çº²ç‚¹ä¸‹æ‰€æœ‰çš„æœç´¢å…³é”®è¯ï¼ˆåŒ…æ‹¬bullet pointsï¼‰
                                  Object.keys(newKeywords).forEach((key: string) => {
                                    if (key === point.id.toString() || key.startsWith(`${point.id}-`)) {
                                      delete newKeywords[key];
                                    }
                                  });
                                  return newKeywords;
                                });
                                setSearchResults([]);
                                setIsSearching(false);
                                setSelectedBulletPoint(null); // æ¸…é™¤bullet pointé€‰æ‹©
                              }}
                              className="px-2 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors"
                            >
                              âœ• é—œé–‰
                            </button>
                          </div>
                          
                          {/* æœå°‹æ¡† - ç”¨æˆ¶å¯æ‰‹å‹•ç·¨è¼¯é—œéµå­— */}
                          <div className="mb-4">
                            <div className="flex space-x-3 mb-3">
                              <input
                                type="text"
                                placeholder="è«‹è¼¸å…¥æœå°‹é—œéµå­—ï¼Œæˆ–ä½¿ç”¨AIè‡ªå‹•ç”Ÿæˆ..."
                                className="flex-1 px-3 py-2 bg-slate-700 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400"
                                value={selectedBulletPoint ? (searchKeywords[selectedBulletPoint] || '') : (searchKeywords[point.id] || '')}
                                onChange={(e) => {
                                  if (selectedBulletPoint) {
                                    setSearchKeywords(prev => ({...prev, [selectedBulletPoint]: e.target.value}));
                                  } else {
                                    setSearchKeywords(prev => ({...prev, [point.id]: e.target.value}));
                                  }
                                }}
                              />
                              <button
                                onClick={() => {
                                  // ä½¿ç”¨ç•¶å‰è¼¸å…¥çš„é—œéµå­—é€²è¡Œæœå°‹
                                  const currentKeyword = selectedBulletPoint ? (searchKeywords[selectedBulletPoint] || '') : (searchKeywords[point.id] || '');
                                  if (currentKeyword.trim()) {
                                    handleSearchReferences(currentKeyword.trim(), point.id, true);
                                  }
                                }}
                                disabled={isSearching || !(selectedBulletPoint ? searchKeywords[selectedBulletPoint]?.trim() : searchKeywords[point.id]?.trim())}
                                className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors disabled:opacity-50"
                              >
                                {isSearching ? 'ğŸ” æœå°‹ä¸­...' : 'ğŸ” æœå°‹'}
                              </button>
                              <button
                                onClick={() => {
                                  // ä½¿ç”¨AIå¢å¼·æœå°‹
                                  const currentKeyword = selectedBulletPoint ? (searchKeywords[selectedBulletPoint] || '') : (searchKeywords[point.id] || point.title);
                                  handleSearchReferences(currentKeyword.trim(), point.id, true);
                                }}
                                disabled={isSearching}
                                className="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors disabled:opacity-50"
                              >
                                {isSearching ? 'ğŸ” æœå°‹ä¸­...' : 'ğŸ¤– AIå¢å¼·'}
                              </button>
                            </div>
                            
                            {/* å…³é”®è¯æ˜¾ç¤ºåŒºåŸŸ - å¸¦Xæ ‡è®°å’Œé«˜äº® */}
                            {(selectedBulletPoint ? searchKeywords[selectedBulletPoint] : searchKeywords[point.id]) && (
                              <div className="mb-3">
                                <div className="text-sm text-slate-300 mb-2">ğŸ’¡ æœå°‹é—œéµå­—ï¼š</div>
                                <div className="flex flex-wrap gap-2 items-center">
                                  {(() => {
                                    // æ™ºèƒ½åˆ†å‰²å…³é”®è¯ï¼Œå¤„ç†å¼•å·å’ŒANDè¿ç®—ç¬¦
                                    const keywords = selectedBulletPoint ? searchKeywords[selectedBulletPoint] : searchKeywords[point.id];
                                    const tokens: Array<{text: string, id: number, isOperator: boolean}> = [];
                                    
                                    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰²ï¼Œä¿æŒå¼•å·å†…çš„å†…å®¹å®Œæ•´ï¼Œä½†å¿½ç•¥AND/OR/NOTè¿ç®—ç¬¦
                                    const matches = keywords.match(/"[^"]*"|\S+/g) || [];
                                    
                                    matches.forEach((token, idx) => {
                                      if (token.trim()) {
                                        tokens.push({
                                          text: token.trim(),
                                          id: idx,
                                          isOperator: ['AND', 'OR', 'NOT'].includes(token.trim().toUpperCase())
                                        });
                                      }
                                    });
                                    
                                    return tokens.map((token) => (
                                      <span
                                        key={token.id}
                                        className={`inline-flex items-center px-3 py-1 text-sm rounded-full ${
                                          token.isOperator 
                                            ? 'bg-gray-600 text-gray-300' 
                                            : 'bg-blue-600 text-white'
                                        }`}
                                      >
                                        <span className="mr-2">{token.text}</span>
                                        {!token.isOperator && (
                                          <button
                                            onClick={() => {
                                              // é‡æ–°æ„å»ºå…³é”®è¯å­—ç¬¦ä¸²ï¼Œç§»é™¤è¢«åˆ é™¤çš„è¯
                                              const newTokens = tokens.filter(t => t.id !== token.id);
                                              const newKeywords = newTokens.map(t => t.text).join(' ');
                                              setSearchKeywords(prev => ({
                                                ...prev,
                                                [selectedBulletPoint || point.id]: newKeywords
                                              }));
                                            }}
                                            className="ml-1 text-red-300 hover:text-red-100 transition-colors"
                                            title="åˆ é™¤æ­¤å…³é”®è¯"
                                          >
                                            âœ•
                                          </button>
                                        )}
                                      </span>
                                    ));
                                  })()}
                                </div>
                                
                                {/* æ‰‹åŠ¨æ·»åŠ å‚è€ƒæ–‡çŒ®æŒ‰é’® */}
                                <div className="mt-3 flex justify-end gap-2">
                                  <button
                                    onClick={async () => {
                                      // è§¦å‘æ‰‹åŠ¨æ·»åŠ å‚è€ƒæ–‡çŒ®åŠŸèƒ½
                                      const manualRef = {
                                        id: `manual-${Date.now()}`,
                                        title: searchKeywords[point.id] || 'æ‰‹åŠ¨æ·»åŠ çš„æ–‡çŒ®',
                                        authors: 'ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ ',
                                        source: 'æ‰‹åŠ¨è¾“å…¥',
                                        year: new Date().getFullYear(),
                                        summary: 'è¿™æ˜¯ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ çš„å‚è€ƒæ–‡çŒ®',
                                        keySentences: [],
                                        citation: `${searchKeywords[point.id] || 'æ‰‹åŠ¨æ·»åŠ çš„æ–‡çŒ®'} (${new Date().getFullYear()}). ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ .`,
                                        database: 'æ‰‹åŠ¨è¾“å…¥',
                                        url: undefined
                                      };
                                      await addReferenceToPoint(point.id, manualRef);
                                      alert(`å·²æ‰‹åŠ¨æ·»åŠ æ–‡çŒ®åˆ°å¤§ç¶±é» ${point.id}: ${point.title}`);
                                    }}
                                    className="px-4 py-2 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition-colors"
                                  >
                                    â• æ·»åŠ æ–‡ç»
                                  </button>
                                  
                                </div>
                              </div>
                            )}
                            
                            <div className="text-sm text-slate-300">
                              <span className="text-slate-400">ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥æ‰‹å‹•ç·¨è¼¯é—œéµå­—æˆ–ä½¿ç”¨AIè‡ªå‹•ç”Ÿæˆ</span>
                            </div>
                          </div>

                          {/* æœå°‹çµæœ */}
                          {searchResults.length > 0 && (
                            <div className="mt-4">
                              <h4 className="text-md font-semibold text-white mb-2">ğŸ“š æœå°‹çµæœ - è«‹é¸æ“‡è¦æ·»åŠ çš„æ–‡ç»</h4>
                              
                              {/* æ˜¾ç¤ºåº”ç”¨çš„è®¾ç½® */}
                              <div className="mb-3 p-2 bg-slate-800 rounded border border-slate-600">
                                <div className="text-xs text-slate-300">
                                  <span className="text-blue-400">ğŸ”§ åº”ç”¨è®¾ç½®:</span>
                                  <span className="ml-2">åœ°åŒº: {form.referenceSettings.region === 'north-america' ? 'ğŸ‡ºğŸ‡¸ åŒ—ç¾' : 
                                    form.referenceSettings.region === 'china' ? 'ğŸ‡¨ğŸ‡³ ä¸­å›½' :
                                    form.referenceSettings.region === 'europe' ? 'ğŸ‡ªğŸ‡º æ¬§æ´²' :
                                    form.referenceSettings.region === 'asia' ? 'ğŸŒ äºšæ´²' : 'ğŸŒ å…¨çƒ'}</span>
                                  <span className="ml-2">|</span>
                                  <span className="ml-2">è¯­è¨€: English</span>
                                  <span className="ml-2">|</span>
                                  <span className="ml-2">å¹´ä»½: {form.referenceSettings.yearRange.from}-{form.referenceSettings.yearRange.to}</span>
                                </div>
                              </div>
                              <div className="space-y-4">
                                {searchResults.slice(0, 3).map((ref, index) => {
                                  // ç°åœ¨å®Œå…¨ä½¿ç”¨AIç”Ÿæˆçš„åˆ†æï¼Œä¸å†ä½¿ç”¨å…¬å¼åŒ–æ¨¡æ¿
                                  const apa7Citation = generateAPA7Citation(ref);
                                  
                                  return (
                                    <div key={ref.id} className="bg-slate-700 rounded-lg border border-slate-500 overflow-hidden">
                                      {/* æ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯ */}
                                      <div className="p-3 border-b border-slate-600">
                                        {/* éªŒè¯çŠ¶æ€å¾½ç«  */}
                                        <div className="mb-2">
                                          {ref.deepAnalysis?.metadata?.verified || ref.deepAnalysis?.metadata?.has_abstract || (ref.deepAnalysis?.metadata?.abstract_length >= 100) ? (
                                            <span className="inline-flex items-center px-2 py-1 bg-green-900 text-green-300 text-xs rounded">
                                              âœ… å·²éªŒè¯ - æ¥æº: {ref.deepAnalysis.source}
                                            </span>
                                          ) : (
                                            <span className="inline-flex items-center px-2 py-1 bg-yellow-900 text-yellow-300 text-xs rounded">
                                              âš ï¸ æœªéªŒè¯ - ä»…æœ‰å…ƒæ•°æ®
                                            </span>
                                          )}
                                          {ref.deepAnalysis?.metadata?.abstract_length > 0 && (
                                            <span className="ml-2 text-xs text-slate-400">
                                              æ‘˜è¦é•¿åº¦: {ref.deepAnalysis.metadata.abstract_length}å­—ç¬¦
                                            </span>
                                          )}
                                          {ref.deepAnalysis?.metadata?.body_length > 0 && (
                                            <span className="ml-2 text-xs text-slate-400">
                                              æ­£æ–‡: {ref.deepAnalysis.metadata.body_length}å­—ç¬¦
                                            </span>
                                          )}
                                        </div>
                                        
                                        <h5 className="font-semibold text-white text-sm leading-tight mb-1">{ref.title}</h5>
                                        <div className="text-xs text-slate-400 mb-2">
                                          {ref.authors} â€¢ {ref.source} â€¢ {ref.year}
                                        </div>
                                        
                                        {/* è¯¦ç»†ä¸­æ–‡æ¦‚è¿° */}
                                        <div className="mb-3">
                                          {ref.deepAnalysis?.chineseExplanation ? (
                                            // åŸºäºä¸“ä¸šå…ƒæ•°æ®çš„æ˜¾ç¤º - æœ‰AIç”Ÿæˆçš„ä¸­æ–‡æ¦‚è¿°
                                            <>
                                              <span className="text-blue-300 text-sm font-medium">
                                                {ref.deepAnalysis.metadata?.summary_mode === "AI_from_abstract" 
                                                  ? "ğŸ“– ä¸­æ–‡æ¦‚è¿°ï¼ˆåŸºæ–¼çœŸå¯¦è‹±æ–‡æ‘˜è¦ï¼‰" 
                                                  : "ğŸ“– ä¸­æ–‡æ¦‚è¿°"}
                                              </span>
                                              <p className="text-slate-200 text-sm leading-relaxed mt-2">
                                                {ref.deepAnalysis.chineseExplanation}
                                              </p>
                                              {ref.deepAnalysis.metadata && (
                                                <div className="mt-2 text-xs text-green-400">
                                                  âœ… åŸºäºä¸“ä¸šå…ƒæ•°æ®æ™ºèƒ½åˆ†æ ({ref.deepAnalysis.source})
                                                  <div className="text-xs text-slate-400 mt-1">
                                                    å…ƒæ•°æ®æ¥æº: {ref.deepAnalysis.metadata.abstract_source || 'metadata'} | 
                                                    æ¨¡å¼: {ref.deepAnalysis.metadata.summary_mode}
                                                  </div>
                                                </div>
                                              )}
                                            </>
                                          ) : (
                                            // å¤‡ç”¨æ˜¾ç¤ºæ–¹å¼ï¼ˆæ— AIåˆ†ææ—¶ï¼‰
                                            // æ³¨æ„ï¼šç°åœ¨ä¼šè‡ªåŠ¨ç¿»è¯‘åŸå§‹æ‘˜è¦ï¼Œæ‰€ä»¥è¿™é‡Œåº”è¯¥å¾ˆå°‘æ˜¾ç¤º
                                            <>
                                              <span className="text-blue-300 text-sm font-medium">ğŸ“– ä¸­æ–‡æ¦‚è¿°</span>
                                              <p className="text-slate-200 text-sm leading-relaxed mt-2">
                                                <span className="text-yellow-300">ï¼ˆæ³¨æ„ï¼šæ‘˜è¦æ­£åœ¨å¤„ç†ä¸­...ï¼‰</span>
                                              </p>
                                            </>
                                          )}
                                        </div>
                                        
                                        
                                        {/* APA7å¼•ç”¨æ ¼å¼ */}
                                        <div className="mb-3">
                                          <span className="text-purple-300 text-sm font-medium">ğŸ“š APA7 å¼•ç”¨æ ¼å¼</span>
                                          <div className="bg-slate-800 p-3 rounded text-slate-200 text-sm font-mono mt-2 leading-relaxed">
                                            {apa7Citation}
                                          </div>
                                        </div>
                                        
                                        {/* æ“ä½œæŒ‰é’® */}
                                      <div className="flex space-x-2 flex-wrap">
                                        <button
                                          onClick={async () => {
                                            // Fail-Closedå®ˆé—¨æœºåˆ¶ï¼šæ£€æŸ¥æ–‡çŒ®æ˜¯å¦å·²éªŒè¯
                                            const isVerified = ref.deepAnalysis?.metadata?.verified || 
                                                             ref.deepAnalysis?.metadata?.has_abstract || 
                                                             ref.deepAnalysis?.metadata?.abstract_length >= 100;
                                            
                                            if (!isVerified) {
                                              alert(`âš ï¸ æ¥æºæœªéªŒè¯ï¼šæ­¤æ–‡çŒ®æœªåŒ…å«å®Œæ•´æ‘˜è¦æˆ–æ­£æ–‡ï¼Œæ— æ³•æ·»åŠ åˆ°è‰ç¨¿ã€‚\n\nè¯·é€‰æ‹©å·²éªŒè¯ï¼ˆâœ…ï¼‰çš„æ–‡çŒ®ï¼Œæˆ–ç‚¹å‡»"é‡è¯•æŠ“å–"è·å–å®Œæ•´å†…å®¹ã€‚`);
                                              return;
                                            }
                                            
                                            await addReferenceToPoint(point.id, ref);
                                            alert(`âœ… å·²æ·»åŠ åˆ°å¤§ç¶±é» ${point.id}: ${ref.title}`);
                                          }}
                                          disabled={!(ref.deepAnalysis?.metadata?.verified || ref.deepAnalysis?.metadata?.has_abstract || (ref.deepAnalysis?.metadata?.abstract_length >= 100))}
                                          className={`px-3 py-1 text-white text-xs rounded transition-colors ${
                                            (ref.deepAnalysis?.metadata?.verified || ref.deepAnalysis?.metadata?.has_abstract || (ref.deepAnalysis?.metadata?.abstract_length >= 100))
                                              ? 'bg-green-600 hover:bg-green-700 cursor-pointer'
                                              : 'bg-gray-500 cursor-not-allowed opacity-50'
                                          }`}
                                        >
                                          â• æ·»åŠ 
                                        </button>
                                        {ref.url && (
                                          <>
                                          <button
                                            onClick={() => window.open(ref.url, '_blank')}
                                                className="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors"
                                          >
                                            ğŸ”— è¨ªå•
                                          </button>
                                            {/* é‡è¯•æŠ“å–æŒ‰é’® - ä»…åœ¨æœªéªŒè¯æ—¶æ˜¾ç¤º */}
                                            {!(ref.deepAnalysis?.metadata?.verified || ref.deepAnalysis?.metadata?.has_abstract || (ref.deepAnalysis?.metadata?.abstract_length >= 100)) && (
                                        <button
                                                onClick={async () => {
                                                  try {
                                                    // é‡æ–°æŠ“å–æ‘˜è¦
                                                    const response = await fetch('/api/abstract', {
                                                      method: 'POST',
                                                      headers: {
                                                        'Content-Type': 'application/json',
                                                      },
                                                      body: JSON.stringify({
                                                        url: ref.url,
                                                        title: ref.title
                                                      }),
                                                    });
                                                    
                                                    if (response.ok) {
                                                      const data = await response.json();
                                                      if (data.verified) {
                                                        alert(`âœ… é‡è¯•æˆåŠŸï¼å·²è·å–æ‘˜è¦ï¼ˆ${data.abstract_length}å­—ç¬¦ï¼‰`);
                                                        // é‡æ–°æœç´¢ä»¥æ›´æ–°ç»“æœ
                                                        const activeKey = selectedBulletPoint || point.id.toString();
                                                        await handleSearchReferences(searchKeywords[activeKey] || '', point.id, false);
                                                } else {
                                                        alert(`âš ï¸ é‡è¯•å¤±è´¥ï¼šä»ç„¶æ— æ³•è·å–å®Œæ•´æ‘˜è¦æˆ–æ­£æ–‡`);
                                                      }
                                                }
                                              } catch (error) {
                                                    alert(`é‡è¯•å¤±è´¥: ${error}`);
                                                  }
                                                }}
                                                className="px-3 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700 transition-colors"
                                              >
                                                ğŸ”„ é‡è¯•æŠ“å–
                                        </button>
                                            )}
                                          </>
                                        )}
                                        
                                        {/* è‡ªåŠ¨è·å–å…¨æ–‡æŒ‰é’® */}
                                        <button
                                          onClick={async () => {
                                            try {
                                              console.log('å¼€å§‹è‡ªåŠ¨è·å–å…¨æ–‡...');
                                              const response = await fetch('/api/download-fulltext', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                  doi: ref.url?.match(/doi\.org\/([^\s]+)/)?.[1],
                                                  title: ref.title,
                                                  url: ref.url,
                                                  referenceId: ref.id,
                                                  authors: ref.authors
                                                }),
                                              });
                                              
                                              const data = await response.json();
                                              console.log('è·å–å…¨æ–‡å“åº”:', data);
                                              
                                              if (data.success && data.pdfUrl) {
                                                // æ‰“å¼€æ–°çª—å£ä¸‹è½½PDF
                                                window.open(data.pdfUrl, '_blank');
                                                
                                                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                                                if (data.saved && data.file) {
                                                  alert(`âœ… æ‰¾åˆ°å¼€æ”¾è·å–ç‰ˆæœ¬ï¼\n\næ¥æº: ${data.source}\næ–‡ä»¶å¤§å°: ${(data.file.size / 1024 / 1024).toFixed(2)}MB\n\nâœ… å·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°æ–‡çŒ®åº“\næ–‡ä»¶å: ${data.file.name}\n\næ‚¨å¯ä»¥åœ¨åˆ›ä½œåˆç¨¿æ—¶ç›´æ¥è°ƒç”¨æ­¤æ–‡çŒ®å†…å®¹`);
                                                  
                                                  // è‡ªåŠ¨æ›´æ–°å‚è€ƒæ–‡çŒ®çš„PDFä¿¡æ¯
                                                  setOutlinePoints(prev => prev.map(point => ({
                                                    ...point,
                                                    references: point.references.map(r => 
                                                      r.id === ref.id 
                                                        ? { ...r, fileUrl: data.file.url, fileName: data.file.name, fileSize: data.file.size }
                                                        : r
                                                    )
                                                  })));
                                            } else {
                                                  alert(`âœ… æ‰¾åˆ°å¼€æ”¾è·å–ç‰ˆæœ¬ï¼\n\næ¥æº: ${data.source}\n\næ­£åœ¨æ‰“å¼€ä¸‹è½½é“¾æ¥...`);
                                                }
                                              } else {
                                                alert(`âŒ ${data.message}\n\nå»ºè®®ï¼š\n${data.suggestions?.join('\n') || 'è¯·å°è¯•æ‰‹åŠ¨ä¸Šä¼ PDF'}`);
                                              }
                                            } catch (error) {
                                              console.error('è·å–å…¨æ–‡å¤±è´¥:', error);
                                              alert(`è·å–å…¨æ–‡å¤±è´¥: ${error}`);
                                            }
                                          }}
                                          className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                        >
                                          ğŸ“¥ è‡ªåŠ¨è·å–å…¨æ–‡
                                        </button>
                                        
                                        {/* æ‰‹åŠ¨ä¸Šä¼ æŒ‰é’® */}
                                        <button
                                          onClick={() => {
                                            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
                                            const fileInput = document.createElement('input');
                                            fileInput.type = 'file';
                                            fileInput.accept = '.pdf';
                                            fileInput.onchange = async (e: any) => {
                                              const file = e.target.files[0];
                                              if (!file) return;
                                              
                                              // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                                              if (!file.type.includes('pdf')) {
                                                alert('âŒ åªæ”¯æŒPDFæ–‡ä»¶æ ¼å¼');
                                                return;
                                              }
                                              
                                              // æ£€æŸ¥æ–‡ä»¶å¤§å° (50MB)
                                              if (file.size > 50 * 1024 * 1024) {
                                                alert('âŒ æ–‡ä»¶å¤§å°è¶…è¿‡50MBé™åˆ¶');
                                                return;
                                              }
                                              
                                              // ä¸Šä¼ æ–‡ä»¶
                                              const formData = new FormData();
                                              formData.append('pdf', file);
                                              formData.append('referenceId', ref.id);
                                              formData.append('title', ref.title);
                                              formData.append('authors', ref.authors);
                                              
                                              try {
                                                const response = await fetch('/api/upload-fulltext', {
                                                  method: 'POST',
                                                  body: formData,
                                                });
                                                
                                                const data = await response.json();
                                                
                                                if (data.success) {
                                                  alert(`âœ… PDFä¸Šä¼ æˆåŠŸï¼\n\næ–‡ä»¶: ${data.file.name}\nå¤§å°: ${(data.file.size / 1024 / 1024).toFixed(2)}MB\n\nå·²ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“`);
                                                  
                                                  // è‡ªåŠ¨æ›´æ–°å‚è€ƒæ–‡çŒ®çš„PDFä¿¡æ¯
                                                  setOutlinePoints(prev => prev.map(point => ({
                                                    ...point,
                                                    references: point.references.map(r => 
                                                      r.id === ref.id 
                                                        ? { ...r, fileUrl: data.file.url, fileName: data.file.name, fileSize: data.file.size }
                                                        : r
                                                    )
                                                  })));
                                                } else {
                                                  alert(`âŒ ä¸Šä¼ å¤±è´¥: ${data.message}`);
                                                }
                                              } catch (error) {
                                                alert(`ä¸Šä¼ å¤±è´¥: ${error}`);
                                              }
                                            };
                                            fileInput.click();
                                          }}
                                          className="px-3 py-1 bg-teal-600 text-white text-xs rounded hover:bg-teal-700 transition-colors"
                                        >
                                          ğŸ“¤ æ‰‹åŠ¨ä¸Šä¼ 
                                        </button>
                                      </div>
                                    </div>
                                    </div>
                                  );
                                })}
                              </div>
                              
                              <div className="mt-3 p-2 bg-slate-500 rounded text-center">
                                <p className="text-slate-200 text-sm">
                                  ğŸ’¡ å·²æ‰¾åˆ° {Math.min(searchResults.length, 3)} ç¯‡æ–‡ç»ï¼Œè«‹é¸æ“‡é©åˆçš„æ·»åŠ åˆ°ç•¶å‰å¤§ç¶±é»
                                </p>
                              </div>
                            </div>
                          )}

                          {/* æ‰‹å‹•è¼¸å…¥åƒè€ƒæ–‡ç» - å‡ºç¾åœ¨æœå°‹çµæœä¸‹æ–¹ */}
                          <div className="mt-4">
                            <button
                              onClick={() => toggleManualInput(point.id)}
                              className="flex items-center justify-between w-full p-3 bg-slate-700 rounded-lg border border-slate-500 hover:bg-slate-600 transition-colors"
                            >
                              <h4 className="text-md font-semibold text-white">âœï¸ æ‰‹å‹•è¼¸å…¥åƒè€ƒæ–‡ç»</h4>
                              <span className="text-white">
                                {manualInputExpanded[point.id] ? 'â–¼' : 'â–¶'}
                              </span>
                            </button>
                            
                            {manualInputExpanded[point.id] && (
                              <div className="mt-3 p-4 bg-slate-700 rounded-lg border border-slate-500 animate-fadeIn">
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                  <input
                                    type="text"
                                    value={manualReference.title}
                                    onChange={(e) => setManualReference(prev => ({ ...prev, title: e.target.value }))}
                                    placeholder="æ–‡ç»æ¨™é¡Œ"
                                    className="px-3 py-2 bg-slate-600 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400"
                                  />
                                  <input
                                    type="text"
                                    value={manualReference.authors}
                                    onChange={(e) => setManualReference(prev => ({ ...prev, authors: e.target.value }))}
                                    placeholder="ä½œè€…"
                                    className="px-3 py-2 bg-slate-600 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400"
                                  />
                                  <input
                                    type="text"
                                    value={manualReference.source}
                                    onChange={(e) => setManualReference(prev => ({ ...prev, source: e.target.value }))}
                                    placeholder="ä¾†æºæœŸåˆŠ/å‡ºç‰ˆç¤¾"
                                    className="px-3 py-2 bg-slate-600 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400"
                                  />
                                  <input
                                    type="number"
                                    value={manualReference.year || ''}
                                    onChange={(e) => setManualReference(prev => ({ ...prev, year: parseInt(e.target.value) || 0 }))}
                                    placeholder="å‡ºç‰ˆå¹´ä»½"
                                    className="px-3 py-2 bg-slate-600 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400"
                                  />
                                </div>
                                <textarea
                                  value={manualReference.summary}
                                  onChange={(e) => setManualReference(prev => ({ ...prev, summary: e.target.value }))}
                                  placeholder="æ–‡ç»æ‘˜è¦"
                                  className="w-full px-3 py-2 bg-slate-600 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400 mb-3"
                                  rows={3}
                                />
                                <div className="flex space-x-3 mb-3">
                                  <input
                                    type="text"
                                    value={manualReference.citation}
                                    onChange={(e) => setManualReference(prev => ({ ...prev, citation: e.target.value }))}
                                    placeholder="å¼•ç”¨æ ¼å¼ (APAæ ¼å¼)"
                                    className="flex-1 px-3 py-2 bg-slate-600 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400"
                                  />
                                  <button
                                    onClick={() => addManualReference(point.id)}
                                    className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                                  >
                                    æ·»åŠ åˆ°å¤§ç¶±é»
                                  </button>
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}


                    {/* é¡¯ç¤ºåˆ†æ®µå¤§ç¶±å…§å®¹ */}
                    {generatedContent ? (
                      <div className="space-y-4">
                        {/* è§£æä¸¦é¡¯ç¤ºåˆ†æ®µå…§å®¹ */}
                        {(() => {
                          // è§£æå¤§ç¶±å…§å®¹ï¼Œåˆ†æˆä¸åŒæ®µè½
                          const sections = generatedContent.split(/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/).filter(section => section.trim());
                          const sectionTitles = generatedContent.match(/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€[^-\n]+/g) || [];
                          
                          return sectionTitles.map((title, index) => {
                            const cleanTitle = title.replace(/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/, '').trim();
                            const sectionContent = sections[index] || '';
                            
                            return (
                              <div key={index} className="p-4 bg-slate-700 rounded-lg border border-slate-600">
                                <div className="flex items-center justify-between mb-3">
                                  <h4 className="text-lg font-medium text-white">
                                    {index === 0 ? 'ä¸€ã€å¼•è¨€ï¼ˆç´„ 140 å­—ï¼‰' : 
                                     index === 1 ? 'äºŒã€ä¸»é«”æ®µä¸€ï¼ˆç´„ 360 å­—ï¼‰' : 
                                     index === 2 ? 'ä¸‰ã€ä¸»é«”æ®µäºŒï¼ˆç´„ 360 å­—ï¼‰' : 
                                     index === 3 ? 'å››ã€çµè«–ï¼ˆç´„ 140 å­—ï¼‰' : 
                                     `${index + 1}ã€${cleanTitle}`}
                                  </h4>
                                  <div className="flex gap-2">
                                    <button
                                      onClick={() => {
                                        const newContent = prompt('ç·¨è¼¯æ®µè½å…§å®¹:', sectionContent);
                                        if (newContent !== null) {
                                          // æ›´æ–°å°æ‡‰æ®µè½çš„å…§å®¹
                                          const newSections = [...sections];
                                          newSections[index] = newContent;
                                          const newFullContent = sectionTitles.map((title, i) => 
                                            `${title}\n${newSections[i] || ''}`
                                          ).join('\n\n');
                                          setGeneratedContent(newFullContent);
                                        }
                                      }}
                                      className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                    >
                                      âœï¸ ç·¨è¼¯
                                    </button>
                                    <button
                                      onClick={() => {
                                        if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ®µè½å—ï¼Ÿ')) {
                                          // ç§»é™¤å°æ‡‰æ®µè½
                                          const newSections = sections.filter((_, i) => i !== index);
                                          const newTitles = sectionTitles.filter((_, i) => i !== index);
                                          const newFullContent = newTitles.map((title, i) => 
                                            `${title}\n${newSections[i] || ''}`
                                          ).join('\n\n');
                                          setGeneratedContent(newFullContent);
                                        }
                                      }}
                                      className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors"
                                    >
                                      ğŸ—‘ï¸ åˆªé™¤
                                    </button>
                                  </div>
                                </div>
                                {/* è§£æä¸¦é¡¯ç¤ºå­å½ˆé» */}
                                {(() => {
                                  // è§£ææ®µè½å…§å®¹ï¼Œæå–å­å½ˆé»ï¼ˆä»¥ - é–‹é ­çš„å®Œæ•´æ®µè½ï¼‰
                                  const lines = sectionContent.split('\n');
                                  const bulletPoints = [];
                                  const regularContent = [];
                                  
                                  let currentBullet = '';
                                  for (let i = 0; i < lines.length; i++) {
                                    const line = lines[i].trim();
                                    if (line.startsWith('-')) {
                                      // å¦‚æœå·²ç¶“æœ‰å­å½ˆé»åœ¨ç´¯ç©ï¼Œå…ˆä¿å­˜
                                      if (currentBullet) {
                                        bulletPoints.push(currentBullet);
                                      }
                                      currentBullet = line;
                                    } else if (line && currentBullet) {
                                      // å¦‚æœé€™è¡Œä¸æ˜¯ä»¥ - é–‹é ­ä½†æœ‰å…§å®¹ï¼Œä¸”æ­£åœ¨ç´¯ç©å­å½ˆé»ï¼Œå‰‡åŠ å…¥ç•¶å‰å­å½ˆé»
                                      currentBullet += '\n' + line;
                                    } else if (line && !currentBullet) {
                                      // å¦‚æœé€™è¡Œæœ‰å…§å®¹ä½†ä¸åœ¨å­å½ˆé»ä¸­ï¼ŒåŠ å…¥å¸¸è¦å…§å®¹
                                      regularContent.push(line);
                                    }
                                  }
                                  
                                  // ä¿å­˜æœ€å¾Œä¸€å€‹å­å½ˆé»
                                  if (currentBullet) {
                                    bulletPoints.push(currentBullet);
                                  }
                                  
                                  return (
                                    <div className="space-y-3">
                                      {/* ä¸»é¡Œå¥è¼¸å…¥æ¡† */}
                                      <div className="space-y-2">
                                        <label className="text-sm font-medium text-white">ğŸ“ ä¸»é¡Œå¥ï¼š</label>
                                        <textarea
                                          value={regularContent.join('\n')}
                                          onChange={(e) => {
                                            const newSections = [...sections];
                                            newSections[index] = e.target.value + '\n' + bulletPoints.join('\n');
                                            const newFullContent = sectionTitles.map((title, i) => 
                                              `${title}\n${newSections[i] || ''}`
                                            ).join('\n\n');
                                            setGeneratedContent(newFullContent);
                                          }}
                                          placeholder="è«‹è¼¸å…¥ä¸»é¡Œå¥..."
                                          className="w-full h-16 p-2 border rounded-lg resize-none bg-slate-800 text-white border-slate-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-sm"
                                        />
                                      </div>
                                      
                                      {/* å­å½ˆé»åˆ—è¡¨ */}
                                      {bulletPoints.map((bullet, bulletIndex) => (
                                        <div key={bulletIndex} className="flex items-start gap-2">
                                          <textarea
                                            value={bullet}
                                            onChange={(e) => {
                                              const newBulletPoints = [...bulletPoints];
                                              newBulletPoints[bulletIndex] = e.target.value;
                                              const newSections = [...sections];
                                              newSections[index] = regularContent.join('\n') + '\n' + newBulletPoints.join('\n');
                                              const newFullContent = sectionTitles.map((title, i) => 
                                                `${title}\n${newSections[i] || ''}`
                                              ).join('\n\n');
                                              setGeneratedContent(newFullContent);
                                            }}
                                            placeholder="å­å½ˆé»å…§å®¹..."
                                            className="flex-1 h-16 p-2 border rounded-lg resize-none bg-slate-800 text-white border-slate-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-sm"
                                          />
                                          <button
                                            onClick={() => {
                                              const newBulletPoints = bulletPoints.filter((_, i) => i !== bulletIndex);
                                              const newSections = [...sections];
                                              newSections[index] = regularContent.join('\n') + '\n' + newBulletPoints.join('\n');
                                              const newFullContent = sectionTitles.map((title, i) => 
                                                `${title}\n${newSections[i] || ''}`
                                              ).join('\n\n');
                                              setGeneratedContent(newFullContent);
                                            }}
                                            className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors mt-1"
                                          >
                                            ğŸ—‘ï¸
                                          </button>
                                        </div>
                                      ))}
                                      
                                      {/* æ·»åŠ å­å½ˆé»æŒ‰éˆ• */}
                                      <button
                                        onClick={() => {
                                          const newBulletPoints = [...bulletPoints, '- æ–°çš„å­å½ˆé»'];
                                          const newSections = [...sections];
                                          newSections[index] = regularContent.join('\n') + '\n' + newBulletPoints.join('\n');
                                          const newFullContent = sectionTitles.map((title, i) => 
                                            `${title}\n${newSections[i] || ''}`
                                          ).join('\n\n');
                                          setGeneratedContent(newFullContent);
                                        }}
                                        className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors flex items-center gap-1"
                                      >
                                        â• æ·»åŠ å­å½ˆé»
                                      </button>
                                    </div>
                                  );
                                })()}
                              </div>
                            );
                          });
                        })()}
                        
                      </div>
                    )}

                    {/* é¡¯ç¤ºå¤§ç¶±é» */}
                    {outlinePoints.map((point) => (
                      <div key={point.id} className="p-4 bg-slate-700 rounded-lg border border-slate-600">
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="text-lg font-medium text-white">{point.id}. {point.title}</h4>
                          <div className="flex gap-2">
                            <button
                              onClick={() => {
                                const newBulletPoint = 'æ–°çš„è¯¦ç»†è¦ç‚¹';
                                setOutlinePoints(prev => prev.map(p => 
                                  p.id === point.id 
                                    ? { ...p, bulletPoints: [...p.bulletPoints, newBulletPoint] }
                                    : p
                                ));
                              }}
                              className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                            >
                              â• æ·»åŠ è¦ç‚¹
                            </button>
                            <button
                              onClick={() => {
                                if (confirm(`ç¡®å®šè¦åˆ é™¤å¤§çº²ç‚¹ "${point.title}" å—ï¼Ÿ`)) {
                                  setOutlinePoints(prev => prev.filter(p => p.id !== point.id));
                                }
                              }}
                              className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors"
                            >
                              ğŸ—‘ï¸ åˆ é™¤
                            </button>
                          </div>
                        </div>
                        
                        <textarea
                          value={point.content}
                          onChange={(e) => {
                            setOutlinePoints(prev => prev.map(p => 
                              p.id === point.id ? { ...p, content: e.target.value } : p
                            ));
                          }}
                          className="w-full mt-2 px-3 py-2 bg-slate-600 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400"
                          rows={3}
                          placeholder="åœ¨é€™è£¡ç·¨è¼¯å¤§ç¶±é»å…§å®¹..."
                        />
                        
                        {/* è©³ç´°çš„bullet points */}
                        <div className="mt-3 p-3 bg-slate-600 rounded border border-slate-500">
                          <h5 className="text-sm font-medium text-slate-300 mb-2">ğŸ“ è©³ç´°è¦é»</h5>
                          {point.bulletPoints.map((bullet, idx) => (
                            <div key={idx} className="flex items-center gap-2 mb-2">
                              <span className="text-slate-400">â€¢</span>
                              <textarea
                                value={bullet}
                                onChange={(e) => {
                                  const newBulletPoints = [...point.bulletPoints];
                                  newBulletPoints[idx] = e.target.value;
                                  setOutlinePoints(prev => prev.map(p => 
                                    p.id === point.id ? { ...p, bulletPoints: newBulletPoints } : p
                                  ));
                                }}
                                className="flex-1 px-2 py-1 bg-slate-700 border border-slate-500 rounded text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400 text-xs"
                                rows={1}
                                placeholder="ç·¨è¼¯è©³ç´°è¦é»..."
                              />
                              <button
                                onClick={() => {
                                  const newBulletPoints = point.bulletPoints.filter((_, i) => i !== idx);
                                  setOutlinePoints(prev => prev.map(p => 
                                    p.id === point.id ? { ...p, bulletPoints: newBulletPoints } : p
                                  ));
                                }}
                                className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors"
                                title="åˆ é™¤æ­¤è¦ç‚¹"
                              >
                                âœ•
                              </button>
                            </div>
                          ))}
                          
                          <div className="mt-3 pt-2 border-t border-slate-500">
                            <button
                              onClick={() => {
                                const newBulletPoint = 'æ–°çš„è¯¦ç»†è¦ç‚¹';
                                setOutlinePoints(prev => prev.map(p => 
                                  p.id === point.id 
                                    ? { ...p, bulletPoints: [...p.bulletPoints, newBulletPoint] }
                                    : p
                                ));
                              }}
                              className="flex items-center px-3 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors"
                            >
                              <span className="mr-2">â•</span>
                              æ·»åŠ è¯¦ç»†è¦ç‚¹
                            </button>
                          </div>
                        </div>
                        
                        <div className="mt-2 text-xs text-slate-400">
                          å­—æ•¸ï¼š{point.wordCount}å­—
                        </div>
                      </div>
                    ))}
                    
                  </div>
                </div>
              )}

              {/* æ–‡ç»æœå°‹æ¨¡å¼ä¸‹çš„å®Œæ•´å¤§ç¶±é¡¯ç¤º */}
              {activeTab === 'outline' && mode === 'search' && (
                <div className="mb-4">
                  <div className="p-4 bg-slate-700 rounded-lg border border-slate-600">
                    <h3 className="text-lg font-semibold text-white mb-3">ğŸ“‹ å®Œæ•´å¤§ç¶±èˆ‡åƒè€ƒæ–‡ç»</h3>
                    <div className="space-y-4">
                      {outlinePoints.map((point) => (
                        <div key={point.id} className="p-3 bg-slate-600 rounded border border-slate-500">
                          <h4 className="text-md font-medium text-white">{point.id}. {point.title}</h4>
                          <p className="text-slate-300 text-sm mt-1">{point.content}</p>
                          <p className="text-slate-400 text-xs mt-1">å­—æ•¸ï¼š{point.wordCount}å­—</p>
                          
                          {point.references.length > 0 && (
                            <div className="mt-2 p-2 bg-slate-700 rounded border border-slate-500">
                              <h5 className="text-sm font-medium text-slate-300 mb-1">ğŸ“š åƒè€ƒæ–‡ç» ({point.references.length})</h5>
                              <div className="space-y-1">
                                {point.references.map((ref) => (
                                  <div key={ref.id} className="text-xs text-slate-400">
                                    â€¢ {ref.citation}
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* åˆç¨¿æ¨™ç±¤çš„å…§å®¹ç·¨è¼¯å€ */}
              {activeTab === 'draft' && (
                <div className="mb-4">
                  {/* åˆç¨¿ç”Ÿæˆæ§åˆ¶é¢æ¿ */}
                  <div className="mb-4 p-4 bg-slate-700 rounded-lg border border-slate-600">
                    <div className="flex items-center justify-between mb-3">
                      <h3 className="text-lg font-semibold text-white">ğŸ“ åˆç¨¿ç”Ÿæˆ</h3>
                      <div className="flex gap-2">
                        <button 
                          onClick={() => handleGenerateDraft('full')}
                          disabled={isGenerating}
                          className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors disabled:opacity-50"
                        >
                          {isGenerating ? 'ç”Ÿæˆä¸­...' : 'âœï¸ ç”Ÿæˆå®Œæ•´åˆç¨¿'}
                        </button>
                      </div>
                    </div>
                    
                    {/* AIæ¨¡å‹é€‰æ‹© */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-white mb-2">ğŸ¤– é€‰æ‹©AIæ¨¡å‹</label>
                      <select
                        value={selectedModel}
                        onChange={(e) => setSelectedModel(e.target.value)}
                        disabled={isGenerating}
                        className="w-full px-3 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm focus:border-blue-400 focus:ring-blue-400"
                      >
                        <option value="gpt-4o">GPT-4o (æ¨è - æ€§ä»·æ¯”æœ€é«˜)</option>
                        <option value="claude-3.5">Claude 3.5 Sonnet (é¡¶çº§è´¨é‡)</option>
                        <option value="gpt-4">GPT-4 Turbo (é«˜è´¨é‡é•¿æ–‡æœ¬)</option>
                        <option value="deepseek-r1">DeepSeek R1 (æ·±åº¦æ¨ç†)</option>
                        <option value="llama-405b">Llama 3.1 405B (å¼€æºé«˜è´¨é‡)</option>
                        <option value="gemini-flash">Gemini 2.5 Flash (å¿«é€Ÿç»æµ)</option>
                        <option value="gpt-3.5">GPT-3.5 Turbo (æœ€ç»æµ)</option>
                      </select>
                      <p className="text-xs text-slate-400 mt-1">
                        æ¨èä½¿ç”¨GPT-4oæˆ–Claude 3.5ä»¥è·å¾—æ›´å¥½çš„é•¿æ–‡æœ¬ç”Ÿæˆè´¨é‡ã€‚å­—æ•°ä¸è¶³ä¼šè‡ªåŠ¨ç»­å†™è¡¥é½ã€‚
                      </p>
                    </div>

                  </div>

                  {/* æ ¹æ®å¤§çº²ç»“æ„æ˜¾ç¤ºä¸åŒçš„éƒ¨åˆ† */}
                  <div className="space-y-4">
                    {outlinePoints.map((point) => (
                      <div key={point.id} className="p-4 bg-slate-700 rounded-lg border border-slate-600">
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="text-lg font-medium text-white">{point.id}. {point.title}</h4>
                          <div className="flex gap-2">
                            <button 
                              onClick={() => handleGenerateDraft('section', point.id)}
                              disabled={isGenerating}
                              className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors disabled:opacity-50"
                            >
                              {isGenerating && currentGeneratingSection === point.id ? 'ç”Ÿæˆä¸­...' : 'ğŸ”„ é‡æ–°ç”Ÿæˆ'}
                            </button>
                          </div>
                        </div>
                        
                        {/* æ˜¾ç¤ºç”Ÿæˆçš„æ®µè½å†…å®¹ */}
                        {draftSections[point.id] && (
                          <div className="mb-3 p-3 bg-slate-800 rounded border border-slate-500">
                            <h5 className="text-sm font-medium text-green-300 mb-2">âœ¨ å·²ç”Ÿæˆå†…å®¹</h5>
                            <div className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">
                              {draftSections[point.id]}
                            </div>
                            <div className="mt-2 flex gap-2">
                              <button
                                onClick={() => {
                                  const newContent = prompt('ç¼–è¾‘ç”Ÿæˆçš„å†…å®¹:', draftSections[point.id]);
                                  if (newContent !== null) {
                                    setDraftSections(prev => ({
                                      ...prev,
                                      [point.id]: newContent
                                    }));
                                  }
                                }}
                                className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                              >
                                âœï¸ ç¼–è¾‘
                              </button>
                              <button
                                onClick={() => {
                                  setDraftSections(prev => {
                                    const newSections = { ...prev };
                                    delete newSections[point.id];
                                    return newSections;
                                  });
                                }}
                                className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors"
                              >
                                ğŸ—‘ï¸ åˆ é™¤
                              </button>
                            </div>
                          </div>
                        )}
                        
                        {/* ç”ŸæˆçŠ¶æ€æŒ‡ç¤ºå™¨ */}
                        {currentGeneratingSection === point.id && (
                          <div className="p-2 bg-blue-900 rounded border border-blue-500">
                            <div className="flex items-center text-blue-300 text-sm">
                              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-300 mr-2"></div>
                              æ­£åœ¨ç”Ÿæˆç¬¬{point.id}æ®µå†…å®¹...
                            </div>
                          </div>
                        )}
                        
                        {/* å¦‚æœæ²¡æœ‰ç”Ÿæˆå†…å®¹ï¼Œæ˜¾ç¤ºå ä½ç¬¦ */}
                        {!draftSections[point.id] && currentGeneratingSection !== point.id && (
                          <div className="p-3 bg-slate-800 rounded border border-slate-500">
                            <p className="text-slate-400 text-sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæ­¤æ®µè½å†…å®¹</p>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                  
                  {/* å®Œæ•´åˆç¨¿æ˜¾ç¤ºåŒºåŸŸ */}
                  {generatedContent && (
                    <div className="mt-6 p-4 bg-slate-700 rounded-lg border border-slate-600">
                      <div className="flex items-center justify-between mb-3">
                        <h3 className="text-lg font-semibold text-white">ğŸ“„ å®Œæ•´åˆç¨¿</h3>
                        <div className="flex gap-2">
                          <button
                            onClick={() => {
                              const newContent = prompt('ç¼–è¾‘å®Œæ•´åˆç¨¿:', generatedContent);
                              if (newContent !== null) {
                                setGeneratedContent(newContent);
                              }
                            }}
                            className="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                          >
                            âœï¸ ç¼–è¾‘
                          </button>
                          <button
                            onClick={() => setGeneratedContent('')}
                            className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors"
                          >
                            ğŸ—‘ï¸ åˆ é™¤
                          </button>
                        </div>
                      </div>
                      <textarea
                        value={generatedContent}
                        onChange={(e) => setGeneratedContent(e.target.value)}
                        placeholder="å®Œæ•´åˆç¨¿å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."
                        disabled={isCurrentTabLocked}
                        className={`w-full h-64 p-4 border rounded-lg resize-none ${
                          isCurrentTabLocked 
                            ? 'border-slate-500 bg-slate-800 text-slate-400 cursor-not-allowed' 
                            : 'border-slate-500 bg-slate-600 text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400'
                        }`}
                      />
                    </div>
                  )}
                </div>
              )}

              {/* å…¶ä»–æ¨™ç±¤çš„å…§å®¹ç·¨è¼¯å€ */}
              {activeTab !== 'outline' && activeTab !== 'draft' && (
                <div className="mb-4">
                  <textarea
                    value=""
                    placeholder={
                      activeTab === 'review' ? 'åœ¨é€™è£¡ç·¨è¼¯æ•™å¸«è©•è«–...' :
                      activeTab === 'revision' ? 'åœ¨é€™è£¡ç·¨è¼¯ä¿®è¨‚ç¨¿...' :
                      'åœ¨é€™è£¡ç·¨è¼¯æœ€çµ‚ç‰ˆæœ¬...'
                    }
                    disabled={isCurrentTabLocked}
                    className={`w-full h-96 p-4 border rounded-lg resize-none ${
                      isCurrentTabLocked 
                        ? 'border-slate-500 bg-slate-800 text-slate-400 cursor-not-allowed' 
                        : 'border-slate-500 bg-slate-600 text-white placeholder-slate-400 focus:border-blue-400 focus:ring-blue-400'
                    }`}
                  />
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
